!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SNLibrary",[],t):"object"==typeof exports?exports.SNLibrary=t():e.SNLibrary=t()}(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/dist/",n(n.s=195)}([function(e,t,n){"use strict";e.exports=n(81)},function(e,t,n){"use strict";(function(e){n.d(t,"m",(function(){return S})),n.d(t,"i",(function(){return x})),n.d(t,"t",(function(){return O})),n.d(t,"r",(function(){return P})),n.d(t,"l",(function(){return j})),n.d(t,"D",(function(){return D})),n.d(t,"f",(function(){return C})),n.d(t,"q",(function(){return _})),n.d(t,"o",(function(){return I})),n.d(t,"p",(function(){return R})),n.d(t,"s",(function(){return E})),n.d(t,"n",(function(){return A})),n.d(t,"J",(function(){return M})),n.d(t,"K",(function(){return T})),n.d(t,"w",(function(){return K})),n.d(t,"j",(function(){return F})),n.d(t,"G",(function(){return L})),n.d(t,"B",(function(){return V})),n.d(t,"b",(function(){return N})),n.d(t,"k",(function(){return U})),n.d(t,"c",(function(){return W})),n.d(t,"e",(function(){return B})),n.d(t,"C",(function(){return H})),n.d(t,"d",(function(){return z})),n.d(t,"x",(function(){return q})),n.d(t,"F",(function(){return J})),n.d(t,"H",(function(){return G})),n.d(t,"v",(function(){return $})),n.d(t,"z",(function(){return Q})),n.d(t,"y",(function(){return Y})),n.d(t,"u",(function(){return X})),n.d(t,"a",(function(){return Z})),n.d(t,"h",(function(){return ee})),n.d(t,"A",(function(){return te})),n.d(t,"g",(function(){return ne})),n.d(t,"I",(function(){return re})),n.d(t,"E",(function(){return ae}));var r=n(0),a=n.n(r),o=n(20),i=n.n(o),s=n(18),c=n.n(s),u=n(16),l=n.n(u),f=n(79),p=n.n(f),y=n(80),h=n.n(y),d=n(23),v=n.n(d);function m(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function b(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){m(o,r,a,i,s,"next",e)}function s(e){m(o,r,a,i,s,"throw",e)}i(void 0)}))}}function g(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return w(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return w(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function k(e){return(k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function S(){return"undefined"!=typeof window?window:void 0!==e?e:null}function x(e){return Object.keys(e).map((function(t){return e[t]}))}function O(){return null!==S()&&!(document&&document.documentMode)||/Edge/.test(navigator.userAgent)&&window.crypto&&!!window.crypto.subtle}function P(){return"undefined"!=typeof navigator&&"ReactNative"===navigator.product}function j(e,t,n){return e.find((function(e){return e[t]===n}))}function D(e,t){return c()(e,t)}function C(){for(var e=[],t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var a=0,o=n;a<o.length;a++){var i=o[a];e=e.concat(i)}return e}function _(e){return null!==e&&("function"==typeof e||"object"===k(e))}function I(e){return null!==e&&"function"==typeof e}function R(e){return null==e}function E(e){return"string"==typeof e||e instanceof String}function A(e,t){return e>t?e:t}function M(e,t,n){return h()(e.concat(t),(function(e,t){var r,a=g(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(e[o]!==t[o])return!1}}catch(e){a.e(e)}finally{a.f()}return!0}))}function T(e){return v()(e)}function K(e){return e[e.length-1]}function F(e,t){var n,r=g(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;e.push(a)}}catch(e){r.e(e)}finally{r.f()}}function L(e,t){var n,r=g(t);try{for(r.s();!(n=r.n()).done;){V(e,n.value)}}catch(e){r.e(e)}finally{r.f()}}function V(e,t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}function N(e,t){e.includes(t)||e.push(t)}function U(e,t){i()(e,t)}function W(e,t){return e.filter((function(e){return!t.includes(e)})).concat(t.filter((function(t){return!e.includes(t)})))}function B(e,t){return!(e&&!t||!e&&t)&&(e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():e instanceof String&&t instanceof String?e===t:G(e,t))}function H(e,t){e.splice(t,1)}function z(e,t){var n=e.slice();return H(n,t),n}function q(e){for(var t=[],n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];t.push(e[a])}return t}function J(e){var t,n={},r=g(Object.keys(e).sort());try{for(r.s();!(t=r.n()).done;){var a=t.value;n[a]=e[a]}}catch(e){r.e(e)}finally{r.f()}return Z(n)}function G(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var a=0,o=n;a<o.length;a++){var i=o[a];if(e[i]!==t[i])return!1}return!0}function $(e){for(var t={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n],o=void 0;try{o=JSON.parse(e[a])}catch(t){o=e[a]}t[a]=o}return t}function Q(e,t){if(e){var n,r=g(t);try{for(r.s();!(n=r.n()).done;){delete e[n.value]}}catch(e){r.e(e)}finally{r.f()}}}function Y(e,t){var n,r=Object.assign({},e),a=g(t);try{for(a.s();!(n=a.n()).done;){delete r[n.value]}}catch(e){a.e(e)}finally{a.f()}return r}function X(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map((function(e,t){return 0===t?e.trim().replace(/[\/]*$/g,""):e.trim().replace(/(^[\/]*|[\/]*$)/g,"")})).filter((function(e){return e.length})).join("/")}function Z(e){return e instanceof Date?new Date(e):_(e)?JSON.parse(JSON.stringify(e)):e}function ee(e,t){if(!e||!t)throw"Attempting to deepMerge with null values";return p()(e,t,(function(e,t){if(l()(e))return t})),e}function te(e,t){var n,r={},a=g(t);try{for(a.s();!(n=a.n()).done;){var o=n.value;r[o]=e[o]}}catch(e){a.e(e)}finally{a.f()}return Z(r)}function ne(e){var t,n=g(Object.getOwnPropertyNames(e));try{for(n.s();!(t=n.n()).done;){var r=t.value,a=e[r];a&&"object"===k(a)&&!Object.isFrozen(a)?e[r]=ne(a):e[r]=a}}catch(e){n.e(e)}finally{n.f()}return Object.freeze(e)}function re(e,t){var n=t/4;return e.substring(0,n)}function ae(e){return oe.apply(this,arguments)}function oe(){return(oe=b(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.warn("Sleeping for",t),e.abrupt("return",new Promise((function(e,n){setTimeout((function(){e()}),t)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"e",(function(){return g})),n.d(t,"g",(function(){return w})),n.d(t,"d",(function(){return k})),n.d(t,"f",(function(){return S})),n.d(t,"b",(function(){return x})),n.d(t,"c",(function(){return P})),n.d(t,"a",(function(){return j}));var r=n(28),a=n(3),o=n(9),i=n(1),s=n(5);function c(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var l=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey,s.a.LastSyncBegan,s.a.LastSyncEnd],f=[s.a.Uuid,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.Legacy003AuthHash,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey],p=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Legacy003AuthHash],y=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.WaitingForKey],h=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash],d=[s.a.Uuid,s.a.ContentType,s.a.Content,s.a.UpdatedAt],v=[s.a.Uuid,s.a.Content,s.a.CreatedAt],m=[s.a.Uuid,s.a.Content,s.a.ContentType,s.a.CreatedAt],b=[s.a.Uuid,s.a.ContentType,s.a.UpdatedAt,s.a.Deleted,s.a.Dirty,s.a.LastSyncEnd];function g(e,t){return O(e,l.slice(),void 0,t)}function w(e,t,n,r){var a,o={},i=c(n||t.fields);try{for(i.s();!(a=i.n()).done;){var s=a.value;o[s]=t[s]}}catch(e){i.e(e)}finally{i.f()}if(r)for(var u=0,l=Object.keys(r);u<l.length;u++){var f=l[u];o[f]=r[f]}return x(e,o)}function k(e,t,n){return O(e,function(e){if(e===o.a.FileEncrypted||e===o.a.FileDecrypted||e===o.a.FilePreferEncrypted)return p.slice();if(e===o.a.LocalStoragePreferEncrypted||e===o.a.LocalStorageDecrypted||e===o.a.LocalStorageEncrypted)return y.slice();if(e===o.a.Sync||e===o.a.SyncDecrypted)return h.slice();throw"No payload fields found for intent ".concat(e)}(t),a.a.Constructor,n)}function S(e,t,n){return O(e,function(e){if(e===a.a.FileImport)return p.slice();if(e===a.a.SessionHistory)return d.slice();if(e===a.a.ComponentRetrieved)return v.slice();if(e===a.a.ComponentCreated)return m.slice();if(e===a.a.LocalRetrieved||e===a.a.LocalChanged)return y.slice();if(e===a.a.RemoteRetrieved||e===a.a.ConflictData||e===a.a.ConflictUuid)return h.slice();if(e===a.a.LocalSaved||e===a.a.RemoteSaved)return b.slice();throw"No payload fields found for source ".concat(e)}(t),t,n)}function x(e,t){return O(e,e.fields,e.source,t)}function O(e,t,n,o){var s,u=Object(i.A)(e,t),l=o instanceof r.a?o.fields.slice():Object.keys(o||[]),f=c(l);try{for(f.s();!(s=f.n()).done;){var p=s.value,y=o[p];u[p]=y?Object(i.a)(y):y}}catch(e){f.e(e)}finally{f.f()}var h=Object(i.K)(t.concat(l));return new r.a(u,h,n||a.a.Constructor)}function P(e){return O(e,Object.keys(e))}function j(e,t){return O(e,f.slice(),void 0,t)}},function(e,t,n){"use strict";var r;function a(e){return[r.RemoteRetrieved,r.ComponentRetrieved,r.RemoteActionRetrieved].includes(e)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e[e.RemoteRetrieved=1]="RemoteRetrieved",e[e.RemoteSaved=2]="RemoteSaved",e[e.LocalSaved=3]="LocalSaved",e[e.LocalRetrieved=4]="LocalRetrieved",e[e.LocalChanged=5]="LocalChanged",e[e.ComponentRetrieved=6]="ComponentRetrieved",e[e.DesktopInstalled=7]="DesktopInstalled",e[e.RemoteActionRetrieved=8]="RemoteActionRetrieved",e[e.FileImport=9]="FileImport",e[e.RemoteConflict=10]="RemoteConflict",e[e.ImportConflict=11]="ImportConflict",e[e.SavedOrSaving=12]="SavedOrSaving",e[e.DecryptedTransient=13]="DecryptedTransient",e[e.ConflictUuid=14]="ConflictUuid",e[e.ConflictData=15]="ConflictData",e[e.SessionHistory=16]="SessionHistory",e[e.Constructor=17]="Constructor",e[e.ComponentCreated=18]="ComponentCreated",e[e.PreSyncSave=19]="PreSyncSave"}(r||(r={}))},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return i}));var a,o="org.standardnotes.sn";function i(e){var t;return(r(t={},a.Note,"note"),r(t,a.Tag,"tag"),r(t,a.SmartTag,"smart tag"),r(t,a.ActionsExtension,"action-based extension"),r(t,a.Component,"component"),r(t,a.Editor,"editor"),r(t,a.Theme,"theme"),r(t,a.ServerExtension,"server extension"),r(t,a.Mfa,"two-factor authentication setting"),r(t,a.FilesafeCredentials,"FileSafe credential"),r(t,a.FilesafeFileMetadata,"FileSafe file"),r(t,a.FilesafeIntegration,"FileSafe integration"),t)[e]}!function(e){e.Any="*",e.Item="SF|Item",e.RootKey="SN|RootKey|NoSync",e.ItemsKey="SN|ItemsKey",e.EncryptedStorage="SN|EncryptedStorage",e.Note="Note",e.Tag="Tag",e.SmartTag="SN|SmartTag",e.Component="SN|Component",e.Editor="SN|Editor",e.ActionsExtension="Extension",e.UserPrefs="SN|UserPreferences",e.Privileges="SN|Privileges",e.HistorySession="SN|HistorySession",e.Theme="SN|Theme",e.Mfa="SF|MFA",e.ServerExtension="SF|Extension",e.FilesafeCredentials="SN|FileSafe|Credentials",e.FilesafeFileMetadata="SN|FileSafe|FileMetadata",e.FilesafeIntegration="SN|FileSafe|Integration",e.ExtensionRepo="SN|ExtensionRepo"}(a||(a={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.Uuid="uuid",e.ContentType="content_type",e.ItemsKeyId="items_key_id",e.EncItemKey="enc_item_key",e.Content="content",e.CreatedAt="created_at",e.UpdatedAt="updated_at",e.Deleted="deleted",e.Legacy003AuthHash="auth_hash",e.Legacy003AuthParams="auth_params",e.Dirty="dirty",e.DirtiedDate="dirtiedDate",e.WaitingForKey="waitingForKey",e.ErrorDecrypting="errorDecrypting",e.ErrorDecryptingChanged="errorDecryptingValueChanged",e.LastSyncBegan="lastSyncBegan",e.LastSyncEnd="lastSyncEnd"}(r||(r={}))},function(e,t,n){"use strict";(function(e){n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"e",(function(){return o})),n.d(t,"d",(function(){return v})),n.d(t,"b",(function(){return m}));var r,a,o,i=n(10),s=n(14),c=n(2),u=n(1),l=n(15),f=n(4),p=n(3);function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}!function(e){e[e.UserInteraction=1]="UserInteraction",e[e.Internal=2]="Internal",e[e.NonDirtying=3]="NonDirtying"}(r||(r={})),function(e){e.Pinned="pinned",e.Archived="archived",e.Locked="locked",e.UserModifiedDate="client_updated_at",e.DefaultEditor="defaultEditor",e.MobileRules="mobileRules",e.NotAvailableOnMobile="notAvailableOnMobile",e.MobileActive="mobileActive",e.LastSize="lastSize",e.PrefersPlainEditor="prefersPlainEditor",e.ComponentInstallError="installError"}(a||(a={})),function(e){e[e.KeepEarliest=1]="KeepEarliest"}(o||(o={}));var v=function(){function t(n){var r=this;if(y(this,t),this.protected=!1,this.trashed=!1,this.pinned=!1,this.archived=!1,this.locked=!1,!n.uuid||!n.content_type)throw Error("Cannot create item without both uuid and content_type");if(n.format===i.a.DecryptedBareObject&&(n.enc_item_key||n.items_key_id||n.auth_hash))throw Error("Creating an item from a decrypted payload should not contain enc params");this.payload=n,this.conflictOf=n.safeContent.conflict_of,this.createdAtString=this.created_at&&this.dateToLocalizedString(this.created_at),n.format===i.a.DecryptedBareObject&&(this.updatedAtString=this.dateToLocalizedString(this.userModifiedDate),this.protected=this.payload.safeContent.protected,this.trashed=this.payload.safeContent.trashed,this.pinned=this.getAppDomainValue(a.Pinned),this.archived=this.getAppDomainValue(a.Archived),this.locked=this.getAppDomainValue(a.Locked)),e((function(){Object(u.g)(r)}))}return d(t,[{key:"payloadRepresentation",value:function(e){return Object(c.b)(this.payload,e)}},{key:"hasRelationshipWithItem",value:function(e){var t;return!!(null===(t=this.payload.safeContent.references)||void 0===t?void 0:t.find((function(t){return t.uuid===e.uuid})))}},{key:"getDomainData",value:function(e){var t=this.payload.safeContent.appData;if(t)return t[e]}},{key:"getAppDomainValue",value:function(e){return this.getDomainData(t.DefaultAppDomain())[e]}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["conflict_of"]}},{key:"appDataContentKeysToIgnoreWhenCheckingEquality",value:function(){return[a.UserModifiedDate]}},{key:"getContentCopy",value:function(){return JSON.parse(JSON.stringify(this.content))}},{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?s.a.KeepLeftDuplicateRight:this.isSingleton?s.a.KeepLeft:this.deleted?s.a.KeepRight:e.deleted?this.payload.source===p.a.FileImport?s.a.KeepLeft:s.a.KeepRight:b(this,e)?b(this,e,["references"])?s.a.KeepLeftDuplicateRight:s.a.KeepLeftMergeRefs:s.a.KeepRight}},{key:"isItemContentEqualWith",value:function(e){return g(this.payload.contentObject,e.payload.contentObject,this.contentKeysToIgnoreWhenCheckingEquality(),this.appDataContentKeysToIgnoreWhenCheckingEquality())}},{key:"satisfiesPredicate",value:function(e){return l.a.ItemSatisfiesPredicate(this,e)}},{key:"updatedAtTimestamp",value:function(){var e;return null===(e=this.updated_at)||void 0===e?void 0:e.getTime()}},{key:"dateToLocalizedString",value:function(e){if("undefined"!=typeof Intl&&Intl.DateTimeFormat){if(!t.sharedDateFormatter){var n=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language;t.sharedDateFormatter=new Intl.DateTimeFormat(n,{year:"numeric",month:"short",day:"2-digit",weekday:"long",hour:"2-digit",minute:"2-digit"})}return t.sharedDateFormatter.format(e)}return e.toDateString()+" "+e.toLocaleTimeString()}},{key:"uuid",get:function(){return this.payload.uuid}},{key:"content",get:function(){return this.payload.content}},{key:"safeContent",get:function(){return this.payload.safeContent}},{key:"references",get:function(){return this.payload.safeContent.references||[]}},{key:"deleted",get:function(){return this.payload.deleted}},{key:"content_type",get:function(){return this.payload.content_type}},{key:"created_at",get:function(){return this.payload.created_at}},{key:"updated_at",get:function(){return this.payload.updated_at}},{key:"userModifiedDate",get:function(){var e=this.getAppDomainValue(a.UserModifiedDate);return new Date(e||this.updated_at)}},{key:"dirtiedDate",get:function(){return this.payload.dirtiedDate}},{key:"dirty",get:function(){return this.payload.dirty}},{key:"errorDecrypting",get:function(){return this.payload.errorDecrypting}},{key:"waitingForKey",get:function(){return this.payload.waitingForKey}},{key:"errorDecryptingValueChanged",get:function(){return this.payload.errorDecryptingValueChanged}},{key:"lastSyncBegan",get:function(){return this.payload.lastSyncBegan}},{key:"lastSyncEnd",get:function(){return this.payload.lastSyncEnd}},{key:"auth_hash",get:function(){return this.payload.auth_hash}},{key:"auth_params",get:function(){return this.payload.auth_params}},{key:"neverSynced",get:function(){return!this.updated_at||0===this.updated_at.getTime()}},{key:"isSingleton",get:function(){return!1}},{key:"singletonPredicate",get:function(){throw"Must override SNItem.singletonPredicate"}},{key:"singletonStrategy",get:function(){return o.KeepEarliest}}],[{key:"DefaultAppDomain",value:function(){return f.b}}]),t}(),m=function(){function e(t,n){y(this,e),this.item=t,this.type=n,this.payload=t.payload,this.payload.content&&(this.content=Object(u.a)(this.payload.content))}return d(e,[{key:"getUuid",value:function(){return this.payload.uuid}},{key:"getItem",value:function(){return this.item}},{key:"getResult",value:function(){if(this.type===r.NonDirtying)return Object(c.b)(this.payload,{content:this.content});this.payload.deleted||(this.type===r.UserInteraction?this.userModifiedDate=new Date:this.item.userModifiedDate||(this.userModifiedDate=new Date(this.item.updated_at)));return Object(c.b)(this.payload,{content:this.content,dirty:!0,dirtiedDate:new Date})}},{key:"mergePayload",value:function(e){this.payload=Object(c.g)(this.payload,e),this.payload.content?this.content=Object(u.a)(this.payload.safeContent):this.content=void 0}},{key:"setContent",value:function(e){this.content=Object(u.a)(e)}},{key:"setDeleted",value:function(){this.content=void 0,this.payload=Object(c.b)(this.payload,{content:this.content,deleted:!0})}},{key:"setDomainData",value:function(e,t){this.payload.errorDecrypting||(this.content.appData||(this.content.appData={}),this.content.appData[t]=e)}},{key:"setDomainDataKey",value:function(e,t,n){if(!this.payload.errorDecrypting){this.content.appData||(this.content.appData={});var r=this.content.appData;r[n]||(r[n]={}),r[n][e]=t}}},{key:"setAppDataItem",value:function(e,t){this.setDomainDataKey(e,t,v.DefaultAppDomain())}},{key:"addItemAsRelationship",value:function(e){var t=this.content.references||[];t.find((function(t){return t.uuid===e.uuid}))||t.push({uuid:e.uuid,content_type:e.content_type}),this.content.references=t}},{key:"removeItemAsRelationship",value:function(e){var t=this.content.references||[];t=t.filter((function(t){return t.uuid!==e.uuid})),this.content.references=t}},{key:"lastSyncBegan",set:function(e){this.payload=Object(c.b)(this.payload,{content:this.content,lastSyncBegan:e})}},{key:"errorDecrypting",set:function(e){this.payload=Object(c.b)(this.payload,{content:this.content,errorDecrypting:e})}},{key:"updated_at",set:function(e){this.payload=Object(c.b)(this.payload,{updated_at:e})}},{key:"userModifiedDate",set:function(e){this.setAppDataItem(a.UserModifiedDate,e)}},{key:"conflictOf",set:function(e){this.content.conflict_of=e}},{key:"protected",set:function(e){this.content.protected=e}},{key:"trashed",set:function(e){this.content.trashed=e}},{key:"pinned",set:function(e){this.setAppDataItem(a.Pinned,e)}},{key:"archived",set:function(e){this.setAppDataItem(a.Archived,e)}},{key:"locked",set:function(e){this.setAppDataItem(a.Locked,e)}}]),e}();function b(e,t,n){return n||(n=[]),!g(e.content,t.content,e.contentKeysToIgnoreWhenCheckingEquality().concat(n),e.appDataContentKeysToIgnoreWhenCheckingEquality())}function g(e,t,n,r){if((e=Object(u.F)(e)).appData){var a=e.appData[f.b];Object(u.z)(a,r),a?0===Object.keys(a).length&&delete e.appData:delete e.appData}if(Object(u.z)(e,n),(t=Object(u.F)(t)).appData){var o=t.appData[f.b];Object(u.z)(o,r),o?0===Object.keys(o).length&&delete t.appData:delete t.appData}return Object(u.z)(t,n),JSON.stringify(e)===JSON.stringify(t)}}).call(this,n(77).setImmediate)},function(e,t,n){"use strict";var r;function a(e,t){return Number(e)-Number(t)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e.V000Base64Decrypted="000",e.V001="001",e.V002="002",e.V003="003",e.V004="004",e[e.VersionLength=3]="VersionLength"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.FullSyncCompleted="sync =full-completed",e.SingleSyncCompleted="sync =single-completed",e.SyncWillBegin="sync =will-begin",e.DownloadFirstSyncCompleted="sync =download-first-completed",e.SyncTakingTooLong="sync =taking-too-long",e.SyncError="sync =error",e.InvalidSession="sync =invalid-session",e.MajorDataChange="major-data-change",e.LocalDataIncrementalLoad="local-data-incremental-load",e.LocalDataLoaded="local-data-loaded",e.EnterOutOfSync="enter-out-of-sync",e.ExitOutOfSync="exit-out-of-sync",e.StatusChanged="status-changed",e.DatabaseWriteError="database-write-error",e.DatabaseReadError="database-read-error"}(r||(r={}))},function(e,t,n){"use strict";var r;function a(e){return e===r.LocalStorageEncrypted||e===r.LocalStorageDecrypted||e===r.LocalStoragePreferEncrypted}function o(e){return e===r.FileEncrypted||e===r.FileDecrypted||e===r.FilePreferEncrypted}function i(e){return e===r.SyncDecrypted||e===r.LocalStorageDecrypted||e===r.FileDecrypted}function s(e){return e===r.Sync||e===r.LocalStorageEncrypted||e===r.FileEncrypted}n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return i})),n.d(t,"b",(function(){return s})),function(e){e[e.Sync=0]="Sync",e[e.SyncDecrypted=1]="SyncDecrypted",e[e.LocalStorageEncrypted=2]="LocalStorageEncrypted",e[e.LocalStorageDecrypted=3]="LocalStorageDecrypted",e[e.LocalStoragePreferEncrypted=4]="LocalStoragePreferEncrypted",e[e.FileEncrypted=5]="FileEncrypted",e[e.FileDecrypted=6]="FileDecrypted",e[e.FilePreferEncrypted=7]="FilePreferEncrypted"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e[e.EncryptedString=0]="EncryptedString",e[e.DecryptedBareObject=1]="DecryptedBareObject",e[e.DecryptedBase64String=2]="DecryptedBase64String",e[e.Deleted=3]="Deleted"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return o}));var r=n(4);function a(e){return e.map((function(e){return e.uuid}))}function o(e){return e.references||(e.references=[]),e.appData||(e.appData={}),e.appData[r.b]||(e.appData[r.b]={}),e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var r=n(0),a=n.n(r),o=n(1);function i(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||c(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=c(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function c(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function l(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function f(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){l(o,r,a,i,s,"next",e)}function s(e){l(o,r,a,i,s,"throw",e)}i(void 0)}))}}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var y=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.eventObservers=[],this.loggingEnabled=!1,this.criticalPromises=[]}var t,n,r,c,u,l,y;return t=e,(n=[{key:"addEventObserver",value:function(e){var t=this;return this.eventObservers.push(e),function(){Object(o.B)(t.eventObservers,e)}}},{key:"notifyEvent",value:(y=f(a.a.mark((function e(t,n){var r,o,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=s(this.eventObservers),e.prev=1,r.s();case 3:if((o=r.n()).done){e.next=9;break}return i=o.value,e.next=7,i(t,n||{});case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),r.e(e.t0);case 14:return e.prev=14,r.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e,t){return y.apply(this,arguments)})},{key:"blockDeinit",value:(l=f(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(this.criticalPromises);case 2:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"deinit",value:function(){this.eventObservers.length=0,this.deviceInterface=void 0}},{key:"executeCriticalFunction",value:(u=f(a.a.mark((function e(t){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t(),this.criticalPromises.push(n),e.abrupt("return",n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"handleApplicationStage",value:(c=f(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return c.apply(this,arguments)})},{key:"log",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(this.loggingEnabled){var a,o=new Date,s=o.toLocaleTimeString().replace(" PM","").replace(" AM",""),c="".concat(s,".").concat(o.getMilliseconds());n?(n=n.map((function(e){return Array.isArray(e)?e.slice():e})),(a=console).log.apply(a,[c,e].concat(i(n)))):console.log(c,e)}}}])&&p(t.prototype,n),r&&p(t,r),e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return i}));var r,a=n(8);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){var t;return(t={},o(t,a.a.FullSyncCompleted,r.CompletedFullSync),o(t,a.a.SingleSyncCompleted,r.CompletedIncrementalSync),o(t,a.a.SyncError,r.FailedSync),o(t,a.a.SyncTakingTooLong,r.HighLatencySync),o(t,a.a.EnterOutOfSync,r.EnteredOutOfSync),o(t,a.a.ExitOutOfSync,r.ExitedOutOfSync),o(t,a.a.LocalDataLoaded,r.LocalDataLoaded),o(t,a.a.MajorDataChange,r.MajorDataChange),o(t,a.a.LocalDataIncrementalLoad,r.LocalDataIncrementalLoad),o(t,a.a.StatusChanged,r.SyncStatusChanged),o(t,a.a.SyncWillBegin,r.WillSync),o(t,a.a.InvalidSession,r.InvalidSyncSession),o(t,a.a.DatabaseReadError,r.LocalDatabaseReadError),o(t,a.a.DatabaseWriteError,r.LocalDatabaseWriteError),t)[e]}n.d(t,"b",(function(){return a.a})),function(e){e[e.SignedIn=2]="SignedIn",e[e.SignedOut=3]="SignedOut",e[e.CompletedFullSync=5]="CompletedFullSync",e[e.FailedSync=6]="FailedSync",e[e.HighLatencySync=7]="HighLatencySync",e[e.EnteredOutOfSync=8]="EnteredOutOfSync",e[e.ExitedOutOfSync=9]="ExitedOutOfSync",e[e.Started=10]="Started",e[e.Launched=11]="Launched",e[e.LocalDataLoaded=12]="LocalDataLoaded",e[e.KeyStatusChanged=13]="KeyStatusChanged",e[e.MajorDataChange=14]="MajorDataChange",e[e.CompletedRestart=15]="CompletedRestart",e[e.LocalDataIncrementalLoad=16]="LocalDataIncrementalLoad",e[e.SyncStatusChanged=17]="SyncStatusChanged",e[e.WillSync=18]="WillSync",e[e.InvalidSyncSession=19]="InvalidSyncSession",e[e.LocalDatabaseReadError=20]="LocalDatabaseReadError",e[e.LocalDatabaseWriteError=21]="LocalDatabaseWriteError",e[e.CompletedIncrementalSync=22]="CompletedIncrementalSync"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e[e.KeepLeft=1]="KeepLeft",e[e.KeepRight=2]="KeepRight",e[e.KeepLeftDuplicateRight=3]="KeepLeftDuplicateRight",e[e.DuplicateLeftKeepRight=4]="DuplicateLeftKeepRight",e[e.KeepLeftMergeRefs=5]="KeepLeftMergeRefs"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(1);function a(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return o(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,c=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){c=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw i}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keypath=t,this.operator=n,this.value=r,this.isRecursive()){var a=this.value;this.value=a.map((function(t){return Array.isArray(t)?e.FromArray(t):t}))}else"true"!==this.value&&"false"!==this.value||(this.value=JSON.parse(this.value))}var t,n,o;return t=e,o=[{key:"FromJson",value:function(t){return new e(t.keypath,t.operator,t.value)}},{key:"FromArray",value:function(t){return new e(t[0],t[1],t[2])}},{key:"CompoundPredicate",value:function(t){return new e("ignored","and",t)}},{key:"ObjectSatisfiesPredicate",value:function(e,t){if(Array.isArray(t)&&(t=this.FromArray(t)),t.isRecursive()){if("and"===t.operator){var n,r=a(t.valueAsArray());try{for(r.s();!(n=r.n()).done;){var o=n.value;if(!this.ObjectSatisfiesPredicate(e,o))return!1}}catch(e){r.e(e)}finally{r.f()}return!0}if("or"===t.operator){var i,s=a(t.valueAsArray());try{for(s.s();!(i=s.n()).done;){var c=i.value;if(this.ObjectSatisfiesPredicate(e,c))return!0}}catch(e){s.e(e)}finally{s.f()}return!1}}var u=t.value;"string"==typeof u&&u.includes(".ago")&&(u=this.DateFromString(u));var l=t.keypath.split(".").reduce((function(e,t){return e&&e[t]}),e),f=[!1,"",null,void 0,NaN];return void 0===l?"!="===t.operator?!f.includes(t.value):f.includes(t.value):"="===t.operator?Array.isArray(l)?JSON.stringify(l)===JSON.stringify(u):l===u:"!="===t.operator?Array.isArray(l)?JSON.stringify(l)!==JSON.stringify(u):l!==u:"<"===t.operator?l<u:">"===t.operator?l>u:"<="===t.operator?l<=u:">="===t.operator?l>=u:"startsWith"===t.operator?l.startsWith(u):"in"===t.operator?-1!==u.indexOf(l):"includes"===t.operator?this.resolveIncludesPredicate(l,u):"matches"===t.operator&&new RegExp(u).test(l)}},{key:"resolveIncludesPredicate",value:function(t,n){if(Object(r.s)(n))return t.includes(n);var o;o=Array.isArray(n)?e.FromArray(n):n;var i,s=a(t);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(this.ObjectSatisfiesPredicate(c,o))return!0}}catch(e){s.e(e)}finally{s.f()}return!1}},{key:"ItemSatisfiesPredicate",value:function(t,n){return Array.isArray(n)&&(n=e.FromArray(n)),this.ObjectSatisfiesPredicate(t,n)}},{key:"ItemSatisfiesPredicates",value:function(e,t){var n,r=a(t);try{for(r.s();!(n=r.n()).done;){var o=n.value;if(!this.ItemSatisfiesPredicate(e,o))return!1}}catch(e){r.e(e)}finally{r.f()}return!0}},{key:"DateFromString",value:function(e){var t=e.split("."),n=t[1],r=new Date,a=parseInt(t[0]);return"days"===n?r.setDate(r.getDate()-a):"hours"===n&&r.setHours(r.getHours()-a),r}}],(n=[{key:"isRecursive",value:function(){return["and","or"].includes(this.operator)}},{key:"arrayRepresentation",value:function(){return[this.keypath,this.operator,this.value]}},{key:"valueAsArray",value:function(){return this.value}}])&&i(t.prototype,n),o&&i(t,o),e}()},function(e,t,n){"use strict";var r=Array.isArray;e.exports=r},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(56),o="object"==("undefined"==typeof self?"undefined":r(self))&&self&&self.Object===Object&&self,i=a||o||Function("return this")();e.exports=i},function(e,t,n){"use strict";var r=n(157)(n(158));e.exports=r},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return null!=e&&("object"==t||"function"==t)}},function(e,t,n){"use strict";var r=n(39),a=n(152);e.exports=function(e,t){var n=[];if(!e||!e.length)return n;var o=-1,i=[],s=e.length;for(t=r(t,3);++o<s;){var c=e[o];t(c,o,e)&&(n.push(c),i.push(o))}return a(e,i),n}},function(e,t,n){"use strict";var r=n(94),a=n(99);e.exports=function(e,t){var n=a(e,t);return r(n)?n:void 0}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){return null!=e&&"object"==r(e)}},function(e,t,n){"use strict";var r=n(76);e.exports=function(e){return e&&e.length?r(e):[]}},function(e,t,n){"use strict";var r=n(33),a=n(95),o=n(96),i=r?r.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?a(e):o(e)}},function(e,t,n){"use strict";e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,n){"use strict";var r=n(42),a=n(49);e.exports=function(e){return null!=e&&a(e.length)&&!r(e)}},function(e,t,n){"use strict";var r=n(37);e.exports=function(e){if("string"==typeof e||r(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var r=n(11),a=n(5),o=n(3),i=n(7),s=n(1),c=n(10);function u(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var p=function(){function e(t,n,u){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.fields=n||Object.keys(t),this.source=u||o.a.Constructor,this.uuid=t.uuid,!this.uuid&&this.fields.includes(a.a.Uuid))throw Error("uuid is null, yet this payloads fields indicate it shouldnt be.");this.content_type=t.content_type,t.content&&(Object(s.q)(t.content)?this.content=Object(r.a)(t.content):this.content=t.content),this.deleted=t.deleted,this.items_key_id=t.items_key_id,this.enc_item_key=t.enc_item_key,this.created_at=new Date(t.created_at||new Date),this.updated_at=new Date(t.updated_at||new Date(0)),this.dirtiedDate=new Date(t.dirtiedDate),this.dirty=t.dirty,this.errorDecrypting=t.errorDecrypting,this.waitingForKey=t.waitingForKey,this.errorDecryptingValueChanged=t.errorDecryptingValueChanged,this.lastSyncBegan=t.lastSyncBegan?new Date(t.lastSyncBegan):void 0,this.lastSyncEnd=t.lastSyncEnd?new Date(t.lastSyncEnd):void 0,this.auth_hash=t.auth_hash,this.auth_params=t.auth_params,Object(s.s)(this.content)?this.content.startsWith(i.a.V000Base64Decrypted)?this.format=c.a.DecryptedBase64String:this.format=c.a.EncryptedString:Object(s.q)(this.content)?this.format=c.a.DecryptedBareObject:this.format=c.a.Deleted,Object(s.s)(this.content)?this.version=this.content.substring(0,i.a.VersionLength):this.content&&(this.version=this.content.version),Object(s.g)(this)}var t,n,l;return t=e,(n=[{key:"ejected",value:function(){var e,t=[a.a.Legacy003AuthHash,a.a.Deleted],n=[a.a.DirtiedDate,a.a.ErrorDecrypting,a.a.ErrorDecryptingChanged,a.a.WaitingForKey,a.a.LastSyncBegan,a.a.LastSyncEnd],r={},o=u(this.fields);try{for(o.s();!(e=o.n()).done;){var i=e.value;if(!n.includes(i)){var c=this[i];Object(s.p)(c)&&t.includes(i)||(r[i]=c)}}}catch(e){o.e(e)}finally{o.f()}return r}},{key:"safeContent",get:function(){return this.format===c.a.DecryptedBareObject?this.content:{}}},{key:"references",get:function(){return this.safeReferences}},{key:"safeReferences",get:function(){return this.safeContent.references||[]}},{key:"contentObject",get:function(){if(this.format!==c.a.DecryptedBareObject)throw Error("Attempting to access non-object content as object");return this.content}},{key:"contentString",get:function(){if(this.format===c.a.DecryptedBareObject)throw Error("Attempting to access non-string content as string");return this.content}},{key:"discardable",get:function(){return this.deleted&&!this.dirty}}])&&f(t.prototype,n),l&&f(t,l),e}()},function(e,t,n){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a;a=function(){return this}();try{a=a||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":r(window))&&(a=window)}e.exports=a},function(e,t,n){"use strict";var r=n(84),a=n(85),o=n(86),i=n(87),s=n(88);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){"use strict";var r=n(25);e.exports=function(e,t){for(var n=e.length;n--;)if(r(e[n][0],t))return n;return-1}},function(e,t,n){"use strict";var r=n(17).Symbol;e.exports=r},function(e,t,n){"use strict";var r=n(21)(Object,"create");e.exports=r},function(e,t,n){"use strict";var r=n(108);e.exports=function(e,t){var n=e.__data__;return r(t)?n["string"==typeof t?"string":"hash"]:n.map}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var n=r(e);return!!(t=null==t?9007199254740991:t)&&("number"==n||"symbol"!=n&&a.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(24),o=n(22);e.exports=function(e){return"symbol"==r(e)||o(e)&&"[object Symbol]"==a(e)}},function(e,t,n){"use strict";var r=n(69),a=n(75)((function(e,t,n){r(e,t,n)}));e.exports=a},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(82),o=n(138),i=n(54),s=n(16),c=n(149);e.exports=function(e){return"function"==typeof e?e:null==e?i:"object"==r(e)?s(e)?o(e[0],e[1]):a(e):c(e)}},function(e,t,n){"use strict";var r=n(31),a=n(89),o=n(90),i=n(91),s=n(92),c=n(93);function u(e){var t=this.__data__=new r(e);this.size=t.size}u.prototype.clear=a,u.prototype.delete=o,u.prototype.get=i,u.prototype.has=s,u.prototype.set=c,e.exports=u},function(e,t,n){"use strict";var r=n(21)(n(17),"Map");e.exports=r},function(e,t,n){"use strict";var r=n(24),a=n(19);e.exports=function(e){if(!a(e))return!1;var t=r(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,n){"use strict";var r=n(100),a=n(107),o=n(109),i=n(110),s=n(111);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){"use strict";e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}},function(e,t,n){"use strict";var r=n(63),a=n(131),o=n(26);e.exports=function(e){return o(e)?r(e):a(e)}},function(e,t,n){"use strict";var r=n(126),a=n(22),o=Object.prototype,i=o.hasOwnProperty,s=o.propertyIsEnumerable,c=r(function(){return arguments}())?r:function(e){return a(e)&&i.call(e,"callee")&&!s.call(e,"callee")};e.exports=c},function(e,t,n){"use strict";(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(17),o=n(127),i="object"==r(t)&&t&&!t.nodeType&&t,s=i&&"object"==r(e)&&e&&!e.nodeType&&e,c=s&&s.exports===i?a.Buffer:void 0,u=(c?c.isBuffer:void 0)||o;e.exports=u}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(128),a=n(129),o=n(130),i=o&&o.isTypedArray,s=i?a(i):r;e.exports=s},function(e,t,n){"use strict";e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t,n){"use strict";var r=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||r)}},function(e,t,n){"use strict";var r=n(52),a=n(27);e.exports=function(e,t){for(var n=0,o=(t=r(t,e)).length;null!=e&&n<o;)e=e[a(t[n++])];return n&&n==o?e:void 0}},function(e,t,n){"use strict";var r=n(16),a=n(53),o=n(140),i=n(143);e.exports=function(e,t){return r(e)?e:a(e,t)?[e]:o(i(e))}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(16),o=n(37),i=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;e.exports=function(e,t){if(a(e))return!1;var n=r(e);return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!o(e))||(s.test(e)||!i.test(e)||null!=t&&e in Object(t))}},function(e,t,n){"use strict";e.exports=function(e){return e}},function(e,t,n){"use strict";var r=n(71);e.exports=function(e,t,n){"__proto__"==t&&r?r(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},function(e,t,n){"use strict";(function(t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r="object"==(void 0===t?"undefined":n(t))&&t&&t.Object===Object&&t;e.exports=r}).call(this,n(30))},function(e,t,n){"use strict";var r=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return r.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,n){"use strict";var r=n(112),a=n(22);e.exports=function e(t,n,o,i,s){return t===n||(null==t||null==n||!a(t)&&!a(n)?t!=t&&n!=n:r(t,n,o,i,e,s))}},function(e,t,n){"use strict";var r=n(60),a=n(115),o=n(61);e.exports=function(e,t,n,i,s,c){var u=1&n,l=e.length,f=t.length;if(l!=f&&!(u&&f>l))return!1;var p=c.get(e);if(p&&c.get(t))return p==t;var y=-1,h=!0,d=2&n?new r:void 0;for(c.set(e,t),c.set(t,e);++y<l;){var v=e[y],m=t[y];if(i)var b=u?i(m,v,y,t,e,c):i(v,m,y,e,t,c);if(void 0!==b){if(b)continue;h=!1;break}if(d){if(!a(t,(function(e,t){if(!o(d,t)&&(v===e||s(v,e,n,i,c)))return d.push(t)}))){h=!1;break}}else if(v!==m&&!s(v,m,n,i,c)){h=!1;break}}return c.delete(e),c.delete(t),h}},function(e,t,n){"use strict";var r=n(43),a=n(113),o=n(114);function i(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new r;++t<n;)this.add(e[t])}i.prototype.add=i.prototype.push=a,i.prototype.has=o,e.exports=i},function(e,t,n){"use strict";e.exports=function(e,t){return e.has(t)}},function(e,t,n){"use strict";var r=n(17).Uint8Array;e.exports=r},function(e,t,n){"use strict";var r=n(125),a=n(46),o=n(16),i=n(47),s=n(36),c=n(48),u=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=o(e),l=!n&&a(e),f=!n&&!l&&i(e),p=!n&&!l&&!f&&c(e),y=n||l||f||p,h=y?r(e.length,String):[],d=h.length;for(var v in e)!t&&!u.call(e,v)||y&&("length"==v||f&&("offset"==v||"parent"==v)||p&&("buffer"==v||"byteLength"==v||"byteOffset"==v)||s(v,d))||h.push(v);return h}},function(e,t,n){"use strict";e.exports=function(e,t){return function(n){return e(t(n))}}},function(e,t,n){"use strict";var r=n(21)(n(17),"Set");e.exports=r},function(e,t,n){"use strict";var r=n(19);e.exports=function(e){return e==e&&!r(e)}},function(e,t,n){"use strict";e.exports=function(e,t){return function(n){return null!=n&&(n[e]===t&&(void 0!==t||e in Object(n)))}}},function(e,t,n){"use strict";e.exports=function(e,t,n,r){for(var a=e.length,o=n+(r?1:-1);r?o--:++o<a;)if(t(e[o],o,e))return o;return-1}},function(e,t,n){"use strict";var r=n(40),a=n(70),o=n(162),i=n(164),s=n(19),c=n(74),u=n(73);e.exports=function e(t,n,l,f,p){t!==n&&o(n,(function(o,c){if(p||(p=new r),s(o))i(t,n,c,l,e,f,p);else{var y=f?f(u(t,c),o,c+"",t,n,p):void 0;void 0===y&&(y=o),a(t,c,y)}}),c)}},function(e,t,n){"use strict";var r=n(55),a=n(25);e.exports=function(e,t,n){(void 0===n||a(e[t],n))&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){"use strict";var r=n(21),a=function(){try{var e=r(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=a},function(e,t,n){"use strict";var r=n(64)(Object.getPrototypeOf,Object);e.exports=r},function(e,t,n){"use strict";e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},function(e,t,n){"use strict";var r=n(63),a=n(176),o=n(26);e.exports=function(e){return o(e)?r(e,!0):a(e)}},function(e,t,n){"use strict";var r=n(178),a=n(185);e.exports=function(e){return r((function(t,n){var r=-1,o=n.length,i=o>1?n[o-1]:void 0,s=o>2?n[2]:void 0;for(i=e.length>3&&"function"==typeof i?(o--,i):void 0,s&&a(n[0],n[1],s)&&(i=o<3?void 0:i,o=1),t=Object(t);++r<o;){var c=n[r];c&&e(t,c,r,i)}return t}))}},function(e,t,n){"use strict";var r=n(60),a=n(186),o=n(190),i=n(61),s=n(191),c=n(44);e.exports=function(e,t,n){var u=-1,l=a,f=e.length,p=!0,y=[],h=y;if(n)p=!1,l=o;else if(f>=200){var d=t?null:s(e);if(d)return c(d);p=!1,l=i,h=new r}else h=t?[]:y;e:for(;++u<f;){var v=e[u],m=t?t(v):v;if(v=n||0!==v?v:0,p&&m==m){for(var b=h.length;b--;)if(h[b]===m)continue e;t&&h.push(m),y.push(v)}else l(h,m,n)||(h!==y&&h.push(m),y.push(v))}return y}},function(e,t,n){"use strict";(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,a=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(a.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new o(a.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(193),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(30))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return v}));var r=n(0),a=n.n(r),o=n(12),i=n(13);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){c(o,r,a,i,s,"next",e)}function s(e){c(o,r,a,i,s,"throw",e)}i(void 0)}))}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return(f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var a=d(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var v=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(m,t);var n,r,o,s,c,h,v=y(m);function m(t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),(n=v.call(this)).application=t,e((function(){n.addAppEventObserver()})),n}return n=m,(r=[{key:"deinit",value:function(){this.application=void 0,this.unsubApp(),this.unsubApp=void 0,f(d(m.prototype),"deinit",this).call(this)}},{key:"addAppEventObserver",value:function(){var e=this;this.application.isStarted()&&this.onAppStart(),this.application.isLaunched()&&this.onAppLaunch(),this.unsubApp=this.application.addEventObserver(function(){var t=u(a.a.mark((function t(n){return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.onAppEvent(n),n!==i.a.Started){t.next=6;break}return t.next=4,e.onAppStart();case 4:t.next=12;break;case 6:if(n!==i.a.Launched){t.next=11;break}return t.next=9,e.onAppLaunch();case 9:t.next=12;break;case 11:n===i.a.CompletedFullSync?e.onAppFullSync():n===i.a.CompletedIncrementalSync?e.onAppIncrementalSync():n===i.a.KeyStatusChanged&&e.onAppKeyChange();case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"onAppEvent",value:function(e){}},{key:"onAppStart",value:(h=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return h.apply(this,arguments)})},{key:"onAppLaunch",value:(c=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return c.apply(this,arguments)})},{key:"onAppKeyChange",value:(s=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return s.apply(this,arguments)})},{key:"onAppIncrementalSync",value:function(){}},{key:"onAppFullSync",value:function(){}}])&&l(n.prototype,r),o&&l(n,o),m}(o.a)}).call(this,n(77).setImmediate)},function(e,t,n){"use strict";var r=n(69),a=n(75)((function(e,t,n,a){r(e,t,n,a)}));e.exports=a},function(e,t,n){"use strict";var r=n(76);e.exports=function(e,t){return t="function"==typeof t?t:void 0,e&&e.length?r(e,void 0,t):[]}},function(e,t,n){"use strict";(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=function(e){var n=Object.prototype,r=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,n,r){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new x(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(a,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw o;return P()}for(n.method=a,n.arg=o;;){var i=n.delegate;if(i){var s=w(i,n);if(s){if(s===l)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=u(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}(e,n,i),o}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function y(){}var h={};h[o]=function(){return this};var d=Object.getPrototypeOf,v=d&&d(d(O([])));v&&v!==n&&r.call(v,o)&&(h=v);var m=y.prototype=f.prototype=Object.create(h);function b(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function g(e,n){var a;this._invoke=function(o,i){function s(){return new n((function(a,s){!function a(o,i,s,c){var l=u(e[o],e,i);if("throw"!==l.type){var f=l.arg,p=f.value;return p&&"object"===t(p)&&r.call(p,"__await")?n.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):n.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return a("throw",e,s,c)}))}c(l.arg)}(o,i,a,s)}))}return a=a?a.then(s,s):s()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=u(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:P}}function P(){return{value:void 0,done:!0}}return p.prototype=m.constructor=y,y.constructor=p,y[s]=p.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},b(g.prototype),g.prototype[i]=function(){return this},e.AsyncIterator=g,e.async=function(t,n,r,a,o){void 0===o&&(o=Promise);var i=new g(c(t,n,r,a),o);return e.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(m),m[s]="Generator",m[o]=function(){return this},m.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=O,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(S),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;S(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:O(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}("object"===t(e)?e.exports:{});try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(83),a=n(137),o=n(67);e.exports=function(e){var t=a(e);return 1==t.length&&t[0][2]?o(t[0][0],t[0][1]):function(n){return n===e||r(n,e,t)}}},function(e,t,n){"use strict";var r=n(40),a=n(58);e.exports=function(e,t,n,o){var i=n.length,s=i,c=!o;if(null==e)return!s;for(e=Object(e);i--;){var u=n[i];if(c&&u[2]?u[1]!==e[u[0]]:!(u[0]in e))return!1}for(;++i<s;){var l=(u=n[i])[0],f=e[l],p=u[1];if(c&&u[2]){if(void 0===f&&!(l in e))return!1}else{var y=new r;if(o)var h=o(f,p,l,e,t,y);if(!(void 0===h?a(p,f,3,o,y):h))return!1}}return!0}},function(e,t,n){"use strict";e.exports=function(){this.__data__=[],this.size=0}},function(e,t,n){"use strict";var r=n(32),a=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=r(t,e);return!(n<0)&&(n==t.length-1?t.pop():a.call(t,n,1),--this.size,!0)}},function(e,t,n){"use strict";var r=n(32);e.exports=function(e){var t=this.__data__,n=r(t,e);return n<0?void 0:t[n][1]}},function(e,t,n){"use strict";var r=n(32);e.exports=function(e){return r(this.__data__,e)>-1}},function(e,t,n){"use strict";var r=n(32);e.exports=function(e,t){var n=this.__data__,a=r(n,e);return a<0?(++this.size,n.push([e,t])):n[a][1]=t,this}},function(e,t,n){"use strict";var r=n(31);e.exports=function(){this.__data__=new r,this.size=0}},function(e,t,n){"use strict";e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.get(e)}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){"use strict";var r=n(31),a=n(41),o=n(43);e.exports=function(e,t){var n=this.__data__;if(n instanceof r){var i=n.__data__;if(!a||i.length<199)return i.push([e,t]),this.size=++n.size,this;n=this.__data__=new o(i)}return n.set(e,t),this.size=n.size,this}},function(e,t,n){"use strict";var r=n(42),a=n(97),o=n(19),i=n(57),s=/^\[object .+?Constructor\]$/,c=Function.prototype,u=Object.prototype,l=c.toString,f=u.hasOwnProperty,p=RegExp("^"+l.call(f).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!o(e)||a(e))&&(r(e)?p:s).test(i(e))}},function(e,t,n){"use strict";var r=n(33),a=Object.prototype,o=a.hasOwnProperty,i=a.toString,s=r?r.toStringTag:void 0;e.exports=function(e){var t=o.call(e,s),n=e[s];try{e[s]=void 0;var r=!0}catch(e){}var a=i.call(e);return r&&(t?e[s]=n:delete e[s]),a}},function(e,t,n){"use strict";var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},function(e,t,n){"use strict";var r,a=n(98),o=(r=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";e.exports=function(e){return!!o&&o in e}},function(e,t,n){"use strict";var r=n(17)["__core-js_shared__"];e.exports=r},function(e,t,n){"use strict";e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,n){"use strict";var r=n(101),a=n(31),o=n(41);e.exports=function(){this.size=0,this.__data__={hash:new r,map:new(o||a),string:new r}}},function(e,t,n){"use strict";var r=n(102),a=n(103),o=n(104),i=n(105),s=n(106);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){"use strict";var r=n(34);e.exports=function(){this.__data__=r?r(null):{},this.size=0}},function(e,t,n){"use strict";e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,n){"use strict";var r=n(34),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(r){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return a.call(t,e)?t[e]:void 0}},function(e,t,n){"use strict";var r=n(34),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return r?void 0!==t[e]:a.call(t,e)}},function(e,t,n){"use strict";var r=n(34);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=r&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e){var t=r(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e){return r(this,e).get(e)}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e){return r(this,e).has(e)}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e,t){var n=r(this,e),a=n.size;return n.set(e,t),this.size+=n.size==a?0:1,this}},function(e,t,n){"use strict";var r=n(40),a=n(59),o=n(116),i=n(118),s=n(133),c=n(16),u=n(47),l=n(48),f="[object Object]",p=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,y,h,d){var v=c(e),m=c(t),b=v?"[object Array]":s(e),g=m?"[object Array]":s(t),w=(b="[object Arguments]"==b?f:b)==f,k=(g="[object Arguments]"==g?f:g)==f,S=b==g;if(S&&u(e)){if(!u(t))return!1;v=!0,w=!1}if(S&&!w)return d||(d=new r),v||l(e)?a(e,t,n,y,h,d):o(e,t,b,n,y,h,d);if(!(1&n)){var x=w&&p.call(e,"__wrapped__"),O=k&&p.call(t,"__wrapped__");if(x||O){var P=x?e.value():e,j=O?t.value():t;return d||(d=new r),h(P,j,n,y,d)}}return!!S&&(d||(d=new r),i(e,t,n,y,h,d))}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}},function(e,t,n){"use strict";var r=n(33),a=n(62),o=n(25),i=n(59),s=n(117),c=n(44),u=r?r.prototype:void 0,l=u?u.valueOf:void 0;e.exports=function(e,t,n,r,u,f,p){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!f(new a(e),new a(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return o(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var y=s;case"[object Set]":var h=1&r;if(y||(y=c),e.size!=t.size&&!h)return!1;var d=p.get(e);if(d)return d==t;r|=2,p.set(e,t);var v=i(y(e),y(t),r,u,f,p);return p.delete(e),v;case"[object Symbol]":if(l)return l.call(e)==l.call(t)}return!1}},function(e,t,n){"use strict";e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}},function(e,t,n){"use strict";var r=n(119),a=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,o,i,s){var c=1&n,u=r(e),l=u.length;if(l!=r(t).length&&!c)return!1;for(var f=l;f--;){var p=u[f];if(!(c?p in t:a.call(t,p)))return!1}var y=s.get(e);if(y&&s.get(t))return y==t;var h=!0;s.set(e,t),s.set(t,e);for(var d=c;++f<l;){var v=e[p=u[f]],m=t[p];if(o)var b=c?o(m,v,p,t,e,s):o(v,m,p,e,t,s);if(!(void 0===b?v===m||i(v,m,n,o,s):b)){h=!1;break}d||(d="constructor"==p)}if(h&&!d){var g=e.constructor,w=t.constructor;g!=w&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof w&&w instanceof w)&&(h=!1)}return s.delete(e),s.delete(t),h}},function(e,t,n){"use strict";var r=n(120),a=n(122),o=n(45);e.exports=function(e){return r(e,o,a)}},function(e,t,n){"use strict";var r=n(121),a=n(16);e.exports=function(e,t,n){var o=t(e);return a(e)?o:r(o,n(e))}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=t.length,a=e.length;++n<r;)e[a+n]=t[n];return e}},function(e,t,n){"use strict";var r=n(123),a=n(124),o=Object.prototype.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(e){return null==e?[]:(e=Object(e),r(i(e),(function(t){return o.call(e,t)})))}:a;e.exports=s},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=0,o=[];++n<r;){var i=e[n];t(i,n,e)&&(o[a++]=i)}return o}},function(e,t,n){"use strict";e.exports=function(){return[]}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}},function(e,t,n){"use strict";var r=n(24),a=n(22);e.exports=function(e){return a(e)&&"[object Arguments]"==r(e)}},function(e,t,n){"use strict";e.exports=function(){return!1}},function(e,t,n){"use strict";var r=n(24),a=n(49),o=n(22),i={};i["[object Float32Array]"]=i["[object Float64Array]"]=i["[object Int8Array]"]=i["[object Int16Array]"]=i["[object Int32Array]"]=i["[object Uint8Array]"]=i["[object Uint8ClampedArray]"]=i["[object Uint16Array]"]=i["[object Uint32Array]"]=!0,i["[object Arguments]"]=i["[object Array]"]=i["[object ArrayBuffer]"]=i["[object Boolean]"]=i["[object DataView]"]=i["[object Date]"]=i["[object Error]"]=i["[object Function]"]=i["[object Map]"]=i["[object Number]"]=i["[object Object]"]=i["[object RegExp]"]=i["[object Set]"]=i["[object String]"]=i["[object WeakMap]"]=!1,e.exports=function(e){return o(e)&&a(e.length)&&!!i[r(e)]}},function(e,t,n){"use strict";e.exports=function(e){return function(t){return e(t)}}},function(e,t,n){"use strict";(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(56),o="object"==r(t)&&t&&!t.nodeType&&t,i=o&&"object"==r(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o&&a.process,c=function(){try{var e=i&&i.require&&i.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=c}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(50),a=n(132),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return a(e);var t=[];for(var n in Object(e))o.call(e,n)&&"constructor"!=n&&t.push(n);return t}},function(e,t,n){"use strict";var r=n(64)(Object.keys,Object);e.exports=r},function(e,t,n){"use strict";var r=n(134),a=n(41),o=n(135),i=n(65),s=n(136),c=n(24),u=n(57),l=u(r),f=u(a),p=u(o),y=u(i),h=u(s),d=c;(r&&"[object DataView]"!=d(new r(new ArrayBuffer(1)))||a&&"[object Map]"!=d(new a)||o&&"[object Promise]"!=d(o.resolve())||i&&"[object Set]"!=d(new i)||s&&"[object WeakMap]"!=d(new s))&&(d=function(e){var t=c(e),n="[object Object]"==t?e.constructor:void 0,r=n?u(n):"";if(r)switch(r){case l:return"[object DataView]";case f:return"[object Map]";case p:return"[object Promise]";case y:return"[object Set]";case h:return"[object WeakMap]"}return t}),e.exports=d},function(e,t,n){"use strict";var r=n(21)(n(17),"DataView");e.exports=r},function(e,t,n){"use strict";var r=n(21)(n(17),"Promise");e.exports=r},function(e,t,n){"use strict";var r=n(21)(n(17),"WeakMap");e.exports=r},function(e,t,n){"use strict";var r=n(66),a=n(45);e.exports=function(e){for(var t=a(e),n=t.length;n--;){var o=t[n],i=e[o];t[n]=[o,i,r(i)]}return t}},function(e,t,n){"use strict";var r=n(58),a=n(139),o=n(146),i=n(53),s=n(66),c=n(67),u=n(27);e.exports=function(e,t){return i(e)&&s(t)?c(u(e),t):function(n){var i=a(n,e);return void 0===i&&i===t?o(n,e):r(t,i,3)}}},function(e,t,n){"use strict";var r=n(51);e.exports=function(e,t,n){var a=null==e?void 0:r(e,t);return void 0===a?n:a}},function(e,t,n){"use strict";var r=n(141),a=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,o=/\\(\\)?/g,i=r((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(a,(function(e,n,r,a){t.push(r?a.replace(o,"$1"):n||e)})),t}));e.exports=i},function(e,t,n){"use strict";var r=n(142);e.exports=function(e){var t=r(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}},function(e,t,n){"use strict";var r=n(43);function a(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function n(){var r=arguments,a=t?t.apply(this,r):r[0],o=n.cache;if(o.has(a))return o.get(a);var i=e.apply(this,r);return n.cache=o.set(a,i)||o,i};return n.cache=new(a.Cache||r),n}a.Cache=r,e.exports=a},function(e,t,n){"use strict";var r=n(144);e.exports=function(e){return null==e?"":r(e)}},function(e,t,n){"use strict";var r=n(33),a=n(145),o=n(16),i=n(37),s=r?r.prototype:void 0,c=s?s.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(o(t))return a(t,e)+"";if(i(t))return c?c.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=Array(r);++n<r;)a[n]=t(e[n],n,e);return a}},function(e,t,n){"use strict";var r=n(147),a=n(148);e.exports=function(e,t){return null!=e&&a(e,t,r)}},function(e,t,n){"use strict";e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,n){"use strict";var r=n(52),a=n(46),o=n(16),i=n(36),s=n(49),c=n(27);e.exports=function(e,t,n){for(var u=-1,l=(t=r(t,e)).length,f=!1;++u<l;){var p=c(t[u]);if(!(f=null!=e&&n(e,p)))break;e=e[p]}return f||++u!=l?f:!!(l=null==e?0:e.length)&&s(l)&&i(p,l)&&(o(e)||a(e))}},function(e,t,n){"use strict";var r=n(150),a=n(151),o=n(53),i=n(27);e.exports=function(e){return o(e)?r(i(e)):a(e)}},function(e,t,n){"use strict";e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,n){"use strict";var r=n(51);e.exports=function(e){return function(t){return r(t,e)}}},function(e,t,n){"use strict";var r=n(153),a=n(36),o=Array.prototype.splice;e.exports=function(e,t){for(var n=e?t.length:0,i=n-1;n--;){var s=t[n];if(n==i||s!==c){var c=s;a(s)?o.call(e,s,1):r(e,s)}}return e}},function(e,t,n){"use strict";var r=n(52),a=n(154),o=n(155),i=n(27);e.exports=function(e,t){return t=r(t,e),null==(e=o(e,t))||delete e[i(a(t))]}},function(e,t,n){"use strict";e.exports=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}},function(e,t,n){"use strict";var r=n(51),a=n(156);e.exports=function(e,t){return t.length<2?e:r(e,a(t,0,-1))}},function(e,t,n){"use strict";e.exports=function(e,t,n){var r=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(n=n>a?a:n)<0&&(n+=a),a=t>n?0:n-t>>>0,t>>>=0;for(var o=Array(a);++r<a;)o[r]=e[r+t];return o}},function(e,t,n){"use strict";var r=n(39),a=n(26),o=n(45);e.exports=function(e){return function(t,n,i){var s=Object(t);if(!a(t)){var c=r(n,3);t=o(t),n=function(e){return c(s[e],e,s)}}var u=e(t,n,i);return u>-1?s[c?t[u]:u]:void 0}}},function(e,t,n){"use strict";var r=n(68),a=n(39),o=n(159),i=Math.max;e.exports=function(e,t,n){var s=null==e?0:e.length;if(!s)return-1;var c=null==n?0:o(n);return c<0&&(c=i(s+c,0)),r(e,a(t,3),c)}},function(e,t,n){"use strict";var r=n(160);e.exports=function(e){var t=r(e),n=t%1;return t==t?n?t-n:t:0}},function(e,t,n){"use strict";var r=n(161);e.exports=function(e){return e?(e=r(e))===1/0||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},function(e,t,n){"use strict";var r=n(19),a=n(37),o=/^\s+|\s+$/g,i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(a(e))return NaN;if(r(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=r(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(o,"");var n=s.test(e);return n||c.test(e)?u(e.slice(2),n?2:8):i.test(e)?NaN:+e}},function(e,t,n){"use strict";var r=n(163)();e.exports=r},function(e,t,n){"use strict";e.exports=function(e){return function(t,n,r){for(var a=-1,o=Object(t),i=r(t),s=i.length;s--;){var c=i[e?s:++a];if(!1===n(o[c],c,o))break}return t}}},function(e,t,n){"use strict";var r=n(70),a=n(165),o=n(166),i=n(168),s=n(169),c=n(46),u=n(16),l=n(171),f=n(47),p=n(42),y=n(19),h=n(172),d=n(48),v=n(73),m=n(173);e.exports=function(e,t,n,b,g,w,k){var S=v(e,n),x=v(t,n),O=k.get(x);if(O)r(e,n,O);else{var P=w?w(S,x,n+"",e,t,k):void 0,j=void 0===P;if(j){var D=u(x),C=!D&&f(x),_=!D&&!C&&d(x);P=x,D||C||_?u(S)?P=S:l(S)?P=i(S):C?(j=!1,P=a(x,!0)):_?(j=!1,P=o(x,!0)):P=[]:h(x)||c(x)?(P=S,c(S)?P=m(S):y(S)&&!p(S)||(P=s(x))):j=!1}j&&(k.set(x,P),g(P,x,b,w,k),k.delete(x)),r(e,n,P)}}},function(e,t,n){"use strict";(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(17),o="object"==r(t)&&t&&!t.nodeType&&t,i=o&&"object"==r(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o?a.Buffer:void 0,c=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=c?c(n):new e.constructor(n);return e.copy(r),r}}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(167);e.exports=function(e,t){var n=t?r(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},function(e,t,n){"use strict";var r=n(62);e.exports=function(e){var t=new e.constructor(e.byteLength);return new r(t).set(new r(e)),t}},function(e,t,n){"use strict";e.exports=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}},function(e,t,n){"use strict";var r=n(170),a=n(72),o=n(50);e.exports=function(e){return"function"!=typeof e.constructor||o(e)?{}:r(a(e))}},function(e,t,n){"use strict";var r=n(19),a=Object.create,o=function(){function e(){}return function(t){if(!r(t))return{};if(a)return a(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=o},function(e,t,n){"use strict";var r=n(26),a=n(22);e.exports=function(e){return a(e)&&r(e)}},function(e,t,n){"use strict";var r=n(24),a=n(72),o=n(22),i=Function.prototype,s=Object.prototype,c=i.toString,u=s.hasOwnProperty,l=c.call(Object);e.exports=function(e){if(!o(e)||"[object Object]"!=r(e))return!1;var t=a(e);if(null===t)return!0;var n=u.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&c.call(n)==l}},function(e,t,n){"use strict";var r=n(174),a=n(74);e.exports=function(e){return r(e,a(e))}},function(e,t,n){"use strict";var r=n(175),a=n(55);e.exports=function(e,t,n,o){var i=!n;n||(n={});for(var s=-1,c=t.length;++s<c;){var u=t[s],l=o?o(n[u],e[u],u,n,e):void 0;void 0===l&&(l=e[u]),i?a(n,u,l):r(n,u,l)}return n}},function(e,t,n){"use strict";var r=n(55),a=n(25),o=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var i=e[t];o.call(e,t)&&a(i,n)&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){"use strict";var r=n(19),a=n(50),o=n(177),i=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return o(e);var t=a(e),n=[];for(var s in e)("constructor"!=s||!t&&i.call(e,s))&&n.push(s);return n}},function(e,t,n){"use strict";e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},function(e,t,n){"use strict";var r=n(54),a=n(179),o=n(181);e.exports=function(e,t){return o(a(e,t,r),e+"")}},function(e,t,n){"use strict";var r=n(180),a=Math.max;e.exports=function(e,t,n){return t=a(void 0===t?e.length-1:t,0),function(){for(var o=arguments,i=-1,s=a(o.length-t,0),c=Array(s);++i<s;)c[i]=o[t+i];i=-1;for(var u=Array(t+1);++i<t;)u[i]=o[i];return u[t]=n(c),r(e,this,u)}}},function(e,t,n){"use strict";e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},function(e,t,n){"use strict";var r=n(182),a=n(184)(r);e.exports=a},function(e,t,n){"use strict";var r=n(183),a=n(71),o=n(54),i=a?function(e,t){return a(e,"toString",{configurable:!0,enumerable:!1,value:r(t),writable:!0})}:o;e.exports=i},function(e,t,n){"use strict";e.exports=function(e){return function(){return e}}},function(e,t,n){"use strict";var r=Date.now;e.exports=function(e){var t=0,n=0;return function(){var a=r(),o=16-(a-n);if(n=a,o>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(25),o=n(26),i=n(36),s=n(19);e.exports=function(e,t,n){if(!s(n))return!1;var c=r(t);return!!("number"==c?o(n)&&i(t,n.length):"string"==c&&t in n)&&a(n[t],e)}},function(e,t,n){"use strict";var r=n(187);e.exports=function(e,t){return!!(null==e?0:e.length)&&r(e,t,0)>-1}},function(e,t,n){"use strict";var r=n(68),a=n(188),o=n(189);e.exports=function(e,t,n){return t==t?o(e,t,n):r(e,a,n)}},function(e,t,n){"use strict";e.exports=function(e){return e!=e}},function(e,t,n){"use strict";e.exports=function(e,t,n){for(var r=n-1,a=e.length;++r<a;)if(e[r]===t)return r;return-1}},function(e,t,n){"use strict";e.exports=function(e,t,n){for(var r=-1,a=null==e?0:e.length;++r<a;)if(n(t,e[r]))return!0;return!1}},function(e,t,n){"use strict";var r=n(65),a=n(192),o=n(44),i=r&&1/o(new r([,-0]))[1]==1/0?function(e){return new r(e)}:a;e.exports=i},function(e,t,n){"use strict";e.exports=function(){}},function(e,t,n){"use strict";(function(e,t){!function(e,n){if(!e.setImmediate){var r,a,o,i,s,c=1,u={},l=!1,f=e.document,p=Object.getPrototypeOf&&Object.getPrototypeOf(e);p=p&&p.setTimeout?p:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick((function(){h(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((o=new MessageChannel).port1.onmessage=function(e){h(e.data)},r=function(e){o.port2.postMessage(e)}):f&&"onreadystatechange"in f.createElement("script")?(a=f.documentElement,r=function(e){var t=f.createElement("script");t.onreadystatechange=function(){h(e),t.onreadystatechange=null,a.removeChild(t),t=null},a.appendChild(t)}):r=function(e){setTimeout(h,0,e)}:(i="setImmediate$"+Math.random()+"$",s=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(i)&&h(+t.data.slice(i.length))},e.addEventListener?e.addEventListener("message",s,!1):e.attachEvent("onmessage",s),r=function(t){e.postMessage(i+t,"*")}),p.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var a={callback:e,args:t};return u[c]=a,r(c),c++},p.clearImmediate=y}function y(e){delete u[e]}function h(e){if(l)setTimeout(h,0,e);else{var t=u[e];if(t){l=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(void 0,n)}}(t)}finally{y(e),l=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(30),n(194))},function(e,t,n){"use strict";var r,a,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function c(e){if(r===setTimeout)return setTimeout(e,0);if((r===i||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:i}catch(e){r=i}try{a="function"==typeof clearTimeout?clearTimeout:s}catch(e){a=s}}();var u,l=[],f=!1,p=-1;function y(){f&&u&&(f=!1,u.length?l=u.concat(l):p=-1,l.length&&h())}function h(){if(!f){var e=c(y);f=!0;for(var t=l.length;t;){for(u=l,l=[];++p<t;)u&&u[p].run();p=-1,t=l.length}u=null,f=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===s||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function v(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new d(e,t)),1!==l.length||f||c(h)},d.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=v,o.addListener=v,o.once=v,o.off=v,o.removeListener=v,o.removeAllListeners=v,o.emit=v,o.prependListener=v,o.prependOnceListener=v,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t),n.d(t,"SNApplication",(function(){return of})),n.d(t,"SNProtocolService",(function(){return Ts})),n.d(t,"KeyMode",(function(){return ms})),n.d(t,"SNProtocolOperator001",(function(){return Vi})),n.d(t,"SNProtocolOperator002",(function(){return Qi})),n.d(t,"SNProtocolOperator003",(function(){return is})),n.d(t,"SNProtocolOperator004",(function(){return bs})),n.d(t,"DeviceInterface",(function(){return uf})),n.d(t,"SNItem",(function(){return d.d})),n.d(t,"ItemMutator",(function(){return d.b})),n.d(t,"AppDataField",(function(){return d.a})),n.d(t,"SNItemsKey",(function(){return Mt})),n.d(t,"SNPredicate",(function(){return D.a})),n.d(t,"SNNote",(function(){return wt})),n.d(t,"NoteMutator",(function(){return kt})),n.d(t,"SNTag",(function(){return nt})),n.d(t,"SNSmartTag",(function(){return ut})),n.d(t,"SNActionsExtension",(function(){return ze})),n.d(t,"Action",(function(){return Te})),n.d(t,"SNTheme",(function(){return Oe})),n.d(t,"SNComponent",(function(){return pe})),n.d(t,"ComponentAction",(function(){return X})),n.d(t,"ComponentMutator",(function(){return ye})),n.d(t,"SNEditor",(function(){return Ee})),n.d(t,"SNUserPrefs",(function(){return V})),n.d(t,"UserPrefsMutator",(function(){return N})),n.d(t,"WebPrefKey",(function(){return x})),n.d(t,"MutationType",(function(){return d.c})),n.d(t,"ComponentArea",(function(){return Y})),n.d(t,"LiveItem",(function(){return pf})),n.d(t,"SNComponentManager",(function(){return Mr})),n.d(t,"HistorySession",(function(){return Xs})),n.d(t,"ItemHistory",(function(){return Qs})),n.d(t,"ItemHistoryEntry",(function(){return Fs})),n.d(t,"SNPrivileges",(function(){return Z})),n.d(t,"ProtectedAction",(function(){return F})),n.d(t,"PrivilegeCredential",(function(){return L})),n.d(t,"PayloadManager",(function(){return Ga})),n.d(t,"ItemManager",(function(){return Xc})),n.d(t,"SNHttpService",(function(){return $n})),n.d(t,"ChallengeService",(function(){return Gl})),n.d(t,"PureService",(function(){return Jt.a})),n.d(t,"ApplicationService",(function(){return yf.a})),n.d(t,"SNStorageService",(function(){return sn})),n.d(t,"StoragePersistencePolicies",(function(){return Wt})),n.d(t,"StorageEncryptionPolicies",(function(){return Bt})),n.d(t,"StorageValueModes",(function(){return Ht})),n.d(t,"ValueModesKeys",(function(){return zt})),n.d(t,"Challenge",(function(){return g})),n.d(t,"ChallengeReason",(function(){return y})),n.d(t,"ChallengeResponse",(function(){return k})),n.d(t,"ChallengeType",(function(){return p})),n.d(t,"challengeTypeToString",(function(){return S})),n.d(t,"ChallengeValue",(function(){return w})),n.d(t,"SNSyncService",(function(){return Ml})),n.d(t,"SyncSources",(function(){return Al})),n.d(t,"SyncModes",(function(){return El})),n.d(t,"SyncQueueStrategy",(function(){return Rl})),n.d(t,"SortPayloadsByRecentAndContentPriority",(function(){return Zc})),n.d(t,"SNSessionManager",(function(){return Ln})),n.d(t,"SNMigrationService",(function(){return mi})),n.d(t,"SNAlertService",(function(){return mn})),n.d(t,"SNHistoryManager",(function(){return yc})),n.d(t,"SNPrivilegesService",(function(){return _c})),n.d(t,"SNSingletonManager",(function(){return so})),n.d(t,"SNApiService",(function(){return lr})),n.d(t,"Copy",(function(){return u.a})),n.d(t,"findInArray",(function(){return u.l})),n.d(t,"isNullOrUndefined",(function(){return u.p})),n.d(t,"deepMerge",(function(){return u.h})),n.d(t,"extendArray",(function(){return u.j})),n.d(t,"removeFromIndex",(function(){return u.C})),n.d(t,"subtractFromArray",(function(){return u.G})),n.d(t,"arrayByDifference",(function(){return u.c})),n.d(t,"uniqCombineObjArrays",(function(){return u.J})),n.d(t,"greaterOfTwoDates",(function(){return u.n})),n.d(t,"getGlobalScope",(function(){return u.m})),n.d(t,"removeFromArray",(function(){return u.B})),n.d(t,"addIfUnique",(function(){return u.b})),n.d(t,"dictToArray",(function(){return u.i})),n.d(t,"truncateHexString",(function(){return u.I})),n.d(t,"jsonParseEmbeddedKeys",(function(){return u.v})),n.d(t,"topLevelCompare",(function(){return u.H})),n.d(t,"Uuid",(function(){return h})),n.d(t,"EncryptionIntent",(function(){return qt.a})),n.d(t,"isLocalStorageIntent",(function(){return qt.e})),n.d(t,"isFileIntent",(function(){return qt.d})),n.d(t,"isDecryptedIntent",(function(){return qt.c})),n.d(t,"intentRequiresEncryption",(function(){return qt.b})),n.d(t,"ContentType",(function(){return O.a})),n.d(t,"CreateItemFromPayload",(function(){return Nt})),n.d(t,"Uuids",(function(){return s.b})),n.d(t,"FillItemContent",(function(){return s.a})),n.d(t,"ApplicationEvent",(function(){return c.a})),n.d(t,"Environment",(function(){return cr})),n.d(t,"Platform",(function(){return ur})),n.d(t,"isEnvironmentWebOrDesktop",(function(){return gr})),n.d(t,"isEnvironmentMobile",(function(){return wr})),n.d(t,"platformFromString",(function(){return br})),n.d(t,"SyncEvent",(function(){return $a.a})),n.d(t,"MutableCollection",(function(){return Jr})),n.d(t,"ImmutablePayloadCollection",(function(){return ta})),n.d(t,"ItemCollection",(function(){return Nc})),n.d(t,"CollectionSort",(function(){return jc})),n.d(t,"CreateMaxPayloadFromAnyObject",(function(){return P.e})),n.d(t,"CreateSourcedPayloadFromObject",(function(){return P.f})),n.d(t,"CreateIntentPayloadFromObject",(function(){return P.d})),n.d(t,"CreateEncryptionParameters",(function(){return P.c})),n.d(t,"PayloadByMerging",(function(){return P.g})),n.d(t,"CopyPayload",(function(){return P.b})),n.d(t,"PayloadSource",(function(){return j.a})),n.d(t,"isPayloadSourceRetrieved",(function(){return j.b})),n.d(t,"ProtocolVersion",(function(){return St.a})),n.d(t,"PayloadFormat",(function(){return lt.a})),n.d(t,"PurePayload",(function(){return hf.a})),n.d(t,"PayloadField",(function(){return ma.a})),n.d(t,"StorageKey",(function(){return Lt})),n.d(t,"BaseMigration",(function(){return oi})),n.d(t,"PrivilegeSessionLength",(function(){return pc}));var r={};n.r(r),n.d(r,"Migration20200115",(function(){return $o}));var a,o=n(0),i=n.n(o),s=n(11);!function(e){e[e.PreparingForLaunch_0=0]="PreparingForLaunch_0",e[e.ReadyForLaunch_05=.5]="ReadyForLaunch_05",e[e.StorageDecrypted_09=.9]="StorageDecrypted_09",e[e.Launched_10=1]="Launched_10",e[e.LoadingDatabase_11=1.1]="LoadingDatabase_11",e[e.LoadedDatabase_12=1.2]="LoadedDatabase_12",e[e.FullSyncCompleted_13=1.3]="FullSyncCompleted_13",e[e.SignedIn_30=3]="SignedIn_30"}(a||(a={}));var c=n(13),u=n(1);function l(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var p,y,h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r,a,o;return t=e,n=null,r=[{key:"SetGenerators",value:function(e,t){this.syncUuidFunc=t,this.asyncUuidFunc=e}},{key:"canGenSync",value:function(){return!Object(u.p)(this.syncUuidFunc)}},{key:"GenerateUuid",value:(a=i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.syncUuidFunc){e.next=4;break}return e.abrupt("return",this.syncUuidFunc());case 4:return e.abrupt("return",this.asyncUuidFunc());case 5:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){l(o,n,r,i,s,"next",e)}function s(e){l(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})},{key:"GenerateUuidSynchronously",value:function(){return this.syncUuidFunc()}}],n&&f(t.prototype,n),r&&f(t,r),e}(),d=n(6);function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){e[e.LocalPasscode=1]="LocalPasscode",e[e.AccountPassword=2]="AccountPassword",e[e.Biometric=3]="Biometric"}(p||(p={})),function(e){e[e.ApplicationUnlock=1]="ApplicationUnlock",e[e.ResaveRootKey=2]="ResaveRootKey",e[e.ProtocolUpgrade=3]="ProtocolUpgrade",e[e.Migration=4]="Migration"}(y||(y={}));var g=function e(t,n){b(this,e),this.types=t,this.reason=n,this.id=(new Date).getTime(),Object.freeze(this)},w=function e(t,n){b(this,e),this.type=t,this.value=n,Object.freeze(this)},k=function(){function e(t,n,r){b(this,e),this.challenge=t,this.values=n,this.artifacts=r,Object.freeze(this)}var t,n,r;return t=e,(n=[{key:"getValueForType",value:function(e){return this.values.find((function(t){return t.type===e}))}}])&&m(t.prototype,n),r&&m(t,r),e}();function S(e){var t;return(v(t={},p.LocalPasscode,"application passcode"),v(t,p.AccountPassword,"account password"),v(t,p.Biometric,"biometrics"),t)[e]}var x,O=n(4),P=n(2),j=n(3),D=n(15);function C(e){return(C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function I(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function R(e,t,n){return t&&I(e.prototype,t),n&&I(e,n),e}function E(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&A(e,t)}function A(e,t){return(A=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function M(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=K(e);if(t){var a=K(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return T(this,n)}}function T(e,t){return!t||"object"!==C(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function K(e){return(K=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.TagsPanelWidth="tagsPanelWidth",e.NotesPanelWidth="notesPanelWidth",e.EditorWidth="editorWidth",e.EditorLeft="editorLeft",e.EditorMonospaceEnabled="monospaceFont",e.EditorSpellcheck="spellcheck",e.EditorResizersEnabled="marginResizersEnabled",e.SortNotesBy="sortBy",e.SortNotesReverse="sortReverse",e.NotesShowArchived="showArchived",e.NotesHidePinned="hidePinned",e.NotesHideNotePreview="hideNotePreview",e.NotesHideDate="hideDate"}(x||(x={}));var F,L,V=function(e){E(n,e);var t=M(n);function n(){return _(this,n),t.apply(this,arguments)}return R(n,[{key:"getPref",value:function(e){return this.getAppDomainValue(e)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new D.a("content_type","=",this.content_type)}}]),n}(d.d),N=function(e){E(n,e);var t=M(n);function n(){return _(this,n),t.apply(this,arguments)}return R(n,[{key:"setWebPref",value:function(e,t){this.setAppDataItem(e,t)}}]),n}(d.b);function U(e){return(U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function W(e,t,n){return(W="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Q(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function B(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function z(e,t,n){return t&&H(e.prototype,t),n&&H(e,n),e}function q(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&J(e,t)}function J(e,t){return(J=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function G(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Q(e);if(t){var a=Q(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return $(this,n)}}function $(e,t){return!t||"object"!==U(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Q(e){return(Q=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.ManageExtensions="ActionManageExtensions",e.ManageBackups="ActionManageBackups",e.ViewProtectedNotes="ActionViewProtectedNotes",e.ManagePrivileges="ActionManagePrivileges",e.ManagePasscode="ActionManagePasscode",e.DeleteNote="ActionDeleteNote"}(F||(F={})),function(e){e.AccountPassword="CredentialAccountPassword",e.LocalPasscode="CredentialLocalPasscode"}(L||(L={}));var Y,X,Z=function(e){q(n,e);var t=G(n);function n(e){var r;return B(this,n),(r=t.call(this,e)).privilegeMap={},r.privilegeMap=e.safeContent.desktopPrivileges||{},r}return z(n,[{key:"getCredentialsForAction",value:function(e){return this.privilegeMap[e]||[]}},{key:"isCredentialRequiredForAction",value:function(e,t){return this.getCredentialsForAction(e).includes(t)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new D.a("content_type","=",this.content_type)}}]),n}(d.d),ee=function(e){q(n,e);var t=G(n);function n(e,r){var a;return B(this,n),(a=t.call(this,e,r)).privilegeMap={},a.privileges=e,a.privilegeMap=Object(u.a)(a.payload.safeContent.desktopPrivileges||{}),a}return z(n,[{key:"getResult",value:function(){return this.content&&(this.content.desktopPrivileges=this.privilegeMap),W(Q(n.prototype),"getResult",this).call(this)}},{key:"setCredentialsForAction",value:function(e,t){this.privilegeMap[e]=t}},{key:"toggleCredentialForAction",value:function(e,t){this.privileges.isCredentialRequiredForAction(e,t)?this.removeCredentialForAction(e,t):this.addCredentialForAction(e,t)}},{key:"removeCredentialForAction",value:function(e,t){Object(u.B)(this.privilegeMap[e],t)}},{key:"addCredentialForAction",value:function(e,t){var n=this.privileges.getCredentialsForAction(e).slice();n.push(t),this.setCredentialsForAction(e,n)}}]),n}(d.b),te=n(14);function ne(e){return(ne="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function re(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ae(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oe(e,t,n){return t&&ae(e.prototype,t),n&&ae(e,n),e}function ie(e,t,n){return(ie="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=fe(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function se(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ce(e,t)}function ce(e,t){return(ce=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ue(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=fe(e);if(t){var a=fe(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return le(this,n)}}function le(e,t){return!t||"object"!==ne(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function fe(e){return(fe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.Editor="editor-editor",e.Themes="themes",e.TagsList="tags-list",e.EditorStack="editor-stack",e.NoteTags="note-tags",e.Rooms="rooms",e.Modal="modal",e.Any="*"}(Y||(Y={})),function(e){e.SetSize="set-size",e.StreamItems="stream-items",e.StreamContextItem="stream-context-item",e.SaveItems="save-items",e.SelectItem="select-item",e.AssociateItem="associate-item",e.DeassociateItem="deassociate-item",e.ClearSelection="clear-selection",e.CreateItem="create-item",e.CreateItems="create-items",e.DeleteItems="delete-items",e.SetComponentData="set-component-data",e.InstallLocalComponent="install-local-component",e.ToggleActivateComponent="toggle-activate-component",e.RequestPermissions="request-permissions",e.PresentConflictResolution="present-conflict-resolution",e.DuplicateItem="duplicate-item",e.ComponentRegistered="component-registered",e.ActivateThemes="themes",e.Reply="reply",e.SaveSuccess="save-success",e.SaveError="save-error"}(X||(X={}));var pe=function(e){se(n,e);var t=ue(n);function n(e){var r;return re(this,n),(r=t.call(this,e)).permissions=[],r.componentData=r.payload.safeContent.componentData||{},r.legacy_url=r.payload.safeContent.legacy_url,r.hosted_url=r.payload.safeContent.hosted_url||r.payload.safeContent.url,r.local_url=r.payload.safeContent.local_url,r.valid_until=new Date(r.payload.safeContent.valid_until),r.offlineOnly=r.payload.safeContent.offlineOnly,r.name=r.payload.safeContent.name,r.area=r.payload.safeContent.area,r.package_info=r.payload.safeContent.package_info,r.permissions=r.payload.safeContent.permissions||[],r.active=r.payload.safeContent.active,r.autoupdateDisabled=r.payload.safeContent.autoupdateDisabled,r.disassociatedItemIds=r.payload.safeContent.disassociatedItemIds||[],r.associatedItemIds=r.payload.safeContent.associatedItemIds||[],r.isMobileDefault=r.payload.safeContent.isMobileDefault,r.legacy_url=r.payload.safeContent.hosted_url?void 0:r.payload.safeContent.url,r}return oe(n,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?ie(fe(n.prototype),"strategyWhenConflictingWithItem",this).call(this,e):te.a.KeepLeft}},{key:"isEditor",value:function(){return this.area===Y.Editor}},{key:"isTheme",value:function(){return this.content_type===O.a.Theme||this.area===Y.Themes}},{key:"isDefaultEditor",value:function(){return!0===this.getAppDomainValue(d.a.DefaultEditor)}},{key:"getLastSize",value:function(){return this.getAppDomainValue(d.a.LastSize)}},{key:"acceptsThemes",value:function(){var e;return null===(e=this.payload.safeContent.package_info)||void 0===e?void 0:e.acceptsThemes}},{key:"getClientDataKey",value:function(){return this.legacy_url?this.legacy_url:this.uuid}},{key:"hasValidHostedUrl",value:function(){return this.hosted_url||this.legacy_url}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["active","disassociatedItemIds","associatedItemIds"].concat(ie(fe(n.prototype),"contentKeysToIgnoreWhenCheckingEquality",this).call(this))}},{key:"isAssociative",value:function(){return n.associativeAreas().includes(this.area)}},{key:"isExplicitlyEnabledForItem",value:function(e){return-1!==this.associatedItemIds.indexOf(e)}},{key:"isExplicitlyDisabledForItem",value:function(e){return-1!==this.disassociatedItemIds.indexOf(e)}}],[{key:"associativeAreas",value:function(){return[Y.Editor]}}]),n}(d.d),ye=function(e){se(n,e);var t=ue(n);function n(){return re(this,n),t.apply(this,arguments)}return oe(n,[{key:"associateWithItem",value:function(e){var t=this.typedContent.associatedItemIds||[];Object(u.b)(t,e),this.typedContent.associatedItemIds=t}},{key:"disassociateWithItem",value:function(e){var t=this.typedContent.disassociatedItemIds||[];Object(u.b)(t,e),this.typedContent.disassociatedItemIds=t}},{key:"removeAssociatedItemId",value:function(e){Object(u.B)(this.typedContent.associatedItemIds||[],e)}},{key:"removeDisassociatedItemId",value:function(e){Object(u.B)(this.typedContent.disassociatedItemIds||[],e)}},{key:"setLastSize",value:function(e){this.setAppDataItem(d.a.LastSize,e)}},{key:"typedContent",get:function(){return this.content}},{key:"active",set:function(e){this.typedContent.active=e}},{key:"defaultEditor",set:function(e){this.setAppDataItem(d.a.DefaultEditor,e)}},{key:"componentData",set:function(e){this.typedContent.componentData=e}},{key:"package_info",set:function(e){this.typedContent.package_info=e}},{key:"local_url",set:function(e){this.typedContent.local_url=e}},{key:"hosted_url",set:function(e){this.typedContent.hosted_url=e}},{key:"permissions",set:function(e){this.typedContent.permissions=e}}]),n}(d.b);function he(e){return(he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function de(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ve(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function me(e,t,n){return t&&ve(e.prototype,t),n&&ve(e,n),e}function be(e,t,n){return(be="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=xe(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ge(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&we(e,t)}function we(e,t){return(we=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ke(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=xe(e);if(t){var a=xe(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Se(this,n)}}function Se(e,t){return!t||"object"!==he(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function xe(e){return(xe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Oe=function(e){ge(n,e);var t=ke(n);function n(){var e;return de(this,n),(e=t.apply(this,arguments)).area=Y.Themes,e}return me(n,[{key:"isLayerable",value:function(){return this.package_info&&this.package_info.layerable}},{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?be(xe(n.prototype),"strategyWhenConflictingWithItem",this).call(this,e):te.a.KeepLeft}},{key:"getMobileRules",value:function(){return this.getAppDomainValue(d.a.MobileRules)||{constants:{},rules:{}}}},{key:"hasMobileRules",value:function(){return this.getAppDomainValue(d.a.MobileRules)}},{key:"getNotAvailOnMobile",value:function(){return this.getAppDomainValue(d.a.NotAvailableOnMobile)}},{key:"isMobileActive",value:function(){return this.getAppDomainValue(d.a.MobileActive)}}]),n}(pe);d.b;function Pe(e){return(Pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function je(e,t){return(je=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function De(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=_e(e);if(t){var a=_e(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ce(this,n)}}function Ce(e,t){return!t||"object"!==Pe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _e(e){return(_e=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ie,Re,Ee=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&je(e,t)}(n,e);var t=De(n);function n(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),(r=t.call(this,e)).notes=[],r.data={},r.url=e.safeContent.url,r.name=e.safeContent.name,r.data=e.safeContent.data||{},r.isDefault=e.safeContent.default,r.systemEditor=e.safeContent.systemEditor,r}return n}(d.d),Ae=n(38),Me=n.n(Ae);!function(e){e.Encrypted="encrypted",e.Decrypted="decrypted"}(Ie||(Ie={})),function(e){e.Get="get",e.Render="render",e.Show="show",e.Post="post",e.Nested="nested"}(Re||(Re={}));var Te=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Me()(this,t),this.running=t.running||!1,this.error=t.error||!1,this.lastExecuted&&(this.lastExecuted=new Date(this.lastExecuted))};function Ke(e){return(Ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Fe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Le(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ve(e,t,n){return t&&Le(e.prototype,t),n&&Le(e,n),e}function Ne(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ue(e,t)}function Ue(e,t){return(Ue=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function We(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=He(e);if(t){var a=He(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Be(this,n)}}function Be(e,t){return!t||"object"!==Ke(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function He(e){return(He=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ze=function(e){Ne(n,e);var t=We(n);function n(e){var r;return Fe(this,n),(r=t.call(this,e)).actions=[],r.description=e.safeContent.description,r.url=e.safeContent.url,r.name=e.safeContent.name,r.package_info=e.safeContent.package_info,r.supported_types=e.safeContent.supported_types,r.hidden=e.safeContent.hidden,e.safeContent.actions&&(r.actions=e.safeContent.actions.map((function(e){return new Te(e)}))),r}return Ve(n,[{key:"actionsWithContextForItem",value:function(e){return this.actions.filter((function(t){return t.context===e.content_type||"Item"===t.context}))}}]),n}(d.d),qe=function(e){Ne(n,e);var t=We(n);function n(){return Fe(this,n),t.apply(this,arguments)}return Ve(n,[{key:"description",set:function(e){this.content.description=e}},{key:"supported_types",set:function(e){this.content.supported_types=e}},{key:"actions",set:function(e){this.content.actions=e}},{key:"hidden",set:function(e){this.content.hidden=e}}]),n}(d.b);function Je(e){return(Je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ge(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function $e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Qe(e,t,n){return t&&$e(e.prototype,t),n&&$e(e,n),e}function Ye(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Xe(e,t)}function Xe(e,t){return(Xe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ze(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=tt(e);if(t){var a=tt(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return et(this,n)}}function et(e,t){return!t||"object"!==Je(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function tt(e){return(tt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var nt=function(e){Ye(n,e);var t=Ze(n);function n(e){var r;return Ge(this,n),(r=t.call(this,e)).title=r.payload.safeContent.title,r}return Qe(n,[{key:"isSmartTag",value:function(){return this.content_type===O.a.SmartTag}},{key:"noteCount",get:function(){return this.payload.safeReferences.length}},{key:"isAllTag",get:function(){return this.payload.safeContent.isAllTag}},{key:"isTrashTag",get:function(){return this.payload.safeContent.isTrashTag}},{key:"isArchiveTag",get:function(){return this.payload.safeContent.isArchiveTag}}],[{key:"arrayToDisplayString",value:function(e){return e.sort((function(e,t){return e.title>t.title?1:-1})).map((function(e){return"#"+e.title})).join(" ")}}]),n}(d.d),rt=function(e){Ye(n,e);var t=Ze(n);function n(){return Ge(this,n),t.apply(this,arguments)}return Qe(n,[{key:"title",set:function(e){this.content.title=e}}]),n}(d.b);function at(e){return(at="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ot(e,t){return(ot=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function it(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ct(e);if(t){var a=ct(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return st(this,n)}}function st(e,t){return!t||"object"!==at(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ct(e){return(ct=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ut=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ot(e,t)}(n,e);var t=it(n);function n(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),r=t.call(this,e),e.safeContent.predicate&&(r.predicate=D.a.FromJson(e.safeContent.predicate)),r}return n}(nt),lt=n(10);function ft(e){return(ft="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function pt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function yt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ht(e,t,n){return t&&yt(e.prototype,t),n&&yt(e,n),e}function dt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&vt(e,t)}function vt(e,t){return(vt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function mt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=gt(e);if(t){var a=gt(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return bt(this,n)}}function bt(e,t){return!t||"object"!==ft(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function gt(e){return(gt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var wt=function(e){dt(n,e);var t=mt(n);function n(e){var r;return pt(this,n),(r=t.call(this,e)).text="",r.hidePreview=!1,r.title=r.payload.safeContent.title,r.text=r.payload.safeContent.text,r.preview_plain=r.payload.safeContent.preview_plain,r.preview_html=r.payload.safeContent.preview_html,r.hidePreview=r.payload.safeContent.hidePreview,e.format===lt.a.DecryptedBareObject&&(r.prefersPlainEditor=r.getAppDomainValue(d.a.PrefersPlainEditor)),Object(u.p)(r.payload.safeContent.mobilePrefersPlainEditor)||(r.mobilePrefersPlainEditor=r.payload.safeContent.mobilePrefersPlainEditor),r}return ht(n,[{key:"safeText",value:function(){return this.text||""}},{key:"safeTitle",value:function(){return this.title||""}}]),n}(d.d),kt=function(e){dt(n,e);var t=mt(n);function n(){return pt(this,n),t.apply(this,arguments)}return ht(n,[{key:"typedContent",get:function(){return this.content}},{key:"title",set:function(e){this.typedContent.title=e}},{key:"text",set:function(e){this.typedContent.text=e}},{key:"hidePreview",set:function(e){this.typedContent.hidePreview=e}},{key:"preview_plain",set:function(e){this.typedContent.preview_plain=e}},{key:"preview_html",set:function(e){this.typedContent.preview_html=e}},{key:"prefersPlainEditor",set:function(e){this.setAppDataItem(d.a.PrefersPlainEditor,e)}}]),n}(d.b),St=n(7);function xt(e){return(xt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ot(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Pt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function jt(e,t,n){return t&&Pt(e.prototype,t),n&&Pt(e,n),e}function Dt(e,t,n){return(Dt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Et(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ct(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_t(e,t)}function _t(e,t){return(_t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function It(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Et(e);if(t){var a=Et(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Rt(this,n)}}function Rt(e,t){return!t||"object"!==xt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Et(e){return(Et=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var At,Mt=function(e){Ct(n,e);var t=It(n);function n(){return Ot(this,n),t.apply(this,arguments)}return jt(n,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?Dt(Et(n.prototype),"strategyWhenConflictingWithItem",this).call(this,e):te.a.KeepLeft}},{key:"version",get:function(){return this.payload.safeContent.version}},{key:"isItemsKey",get:function(){return!0}},{key:"isDefault",get:function(){return this.payload.safeContent.isDefault}},{key:"itemsKey",get:function(){return this.payload.safeContent.itemsKey}},{key:"dataAuthenticationKey",get:function(){if(this.version===St.a.V004)throw"Attempting to access legacy data authentication key.";return this.payload.safeContent.dataAuthenticationKey}}]),n}(d.d),Tt=function(e){Ct(n,e);var t=It(n);function n(){return Ot(this,n),t.apply(this,arguments)}return jt(n,[{key:"isDefault",set:function(e){this.content.isDefault=e}}]),n}(d.b);function Kt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ft,Lt,Vt=(Kt(At={},O.a.Note,wt),Kt(At,O.a.Tag,nt),Kt(At,O.a.ItemsKey,Mt),Kt(At,O.a.SmartTag,ut),Kt(At,O.a.ActionsExtension,ze),Kt(At,O.a.Editor,Ee),Kt(At,O.a.Theme,Oe),Kt(At,O.a.Component,pe),Kt(At,O.a.Privileges,Z),Kt(At,O.a.UserPrefs,V),At);function Nt(e){return new(Vt[e.content_type]||d.d)(e)}function Ut(e,t){return e?"".concat(e,"-").concat(t):t}!function(e){e.StorageObject="storage",e.LastMigrationTimestamp="last_migration_timestamp"}(Ft||(Ft={})),function(e){e.RootKeyParams="ROOT_KEY_PARAMS",e.WrappedRootKey="WRAPPED_ROOT_KEY",e.RootKeyWrapperKeyParams="ROOT_KEY_WRAPPER_KEY_PARAMS",e.Session="session",e.User="user",e.ServerHost="server",e.LegacyUuid="uuid",e.LastSyncToken="syncToken",e.PaginationToken="cursorToken",e.BiometricsState="biometrics_state",e.MobilePasscodeTiming="passcode_timing",e.MobileBiometricsTiming="biometrics_timing",e.PrivilegesExpirey="SessionExpiresAtKey",e.PrivilegesSessionLength="SessionLengthKey",e.SessionHistoryPersistable="sessionHistory_persist",e.SessionHistoryRevisions="sessionHistory_revisions",e.SessionHistoryOptimize="sessionHistory_autoOptimize"}(Lt||(Lt={}));var Wt,Bt,Ht,zt,qt=n(9),Jt=n(12);function Gt(e){return(Gt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function $t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Qt(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Yt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Yt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Yt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Xt(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Zt(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Xt(o,r,a,i,s,"next",e)}function s(e){Xt(o,r,a,i,s,"throw",e)}i(void 0)}))}}function en(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function tn(e,t,n){return(tn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=on(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function nn(e,t){return(nn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function rn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=on(e);if(t){var a=on(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return an(this,n)}}function an(e,t){return!t||"object"!==Gt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function on(e){return(on=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.Default=1]="Default",e[e.Ephemeral=2]="Ephemeral"}(Wt||(Wt={})),function(e){e[e.Default=1]="Default",e[e.Disabled=2]="Disabled"}(Bt||(Bt={})),function(e){e[e.Default=1]="Default",e[e.Nonwrapped=2]="Nonwrapped"}(Ht||(Ht={})),function(e){e.Wrapped="wrapped",e.Unwrapped="unwrapped",e.Nonwrapped="nonwrapped"}(zt||(zt={}));var sn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&nn(e,t)}(E,e);var t,n,r,o,s,c,l,f,p,y,d,v,m,b,g,w,k,S,x,j,D,C,_,I,R=rn(E);function E(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,E),(n=R.call(this)).storagePersistable=!1,n.deviceInterface=e,n.namespace=t,n.setPersistencePolicy(Wt.Default),n.setEncryptionPolicy(Bt.Default),n}return t=E,n=[{key:"deinit",value:function(){this.deviceInterface=void 0,this.encryptionDelegate=void 0,tn(on(E.prototype),"deinit",this).call(this)}},{key:"handleApplicationStage",value:(I=Zt(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,tn(on(E.prototype),"handleApplicationStage",this).call(this,t);case 2:t===a.Launched_10&&(this.storagePersistable=!0);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"setPersistencePolicy",value:(_=Zt(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy=t,this.persistencePolicy!==Wt.Ephemeral){e.next=6;break}return e.next=4,this.deviceInterface.removeAllRawStorageValues();case 4:return e.next=6,this.clearAllPayloads();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"setEncryptionPolicy",value:(C=Zt(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.encryptionPolicy=t;case 1:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.persistencePolicy===Wt.Ephemeral}},{key:"initializeFromDisk",value:(D=Zt(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getRawStorageValue(this.getPersistenceKey());case 2:t=e.sent,n=t?JSON.parse(t):void 0,this.setInitialValues(n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"setInitialValues",value:function(e){e||(e=this.defaultValuesObject()),e[zt.Unwrapped]||(e[zt.Unwrapped]={}),this.values=e}},{key:"isStorageWrapped",value:function(){var e=this.values[zt.Wrapped];return!Object(u.p)(e)&&Object.keys(e).length>0}},{key:"canDecryptWithKey",value:(j=Zt(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.values[zt.Wrapped],e.next=3,this.decryptWrappedValue(n,t);case 3:return r=e.sent,e.abrupt("return",!r.errorDecrypting);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return j.apply(this,arguments)})},{key:"decryptWrappedValue",value:(x=Zt(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==t?void 0:t.content_type){e.next=2;break}throw Error("Attempting to decrypt nonexistent wrapped value");case 2:return r=Object(P.e)(t,{content_type:O.a.EncryptedStorage}),e.next=5,this.encryptionDelegate.payloadByDecryptingPayload(r,n);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return x.apply(this,arguments)})},{key:"decryptStorage",value:(S=Zt(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.values[zt.Wrapped],e.next=3,this.decryptWrappedValue(t);case 3:if(!(n=e.sent).errorDecrypting){e.next=6;break}throw Error("Unable to decrypt storage.");case 6:this.values[zt.Unwrapped]=Object(u.a)(n.contentObject);case 7:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"persistValuesToDisk",value:(k=Zt(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storagePersistable){e.next=2;break}return e.abrupt("return");case 2:if(this.persistencePolicy!==Wt.Ephemeral){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,this.immediatelyPersistValuesToDisk();case 6:t=e.sent,this.values[zt.Wrapped]=t[zt.Wrapped];case 8:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"immediatelyPersistValuesToDisk",value:(w=Zt(i.a.mark((function e(){var t=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(Zt(i.a.mark((function e(){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.generatePersistableValues();case 2:return n=e.sent,e.next=5,t.deviceInterface.setRawStorageValue(t.getPersistenceKey(),JSON.stringify(n));case 5:return e.abrupt("return",n);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"generatePersistableValues",value:(g=Zt(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object.assign({},this.values),n=t[zt.Unwrapped],e.t0=P.e,e.next=5,h.GenerateUuid();case 5:return e.t1=e.sent,e.t2=n,e.t3=O.a.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},r=(0,e.t0)(e.t4),e.next=12,this.encryptionDelegate.payloadByEncryptingPayload(r,qt.a.LocalStoragePreferEncrypted);case 12:return a=e.sent,t[zt.Wrapped]=a.ejected(),t[zt.Unwrapped]=void 0,e.abrupt("return",t);case 16:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"setValue",value:(b=Zt(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>2&&void 0!==a[2]?a[2]:Ht.Default,this.values){e.next=3;break}throw Error("Attempting to set storage key ".concat(t," before loading local storage."));case 3:return this.values[this.domainKeyForMode(r)][t]=n,e.abrupt("return",this.persistValuesToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"getValue",value:(m=Zt(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:Ht.Default,this.values){e.next=3;break}throw Error("Attempting to get storage key ".concat(t," before loading local storage."));case 3:if(this.values[this.domainKeyForMode(n)]){e.next=5;break}throw Error("Storage domain mode not available ".concat(n," for key ").concat(t));case 5:return e.abrupt("return",this.values[this.domainKeyForMode(n)][t]);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"removeValue",value:(v=Zt(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:Ht.Default,this.values){e.next=3;break}throw Error("Attempting to remove storage key ".concat(t," before loading local storage."));case 3:return delete this.values[this.domainKeyForMode(n)][t],e.abrupt("return",this.persistValuesToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"getStorageEncryptionPolicy",value:function(){return this.encryptionPolicy}},{key:"getPersistenceKey",value:function(){return Ut(this.namespace,Ft.StorageObject)}},{key:"defaultValuesObject",value:function(e,t,n){return E.defaultValuesObject(e,t,n)}},{key:"domainKeyForMode",value:function(e){if(e===Ht.Default)return zt.Unwrapped;if(e===Ht.Nonwrapped)return zt.Nonwrapped;throw Error("Invalid mode")}},{key:"clearValues",value:(d=Zt(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setInitialValues(),e.next=3,this.immediatelyPersistValuesToDisk();case 3:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"getAllRawPayloads",value:(y=Zt(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.getAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"savePayload",value:(p=Zt(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.savePayloads([t]));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"savePayloads",value:(f=Zt(i.a.mark((function e(t){var n,r,a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy!==Wt.Ephemeral){e.next=2;break}return e.abrupt("return");case 2:n=[],r=Qt(t),e.prev=4,r.s();case 6:if((a=r.n()).done){e.next=21;break}if(!(o=a.value).discardable){e.next=13;break}return e.next=11,this.deletePayloadWithId(o.uuid);case 11:e.next=19;break;case 13:if(o.uuid){e.next=15;break}throw Error("Attempting to persist payload with no uuid");case 15:return e.next=17,this.encryptionDelegate.payloadByEncryptingPayload(o,this.encryptionPolicy===Bt.Default?qt.a.LocalStoragePreferEncrypted:qt.a.LocalStorageDecrypted);case 17:s=e.sent,n.push(s.ejected());case 19:e.next=6;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(4),r.e(e.t0);case 26:return e.prev=26,r.f(),e.finish(26);case 29:return e.abrupt("return",this.executeCriticalFunction(Zt(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",c.deviceInterface.saveRawDatabasePayloads(n));case 1:case"end":return e.stop()}}),e)})))));case 30:case"end":return e.stop()}}),e,this,[[4,23,26,29]])}))),function(e){return f.apply(this,arguments)})},{key:"deletePayloads",value:(l=Zt(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Qt(t),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return a=r.value,e.next=7,this.deletePayloadWithId(a.uuid);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e){return l.apply(this,arguments)})},{key:"deletePayloadWithId",value:(c=Zt(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(Zt(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.deviceInterface.removeRawDatabasePayloadWithId(t));case 1:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"clearAllPayloads",value:(s=Zt(i.a.mark((function e(){var t=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(Zt(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.deviceInterface.removeAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"clearAllData",value:(o=Zt(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([this.clearValues(),this.clearAllPayloads()]));case 1:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}],r=[{key:"defaultValuesObject",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return $t(e={},zt.Wrapped,t),$t(e,zt.Unwrapped,n),$t(e,zt.Nonwrapped,r),e}}],n&&en(t.prototype,n),r&&en(t,r),E}(Jt.a);function cn(e){return(cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function un(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ln(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){un(o,r,a,i,s,"next",e)}function s(e){un(o,r,a,i,s,"throw",e)}i(void 0)}))}}function fn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function pn(e,t,n){return(pn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=vn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function yn(e,t){return(yn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function hn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=vn(e);if(t){var a=vn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return dn(this,n)}}function dn(e,t){return!t||"object"!==cn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function vn(e){return(vn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var mn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&yn(e,t)}(c,e);var t,n,r,a,o,s=hn(c);function c(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),(t=s.call(this)).deviceInterface=e,t}return t=c,(n=[{key:"deinit",value:function(){this.deviceInterface=void 0,pn(vn(c.prototype),"deinit",this).call(this)}},{key:"alert",value:(o=ln(i.a.mark((function e(t,n){var r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>2&&void 0!==r[2]&&r[2],r.length>3&&r[3],e.abrupt("return",new Promise((function(e,n){window.alert(t),e()})));case 3:case"end":return e.stop()}}),e)}))),function(e,t){return o.apply(this,arguments)})},{key:"confirm",value:(a=ln(i.a.mark((function e(t,n){var r,a,o=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o.length>2&&void 0!==o[2]&&o[2],o.length>3&&void 0!==o[3]&&o[3],r=o.length>4?o[4]:void 0,a=o.length>5?o[5]:void 0,o.length>6&&void 0!==o[6]&&o[6],e.abrupt("return",new Promise((function(e,n){window.confirm(t)?(r&&r(),e()):(a&&a(),n())})));case 6:case"end":return e.stop()}}),e)}))),function(e,t){return a.apply(this,arguments)})}])&&fn(t.prototype,n),r&&fn(t,r),c}(Jt.a);function bn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var gn=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.accessToken=t,this.expireAt=n,this.refreshToken=r,this.validUntil=a}var t,n,r;return t=e,r=[{key:"FromRaw",value:function(t){return new e(t.accessToken,t.expireAt,t.refreshToken,t.validUntil)}},{key:"FromResponse",value:function(t){var n,r,a;return new e(t.token,null===(n=t.session)||void 0===n?void 0:n.expire_at,null===(r=t.session)||void 0===r?void 0:r.refresh_token,null===(a=t.session)||void 0===a?void 0:a.valid_until)}}],(n=[{key:"getExpireAt",value:function(){return this.expireAt||0}},{key:"canExpire",value:function(){return this.getExpireAt()>0}},{key:"isExpired",value:function(){return!!this.canExpire()&&this.getExpireAt()<Date.now()}}])&&bn(t.prototype,n),r&&bn(t,r),e}(),wn="Your account session is being renewed with the server. Please try your request again.",kn="This version of the application does not support your\n                                                      newer account type. Please upgrade to the latest version\n                                                      of Standard Notes to sign in.",Sn="The protocol version associated with your account is\n                                                      outdated and no longer supported by this application.\n                                                      Please visit standardnotes.org/help/security for more\n                                                      information.",xn="The encryption version for your account is outdated and\n                                                      requires upgrade. You may proceed with login, but are\n                                                      advised to perform a security update using the web or\n                                                      desktop application. Please visit\n                                                      standardnotes.org/help/security for more information.",On="Your account was created on a platform with higher security\n                                                      capabilities than this browser supports. If we attempted\n                                                      to generate your login keys here, it would take hours. Please\n                                                      use a browser with more up to date security capabilities,\n                                                      like Google Chrome or Firefox, to log in.",Pn="Unable to login due to insecure password parameters.\n                                                      Please visit standardnotes.org/help/security for\n                                                      more information.";function jn(e){return"\n          Your password must be at least ".concat(e," characters in length.\n          For your security, please choose a longer password or,\n          ideally, a passphrase, and try again.\n         ")}function Dn(e,t){return"\n          Strict Sign In has refused the server's sign-in parameters.\n          The latest account version is ".concat(t,", but the server is reporting a \n          version of ").concat(e," for your account. If you'd like to proceed\n          with sign in anyway, please disable Strict Sign In and try again.\n          ")}function Cn(e){return(Cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _n(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function In(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){_n(o,r,a,i,s,"next",e)}function s(e){_n(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Rn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function En(e,t,n){return(En="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Kn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function An(e,t){return(An=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Mn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Kn(e);if(t){var a=Kn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Tn(this,n)}}function Tn(e,t){return!t||"object"!==Cn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Kn(e){return(Kn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Fn,Ln=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&An(e,t)}(h,e);var t,n,r,a,o,s,c,l,f,p,y=Mn(h);function h(e,t,n,r){var a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),(a=y.call(this)).protocolService=r,a.storageService=e,a.apiService=t,a.alertService=n,a}return t=h,(n=[{key:"deinit",value:function(){this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.alertService=void 0,this.user=void 0,En(Kn(h.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(p=In(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.User);case 2:if(this.user=e.sent,this.user){e.next=8;break}return e.next=6,this.storageService.getValue(Lt.LegacyUuid);case 6:(t=e.sent)&&(this.user={uuid:t});case 8:return e.next=10,this.storageService.getValue(Lt.Session);case 10:if(!(n=e.sent)){e.next=14;break}return e.next=14,this.setSession(gn.FromRaw(n),!1);case 14:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"setSession",value:(f=In(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!(r.length>1&&void 0!==r[1])||r[1],e.next=3,this.apiService.setSession(t,n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"online",value:function(){return!this.offline()}},{key:"offline",value:function(){return Object(u.p)(this.apiService.getSession())}},{key:"getUser",value:function(){return this.user}},{key:"signOut",value:(l=In(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.user=void 0,e.next=3,this.apiService.getSession();case 3:(t=e.sent)&&t.canExpire()&&this.apiService.signOut();case 5:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"register",value:(c=In(i.a.mark((function e(t,n){var r,a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n.length<8)){e.next=2;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(jn(8))});case 2:return e.next=4,this.protocolService.createRootKey(t,n);case 4:return r=e.sent,a=r.key.serverPassword,o=r.keyParams,s=r.key,e.abrupt("return",this.apiService.register(t,a,o).then(function(){var e=In(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:o,rootKey:s});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"signIn",value:(s=In(i.a.mark((function e(t,n){var r,a,o,s,c,u,l,f,p,y,h,d,v=this,m=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=m.length>2&&void 0!==m[2]&&m[2],a=m.length>3?m[3]:void 0,o=m.length>4?m[4]:void 0,e.next=5,this.apiService.getAccountKeyParams(t,a,o);case 5:if(!(s=e.sent).error){e.next=8;break}return e.abrupt("return",{response:s});case 8:if(c={pw_cost:s.pw_cost,pw_nonce:s.pw_nonce,identifier:s.identifier,email:s.email,pw_salt:s.pw_salt,version:s.version},(u=this.protocolService.createKeyParams(c))&&u.version){e.next=12;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 12:if(this.protocolService.supportedVersions().includes(u.version)){e.next=18;break}if(!this.protocolService.isVersionNewerThanLibraryVersion(u.version)){e.next=17;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(kn)});case 17:return e.abrupt("return",{response:this.apiService.createErrorResponse(Sn)});case 18:if(!this.protocolService.isProtocolVersionOutdated(u.version)){e.next=29;break}if(l=this.protocolService.costMinimumForVersion(u.version),!(u.kdfIterations<l)){e.next=22;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(Pn)});case 22:return f=xn,e.next=26,this.alertService.confirm(f,"Update Recommended","Sign In").catch((function(){}));case 26:if(e.sent){e.next=29;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 29:if(this.protocolService.platformSupportsKeyDerivation(u)){e.next=31;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(On)});case 31:if(!r){e.next=35;break}if(p=this.protocolService.getLatestVersion(),u.version===p){e.next=35;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(Dn(u.version,p))});case 35:return e.next=37,this.protocolService.computeRootKey(n,u).then((function(e){return{rootKey:e,serverPassword:e.serverPassword}}));case 37:return y=e.sent,h=y.rootKey,d=y.serverPassword,e.abrupt("return",this.apiService.signIn(t,d,a,o).then(function(){var e=In(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:u,rootKey:h});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 41:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"changePassword",value:(o=In(i.a.mark((function e(t,n,r){var a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.apiService.changePassword(t,n,r);case 2:return a=e.sent,e.next=5,this.handleAuthResponse(a);case 5:return e.abrupt("return",a);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"handleAuthResponse",value:(a=In(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.error){e.next=2;break}return e.abrupt("return");case 2:return n=t.user,this.user=n,e.next=6,this.storageService.setValue(Lt.User,n);case 6:if(!t.token){e.next=10;break}return r=gn.FromResponse(t),e.next=10,this.setSession(r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}])&&Rn(t.prototype,n),r&&Rn(t,r),h}(Jt.a);function Vn(e){return(Vn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Nn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Un(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Nn(o,r,a,i,s,"next",e)}function s(e){Nn(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Wn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Bn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Hn(e,t){return(Hn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function zn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Jn(e);if(t){var a=Jn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return qn(this,n)}}function qn(e,t){return!t||"object"!==Vn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Jn(e){return(Jn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.Get="get",e.Post="post",e.Patch="patch"}(Fn||(Fn={}));var Gn,$n=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Hn(e,t)}(f,e);var t,n,r,a,o,s,c,u,l=zn(f);function f(){return Wn(this,f),l.apply(this,arguments)}return t=f,(n=[{key:"getAbsolute",value:(u=Un(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:Fn.Get,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"postAbsolute",value:(c=Un(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:Fn.Post,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"patchAbsolute",value:(s=Un(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:Fn.Patch,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"runHttp",value:(o=Un(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.createXmlRequest(t),e.abrupt("return",this.runRequest(n,t.verb,t.params));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"createXmlRequest",value:function(e){var t=new XMLHttpRequest;return e.params&&e.verb===Fn.Get&&Object.keys(e.params).length>0&&(e.url=this.urlForUrlAndParams(e.url,e.params)),t.open(e.verb,e.url,!0),t.setRequestHeader("Content-type","application/json"),e.authentication&&t.setRequestHeader("Authorization","Bearer "+e.authentication),t}},{key:"runRequest",value:(a=Un(i.a.mark((function e(t,n,r){var a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,o){t.onreadystatechange=function(){a.stateChangeHandlerForRequest(t,e,o)},n===Fn.Post||n===Fn.Patch?t.send(JSON.stringify(r)):t.send()})));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"stateChangeHandlerForRequest",value:function(e,t,n){if(4===e.readyState){var r=e.status,a={status:r};try{var o=JSON.parse(e.responseText);Object.assign(a,o)}catch(e){}r>=200&&r<=299?t(a):(a.error||(a.error={status:r}),n(a))}}},{key:"urlForUrlAndParams",value:function(e,t){var n=Object.keys(t).map((function(e){return e+"="+encodeURIComponent(t[e])})).join("&");return e.includes("?")?e+"&"+n:e+"?"+n}},{key:"isErrorResponseExpiredToken",value:function(e){return 498===e.status}}])&&Bn(t.prototype,n),r&&Bn(t,r),f}(Jt.a);function Qn(e){return(Qn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Yn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Yn(Object(n),!0).forEach((function(t){Zn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Yn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Zn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function er(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function tr(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){er(o,r,a,i,s,"next",e)}function s(e){er(o,r,a,i,s,"throw",e)}i(void 0)}))}}function nr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function rr(e,t,n){return(rr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=sr(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ar(e,t){return(ar=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function or(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=sr(e);if(t){var a=sr(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ir(this,n)}}function ir(e,t){return!t||"object"!==Qn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function sr(e){return(sr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.LastSyncToken="sync_token",e.PaginationToken="cursor_token",e.IntegrityCheck="compute_integrity",e.IntegrityResult="integrity_hash",e.SyncDlLimit="limit",e.SyncPayloads="items",e.ApiVersion="api"}(Gn||(Gn={}));var cr,ur,lr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ar(e,t)}(w,e);var t,n,r,a,o,s,c,l,f,p,y,h,d,v,m,b,g=or(w);function w(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,w),(n=g.call(this)).registering=!1,n.authenticating=!1,n.changing=!1,n.refreshingSession=!1,n.httpService=e,n.storageService=t,n}return t=w,(n=[{key:"deinit",value:function(){this.httpService=void 0,this.storageService=void 0,this.host=void 0,this.session=void 0,rr(sr(w.prototype),"deinit",this).call(this)}},{key:"loadHost",value:(b=tr(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.ServerHost);case 2:t=e.sent,this.host=t||window._default_sync_server;case 4:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"setHost",value:(m=tr(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.host=t,e.next=3,this.storageService.setValue(Lt.ServerHost,t);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"getHost",value:(v=tr(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.host);case 1:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"setSession",value:(d=tr(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!(r.length>1&&void 0!==r[1])||r[1],this.session=t,!n){e.next=5;break}return e.next=5,this.storageService.setValue(Lt.Session,t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"getSession",value:function(){return this.session}},{key:"path",value:(h=tr(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getHost();case 2:if(n=e.sent){e.next=5;break}throw"Attempting to build path ".concat(t," with no host.");case 5:if(t){e.next=7;break}throw"Attempting to build path with null path.";case 7:return e.abrupt("return",Object(u.u)(n,t));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"params",value:function(e){var t=Me()(e,Zn({},Gn.ApiVersion,"20200115"));return t}},{key:"createErrorResponse",value:function(e){return{error:{message:e}}}},{key:"errorResponseWithFallbackMessage",value:function(e,t){return e.error.message||(e.error.message=t),e}},{key:"getAccountKeyParams",value:(y=tr(i.a.mark((function e(t,n,r){var a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.path("/auth/params");case 2:return a=e.sent,o=this.params({email:t}),n&&(o[n]=r),e.next=7,this.httpService.getAbsolute(a,o).catch((function(e){return c.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 7:return s=e.sent,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return y.apply(this,arguments)})},{key:"register",value:(p=tr(i.a.mark((function e(t,n,r){var a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.registering){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing registration request is already in progress."));case 2:return this.registering=!0,e.next=5,this.path("/auth");case 5:return a=e.sent,o=this.params(Xn({password:n,email:t},r.getPortableValue())),e.next=9,this.httpService.postAbsolute(a,o).catch((function(e){return c.errorResponseWithFallbackMessage(e,"A server error occurred while trying to register. Please try again.")}));case 9:return s=e.sent,this.registering=!1,e.abrupt("return",s);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return p.apply(this,arguments)})},{key:"signIn",value:(f=tr(i.a.mark((function e(t,n,r,a){var o,s,c,u=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.authenticating){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing sign in request is already in progress."));case 2:return this.authenticating=!0,e.next=5,this.path("/auth/sign_in");case 5:return o=e.sent,s=this.params({email:t,password:n}),r&&(s[r]=a),e.next=10,this.httpService.postAbsolute(o,s).catch((function(e){return u.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 10:return c=e.sent,this.authenticating=!1,e.abrupt("return",c);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return f.apply(this,arguments)})},{key:"signOut",value:(l=tr(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.path("/auth/sign_out");case 2:return t=e.sent,e.abrupt("return",this.httpService.postAbsolute(t,void 0,this.session.accessToken));case 4:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"changePassword",value:(c=tr(i.a.mark((function e(t,n,r){var a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.changing){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing change password request is already in progress."));case 2:if(!this.refreshingSession){e.next=4;break}return e.abrupt("return",this.createErrorResponse(wn));case 4:return this.changing=!0,e.next=7,this.path("/auth/change_pw");case 7:return a=e.sent,o=this.params(Xn({current_password:t,new_password:n},r.getPortableValue())),e.next=11,this.httpService.postAbsolute(a,o,this.session.accessToken).catch(function(){var e=tr(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!c.httpService.isErrorResponseExpiredToken(t)){e.next=2;break}return e.abrupt("return",c.refreshSessionThenRetryRequest({verb:Fn.Post,url:a,params:o}));case 2:return e.abrupt("return",c.errorResponseWithFallbackMessage(t,"Something went wrong while changing your password.\n                                                      Your password was not changed. Please try again."));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:return s=e.sent,this.changing=!1,e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"sync",value:(s=tr(i.a.mark((function e(t,n,r,a){var o,s,c,u,l,f,p,y=this,h=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=h.length>4&&void 0!==h[4]&&h[4],c=h.length>5?h[5]:void 0,u=h.length>6?h[6]:void 0,!this.refreshingSession){e.next=5;break}return e.abrupt("return",this.createErrorResponse(wn));case 5:return e.next=7,this.path("/items/sync");case 7:return l=e.sent,f=this.params((Zn(o={},Gn.SyncPayloads,t.map((function(e){return e.ejected()}))),Zn(o,Gn.LastSyncToken,n),Zn(o,Gn.PaginationToken,r),Zn(o,Gn.IntegrityCheck,s),Zn(o,Gn.SyncDlLimit,a),Zn(o,"content_type",c),Zn(o,"event",u),o)),e.next=11,this.httpService.postAbsolute(l,f,this.session.accessToken).catch(function(){var e=tr(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y.httpService.isErrorResponseExpiredToken(t)){e.next=2;break}return e.abrupt("return",y.refreshSessionThenRetryRequest({verb:Fn.Post,url:l,params:f}));case 2:return e.abrupt("return",y.errorResponseWithFallbackMessage(t,"Could not connect to server."));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:return p=e.sent,e.abrupt("return",p);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return s.apply(this,arguments)})},{key:"refreshSessionThenRetryRequest",value:(o=tr(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.refreshSession().then((function(e){return(null==e?void 0:e.error)?e:n.httpService.runHttp(Xn(Xn({},t),{},{authentication:n.session.accessToken}))})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"refreshSession",value:(a=tr(i.a.mark((function e(){var t,n,r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.refreshingSession){e.next=2;break}return e.abrupt("return",this.createErrorResponse(wn));case 2:return this.refreshingSession=!0,e.next=5,this.path("/session/refresh");case 5:return t=e.sent,n=this.params({access_token:this.session.accessToken,refresh_token:this.session.refreshToken}),e.next=9,this.httpService.postAbsolute(t,n).then(function(){var e=tr(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=gn.FromResponse(t),e.next=3,a.setSession(n);case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){return a.errorResponseWithFallbackMessage(e,"A server error occurred while trying to refresh your session.\n                                                      Please try again.")}));case 9:return r=e.sent,this.refreshingSession=!1,e.abrupt("return",r);case 12:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})}])&&nr(t.prototype,n),r&&nr(t,r),w}(Jt.a),fr=n(18),pr=n.n(fr),yr=n(23),hr=n.n(yr),dr=n(20),vr=n.n(dr);function mr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function br(e){return{"mac-web":ur.MacWeb,"mac-desktop":ur.MacDesktop,"linux-web":ur.LinuxWeb,"linux-desktop":ur.LinuxDesktop,"windows-web":ur.WindowsWeb,"windows-desktop":ur.WindowsDesktop,ios:ur.Ios,android:ur.Android}[e]}function gr(e){return e===cr.Web||e===cr.Desktop}function wr(e){return e===cr.Mobile}function kr(e){return(kr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Sr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function xr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Or(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){xr(o,r,a,i,s,"next",e)}function s(e){xr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Pr(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return jr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return jr(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function jr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Dr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Cr(e,t,n){return(Cr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Er(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function _r(e,t){return(_r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ir(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Er(e);if(t){var a=Er(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Rr(this,n)}}function Rr(e,t){return!t||"object"!==kr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Er(e){return(Er=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.Web=1]="Web",e[e.Desktop=2]="Desktop",e[e.Mobile=3]="Mobile"}(cr||(cr={})),function(e){e[e.Ios=1]="Ios",e[e.Android=2]="Android",e[e.MacWeb=3]="MacWeb",e[e.MacDesktop=4]="MacDesktop",e[e.WindowsWeb=5]="WindowsWeb",e[e.WindowsDesktop=6]="WindowsDesktop",e[e.LinuxWeb=7]="LinuxWeb",e[e.LinuxDesktop=8]="LinuxDesktop"}(ur||(ur={}));var Ar="org.standardnotes.sn.components",Mr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_r(e,t)}(m,e);var t,n,r,a,o,c,l,f,p,y,v=Ir(m);function m(e,t,n,r,a,o){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),(i=v.call(this)).componentState={},i.streamObservers=[],i.contextStreamObservers=[],i.activeComponents=[],i.permissionDialogs=[],i.handlers=[],i.detectFocusChange=function(){var e,t=Pr(i.itemManager.findItems(i.activeComponents));try{var n=function(){var t=e.value;if(document.activeElement===i.iframeForComponent(t.uuid))return i.timeout((function(){i.focusChangedForComponent(t)})),"break"};for(t.s();!(e=t.n()).done;){if("break"===n())break}}catch(e){t.e(e)}finally{t.f()}},i.onWindowMessage=function(e){e.data.sessionKey&&(i.log("Component manager received message",e.data),i.handleMessage(i.componentForSessionKey(e.data.sessionKey),e.data))},i.timeout=o||setTimeout.bind(window),i.itemManager=e,i.syncService=t,i.alertService=n,i.environment=r,i.platform=a,i.configureForGeneralUsage(),r!==cr.Mobile&&i.configureForNonMobileUsage(),i}return t=m,(n=[{key:"componentsForArea",value:function(e){return this.components.filter((function(t){return t.area===e}))}},{key:"deinit",value:function(){Cr(Er(m.prototype),"deinit",this).call(this),this.streamObservers.length=0,this.contextStreamObservers.length=0,this.activeComponents.length=0,this.permissionDialogs.length=0,this.handlers.length=0,this.itemManager=void 0,this.syncService=void 0,this.alertService=void 0,this.removeItemObserver(),this.removeItemObserver=null,window&&!this.isMobile&&(window.removeEventListener("focus",this.detectFocusChange,!0),window.removeEventListener("blur",this.detectFocusChange,!0),window.removeEventListener("message",this.onWindowMessage))}},{key:"setDesktopManager",value:function(e){this.desktopManager=e,this.configureForDesktop()}},{key:"configureForGeneralUsage",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(O.a.Any,(function(t,n,r,a,o){var i=Object(u.f)(t,n,r),s=i.filter((function(e){return e.content_type===O.a.Component||e.content_type===O.a.Theme}));s.length>0&&a!==j.a.RemoteSaved&&e.isDesktop&&e.desktopManager.syncComponentsInstallation(s);var c,l=Pr(s);try{for(l.s();!(c=l.n()).done;){var f=c.value,p=e.activeComponents.includes(f.uuid);!f.active||f.deleted||p?!f.active&&p&&e.deactivateComponent(f.uuid):e.activateComponent(f.uuid)}}catch(e){l.e(e)}finally{l.f()}a!==j.a.LocalChanged&&e.notifyStreamObservers(i,a,o)}))}},{key:"notifyStreamObservers",value:function(e,t,n){var r,a=this,o=Pr(this.streamObservers);try{var i=function(){var t=r.value;if(n&&n===t.componentUuid)return"continue";var o=e.filter((function(e){return-1!==t.contentTypes.indexOf(e.content_type)}));if(0===o.length)return"continue";var i=[{name:X.StreamItems,content_types:t.contentTypes.sort()}];a.runWithPermissions(t.componentUuid,i,(function(){a.sendItemsInReply(t.componentUuid,o,t.originalMessage)}))};for(o.s();!(r=o.n()).done;)i()}catch(e){o.e(e)}finally{o.f()}var s,c=[{name:X.StreamContextItem}],u=Pr(this.contextStreamObservers);try{var l=function(){var r=s.value;if(n&&n===r.componentUuid)return"continue";var o,i=Pr(a.handlers);try{for(i.s();!(o=i.n()).done;){var u=o.value;if((u.areas.includes(r.area)||u.areas.includes(Y.Any))&&u.contextRequestHandler){var l=u.contextRequestHandler(r.componentUuid);if(l&&"continue"===function(){var n=pr()(e,{uuid:l.uuid});if(n){if(n.deleted)return"continue";a.runWithPermissions(r.componentUuid,c,(function(){a.sendContextItemInReply(r.componentUuid,n,r.originalMessage,t)}))}}())continue}}}catch(e){i.e(e)}finally{i.f()}};for(u.s();!(s=u.n()).done;)l()}catch(e){u.e(e)}finally{u.f()}}},{key:"isNativeExtension",value:function(e){var t=[window._extensions_manager_location,window._batch_manager_location],n=e.hosted_url,r=e.local_url&&e.local_url.replace("sn://","");return t.includes(n)||t.includes(r)}},{key:"configureForNonMobileUsage",value:function(){window.addEventListener?window.addEventListener("focus",this.detectFocusChange,!0):window.attachEvent("onfocusout",this.detectFocusChange),window.addEventListener?window.addEventListener("blur",this.detectFocusChange,!0):window.attachEvent("onblur",this.detectFocusChange),window.addEventListener("message",this.onWindowMessage)}},{key:"configureForDesktop",value:function(){var e=this;this.desktopManager.registerUpdateObserver((function(t){t.active&&t.isTheme()&&e.postActiveThemesToAllComponents()}))}},{key:"postActiveThemesToAllComponents",value:function(){var e,t=Pr(this.components);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=this.findOrCreateDataForComponent(n);!n.isTheme()&&n.active&&r.window&&this.postActiveThemesToComponent(n)}}catch(e){t.e(e)}finally{t.f()}}},{key:"getActiveThemes",value:function(){return this.componentsForArea(Y.Themes).filter((function(e){return e.active}))}},{key:"urlsForActiveThemes",value:function(){var e,t=[],n=Pr(this.getActiveThemes());try{for(n.s();!(e=n.n()).done;){var r=e.value,a=this.urlForComponent(r);a&&t.push(a)}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"postActiveThemesToComponent",value:function(e){var t={themes:this.urlsForActiveThemes()},n={action:X.ActivateThemes,data:t};this.sendMessageToComponent(e,n)}},{key:"contextItemDidChangeInArea",value:function(e){var t,n=Pr(this.handlers);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.areas.includes(e)||r.areas.includes(Y.Any)){var a,o=Pr(this.contextStreamObservers.filter((function(t){return t.area===e})));try{for(o.s();!(a=o.n()).done;){var i=a.value;if(r.contextRequestHandler){var s=r.contextRequestHandler(i.componentUuid);s&&this.sendContextItemInReply(i.componentUuid,s,i.originalMessage)}}}catch(e){o.e(e)}finally{o.f()}}}}catch(e){n.e(e)}finally{n.f()}}},{key:"isComponentHidden",value:function(e){return this.findOrCreateDataForComponent(e).hidden}},{key:"setComponentHidden",value:function(e,t){var n=this.findOrCreateDataForComponent(e);if(t)n.hidden=!0;else if(n.hidden){n.hidden=!1;var r=pr()(this.contextStreamObservers,{identifier:e.uuid});r&&this.handleStreamContextItemMessage(e,r.originalMessage);var a=pr()(this.streamObservers,{identifier:e.uuid});a&&this.handleStreamItemsMessage(e,a.originalMessage)}}},{key:"jsonForItem",value:function(e,t,n){var r=n===j.a.RemoteSaved||n===j.a.LocalSaved,a=(e.getDomainData(Ar)||{})[t.getClientDataKey()]||{},o={uuid:e.uuid,content_type:e.content_type,created_at:e.created_at,updated_at:e.updated_at,deleted:e.deleted,isMetadataUpdate:r,content:e.content,clientData:a};return this.removePrivatePropertiesFromResponseItems([o],t),o}},{key:"sendItemsInReply",value:function(e,t,n,r){var a=this,o=this.itemManager.findItem(e);this.log("Component manager send items in reply",o,t,n);var i={},s=t.map((function(e){return a.jsonForItem(e,o,r)}));i.items=s,this.replyToMessage(o,n,i)}},{key:"sendContextItemInReply",value:function(e,t,n,r){var a=this.itemManager.findItem(e);this.log("Component manager send context item in reply",a,t,n);var o={item:this.jsonForItem(t,a,r)};this.replyToMessage(a,n,o)}},{key:"replyToMessage",value:function(e,t,n){var r={action:X.Reply,original:t,data:n};this.sendMessageToComponent(e,r)}},{key:"sendMessageToComponent",value:function(e,t){var n=[X.ComponentRegistered,X.ActivateThemes],r=this.findOrCreateDataForComponent(e);if(!r.hidden||n.includes(t.action)){this.log("Component manager send message to component",e,t);var a=this.urlForComponent(e);a&&r.window||this.alertService.alert("Standard Notes is trying to communicate with ".concat(e.name,",\n        but an error is occurring. Please restart this extension and try again.")),a.startsWith("http")||a.startsWith("file")||(a=window.location.href+a),r.window.postMessage(this.isMobile?JSON.stringify(t):t,a)}else this.log("Component disabled for current item, ignoring messages.",e.name)}},{key:"urlForComponent",value:function(e){if(e.offlineOnly&&!this.isDesktop)return null;if(e.offlineOnly||this.isDesktop&&e.local_url)return e.local_url&&e.local_url.replace("sn://",this.desktopManager.getExtServerHost());var t=e.hosted_url||e.legacy_url;if(this.isMobile){var n=this.platform===ur.Ios?"localhost":"10.0.2.2";t=t.replace("localhost",n).replace("sn.local",n)}return t}},{key:"componentForUrl",value:function(e){return this.components.filter((function(t){return t.hosted_url===e||t.legacy_url===e}))[0]}},{key:"sessionKeyForComponent",value:function(e){return this.findOrCreateDataForComponent(e).sessionKey}},{key:"componentForSessionKey",value:function(e){for(var t,n=this,r=function(){var r=o[a],i=n.componentState[r];if((null==i?void 0:i.sessionKey)===e)return t=n.components.find((function(e){return e.uuid===r})),"break"},a=0,o=Object.keys(this.componentState);a<o.length&&"break"!==r();a++);if(!t){var i,s=Pr(this.handlers);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(c.componentForSessionKeyHandler&&(t=c.componentForSessionKeyHandler(e)))break}}catch(e){s.e(e)}finally{s.f()}}return t}},{key:"handleMessage",value:function(e,t){var n=this;if(!e)return this.log("Component not defined for message, returning",t),void this.alertService.alert("An extension is trying to communicate with Standard Notes,but there is an error establishing a bridge. Please restart the app and try again.");var r=[X.SaveItems,X.AssociateItem,X.DeassociateItem,X.CreateItem,X.CreateItems,X.DeleteItems,X.SetComponentData];if(this.getReadonlyStateForComponent(e).readonly&&r.includes(t.action))this.alertService.alert("The extension ".concat(e.name," is trying to save, but it is in a locked state and cannot accept changes."));else{if(t.action===X.StreamItems)this.handleStreamItemsMessage(e,t);else if(t.action===X.StreamContextItem)this.handleStreamContextItemMessage(e,t);else if(t.action===X.SetComponentData)this.handleSetComponentDataMessage(e,t);else if(t.action===X.DeleteItems)this.handleDeleteItemsMessage(e,t);else if(t.action===X.CreateItems||t.action===X.CreateItem)this.handleCreateItemsMessage(e,t);else if(t.action===X.SaveItems)this.handleSaveItemsMessage(e,t);else if(t.action===X.ToggleActivateComponent){var a=this.itemManager.findItem(t.data.uuid);this.handleToggleComponentMessage(a,t)}else t.action===X.RequestPermissions?this.handleRequestPermissionsMessage(e,t):t.action===X.InstallLocalComponent?this.handleInstallLocalComponentMessage(e,t):t.action===X.DuplicateItem&&this.handleDuplicateItemMessage(e,t);var o,i=Pr(this.handlers);try{var s=function(){var r=o.value;r.actionHandler&&(r.areas.includes(e.area)||r.areas.includes(Y.Any))&&n.timeout((function(){r.actionHandler(e,t.action,t.data)}))};for(i.s();!(o=i.n()).done;)s()}catch(e){i.e(e)}finally{i.f()}}}},{key:"removePrivatePropertiesFromResponseItems",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t||!this.isNativeExtension(t)){var r=["autoupdateDisabled","permissions","active"];n&&(r=r.concat(["url","hosted_url","local_url"]));var a,o=Pr(e);try{for(o.s();!(a=o.n()).done;){var i,s=a.value,c=Pr(r);try{for(c.s();!(i=c.n()).done;){var u=i.value;delete s.content[u]}}catch(e){c.e(e)}finally{c.f()}}}catch(e){o.e(e)}finally{o.f()}}}},{key:"handleStreamItemsMessage",value:function(e,t){var n=this,r=[{name:X.StreamItems,content_types:t.data.content_types.sort()}];this.runWithPermissions(e.uuid,r,(function(){pr()(n.streamObservers,{identifier:e.uuid})||n.streamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t,contentTypes:t.data.content_types});var r,a=[],o=Pr(t.data.content_types);try{for(o.s();!(r=o.n()).done;){var i=r.value;Object(u.j)(a,n.itemManager.nonErroredItemsForContentType(i))}}catch(e){o.e(e)}finally{o.f()}n.sendItemsInReply(e.uuid,a,t)}))}},{key:"handleStreamContextItemMessage",value:function(e,t){var n=this,r=[{name:X.StreamContextItem}];this.runWithPermissions(e.uuid,r,(function(){pr()(n.contextStreamObservers,{identifier:e.uuid})||n.contextStreamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t});var r,a=Pr(n.handlersForArea(e.area));try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o.contextRequestHandler){var i=o.contextRequestHandler(e.uuid);i&&n.sendContextItemInReply(e.uuid,i,t)}}}catch(e){a.e(e)}finally{a.f()}}))}},{key:"isItemIdWithinComponentContextJurisdiction",value:function(e,t){return this.itemIdsInContextJurisdictionForComponent(t).includes(e)}},{key:"itemIdsInContextJurisdictionForComponent",value:function(e){var t,n=[],r=Pr(this.handlersForArea(e.area));try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.contextRequestHandler){var o=a.contextRequestHandler(e.uuid);o&&n.push(o.uuid)}}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"handlersForArea",value:function(e){return this.handlers.filter((function(t){return t.areas.includes(e)}))}},{key:"handleSaveItemsMessage",value:(y=Or(i.a.mark((function e(t,n){var r,a,o,c,l,f,p,y,h=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=n.data.items,a=[],o=this.itemIdsInContextJurisdictionForComponent(t),c=r.slice(),l=Pr(r.slice()),e.prev=5,l.s();case 7:if((f=l.n()).done){e.next=15;break}if(p=f.value,!o.includes(p.uuid)){e.next=13;break}return a.push({name:X.StreamContextItem}),Object(u.B)(c,p),e.abrupt("break",15);case 13:e.next=7;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(5),l.e(e.t0);case 20:return e.prev=20,l.f(),e.finish(20);case 23:c.length>0&&(y=hr()(c.map((function(e){return e.content_type}))).sort(),a.push({name:X.StreamItems,content_types:y})),this.runWithPermissions(t.uuid,a,Or(i.a.mark((function e(){var a,o,c,l,f,p;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(h.removePrivatePropertiesFromResponseItems(r,t,!0),a=Object(s.b)(r),o=h.itemManager.findItems(a,!0),c=0,o.forEach((function(e,n){if(e)e.locked&&(vr()(r,{uuid:e.uuid}),c++);else{var a=r[n];h.alertService.alert("The extension ".concat(t.name," is trying to save an item with type ")+"".concat(a.content_type,", but that item does not exist .")+"Please restart this extension and try again.")}})),!(c>0)){e.next=10;break}return l=1===c?"item":"items",f=1===c?"is":"are",h.alertService.alert("".concat(c," ").concat(l," you are attempting to save ").concat(f," locked and cannot be edited."),"Items Locked"),e.abrupt("return");case 10:return p=r.map((function(e){return Object(P.f)(e,j.a.ComponentRetrieved)})),e.next=13,h.itemManager.changeItems(a,(function(e){var n=Object(u.D)(p,{uuid:e.getUuid()});e.mergePayload(n);var a=Object(u.D)(r,{uuid:e.getUuid()});if(a.clientData){var o=Object(u.a)(e.getItem().getDomainData(Ar)||{});o[t.getClientDataKey()]=a.clientData,e.setDomainData(o,Ar)}}),d.c.UserInteraction,j.a.ComponentRetrieved,t.uuid);case 13:h.syncService.sync().then((function(){var e=Object.assign({},n);e.action=X.SaveSuccess,h.replyToMessage(t,n,{}),h.handleMessage(t,e)})).catch((function(){var e=Object.assign({},n);e.action=X.SaveError,h.replyToMessage(t,n,{error:X.SaveError}),h.handleMessage(t,e)}));case 14:case"end":return e.stop()}}),e)}))));case 25:case"end":return e.stop()}}),e,this,[[5,17,20,23]])}))),function(e,t){return y.apply(this,arguments)})},{key:"handleDuplicateItemMessage",value:function(e,t){var n=this,r=t.data.item,a=this.itemManager.findItem(r.uuid),o=[{name:X.StreamItems,content_types:[a.content_type]}];this.runWithPermissions(e.uuid,o,Or(i.a.mark((function r(){var o;return i.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.duplicateItem(a.uuid);case 2:o=r.sent,n.syncService.sync(),n.replyToMessage(e,t,{item:n.jsonForItem(o,e)});case 5:case"end":return r.stop()}}),r)}))))}},{key:"handleCreateItemsMessage",value:function(e,t){var n=this,r=t.data.item?[t.data.item]:t.data.items,a=hr()(r.map((function(e){return e.content_type}))),o=[{name:X.StreamItems,content_types:a}];this.runWithPermissions(e.uuid,o,Or(i.a.mark((function a(){var o,s,c,l,f;return i.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:n.removePrivatePropertiesFromResponseItems(r,e),o=[],s=Pr(r),a.prev=3,l=i.a.mark((function t(){var r,a,s,l;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((r=c.value).uuid){t.next=5;break}return t.next=4,h.GenerateUuid();case 4:r.uuid=t.sent;case 5:return a=Object(P.f)(r,j.a.ComponentCreated),s=Nt(a),t.next=9,n.itemManager.insertItem(s);case 9:return l=t.sent,t.next=12,n.itemManager.changeItem(l.uuid,(function(t){if(r.clientData){var n=Object(u.a)(l.getDomainData(Ar)||{});n[e.getClientDataKey()]=r.clientData,t.setDomainData(n,Ar)}}),d.c.UserInteraction,j.a.ComponentCreated,e.uuid);case 12:o.push(l);case 13:case"end":return t.stop()}}),t)})),s.s();case 6:if((c=s.n()).done){a.next=10;break}return a.delegateYield(l(),"t0",8);case 8:a.next=6;break;case 10:a.next=15;break;case 12:a.prev=12,a.t1=a.catch(3),s.e(a.t1);case 15:return a.prev=15,s.f(),a.finish(15);case 18:n.syncService.sync(),f=t.action===X.CreateItem?{item:n.jsonForItem(o[0],e)}:{items:o.map((function(t){return n.jsonForItem(t,e)}))},n.replyToMessage(e,t,f);case 21:case"end":return a.stop()}}),a,null,[[3,12,15,18]])}))))}},{key:"handleDeleteItemsMessage",value:function(e,t){var n=this,r=hr()(t.data.items.map((function(e){return e.content_type}))).sort(),a=[{name:X.StreamItems,content_types:r}];this.runWithPermissions(e.uuid,a,Or(i.a.mark((function r(){var a,o,s,c,u,l,f,p;return i.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=t.data.items,o=1===a.length?"item":"items",s=null,c=!0,r.next=6,n.alertService.confirm("Are you sure you want to delete ".concat(a.length," ").concat(o,"?")).catch((function(){c=!1}));case 6:if(!c){r.next=35;break}u=Pr(a),r.prev=8,u.s();case 10:if((l=u.n()).done){r.next=23;break}if(f=l.value,p=n.itemManager.findItem(f.uuid)){r.next=16;break}return n.alertService.alert("The item you are trying to delete cannot be found."),r.abrupt("continue",21);case 16:if(![O.a.Component,O.a.Theme].includes(p.content_type)){r.next=19;break}return r.next=19,n.deactivateComponent(p.uuid);case 19:return r.next=21,n.itemManager.setItemToBeDeleted(p.uuid);case 21:r.next=10;break;case 23:r.next=28;break;case 25:r.prev=25,r.t0=r.catch(8),u.e(r.t0);case 28:return r.prev=28,u.f(),r.finish(28);case 31:n.syncService.sync(),s={deleted:!0},r.next=36;break;case 35:s={deleted:!1};case 36:n.replyToMessage(e,t,s);case 37:case"end":return r.stop()}}),r,null,[[8,25,28,31]])}))))}},{key:"handleRequestPermissionsMessage",value:function(e,t){var n=this;this.runWithPermissions(e.uuid,t.data.permissions,(function(){n.replyToMessage(e,t,{approved:!0})}))}},{key:"handleSetComponentDataMessage",value:function(e,t){var n=this;this.runWithPermissions(e.uuid,[],Or(i.a.mark((function r(){return i.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.changeComponent(e.uuid,(function(e){e.componentData=t.data.componentData}));case 2:n.syncService.sync();case 3:case"end":return r.stop()}}),r)}))))}},{key:"handleToggleComponentMessage",value:function(e,t){this.toggleComponent(e)}},{key:"toggleComponent",value:(p=Or(i.a.mark((function e(t){var n,r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.area!==Y.Modal){e.next=4;break}this.openModalComponent(t),e.next=19;break;case 4:if(!t.active){e.next=9;break}return e.next=7,this.deactivateComponent(t.uuid);case 7:e.next=19;break;case 9:if(t.content_type!==O.a.Theme){e.next=17;break}return n=t,r=this.getActiveThemes(),e.next=14,this.activateComponent(t.uuid);case 14:n.isLayerable()||setTimeout(Or(i.a.mark((function e(){var t,n,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=Pr(r),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=10;break}if(!(o=n.value)||o.isLayerable()){e.next=8;break}return e.next=8,a.deactivateComponent(o.uuid);case 8:e.next=3;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(1),t.e(e.t0);case 15:return e.prev=15,t.f(),e.finish(15);case 18:case"end":return e.stop()}}),e,null,[[1,12,15,18]])}))),10),e.next=19;break;case 17:return e.next=19,this.activateComponent(t.uuid);case 19:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"handleInstallLocalComponentMessage",value:function(e,t){if(this.isNativeExtension(e)){var n=this.itemManager.findItem(t.data.uuid);this.desktopManager.installComponent(n)}}},{key:"runWithPermissions",value:function(e,t,n){var r=this.itemManager.findItem(e);t=Object(u.a)(t);var a,o=r.permissions,s=Pr(t.slice());try{var c=function(){var e=a.value,n=o.find((function(t){return t.name===e.name}));if(!n)return"continue";var r=e.content_types;if(!r)return Object(u.k)(t,e),"continue";var i,s=Pr(n.content_types);try{for(s.s();!(i=s.n()).done;){var c=i.value;Object(u.B)(r,c)}}catch(e){s.e(e)}finally{s.f()}0===r.length&&Object(u.k)(t,e)};for(s.s();!(a=s.n()).done;)c()}catch(e){s.e(e)}finally{s.f()}t.length>0?this.promptForPermissions(r,t,function(){var e=Or(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t&&n();case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):n()}},{key:"promptForPermissions",value:function(e,t,n){var r,a=this,o={component:e,permissions:t,permissionsString:this.permissionsStringForPermissions(t,e),actionBlock:n,callback:(r=Or(i.a.mark((function n(r){return i.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!r){n.next=5;break}return a.log("Changing component to expand permissions",e),n.next=4,a.itemManager.changeItem(e.uuid,(function(n){var r,a=Object(u.a)(e.permissions),o=Pr(t);try{var i=function(){var e=r.value,t=a.find((function(t){return t.name===e.name}));if(t){var n=t.content_types||[];t.content_types=hr()(n.concat(e.content_types))}else a.push(e)};for(o.s();!(r=o.n()).done;)i()}catch(e){o.e(e)}finally{o.f()}n.permissions=a}));case 4:a.syncService.sync();case 5:a.permissionDialogs=a.permissionDialogs.filter((function(n){return n===o?(n.actionBlock&&n.actionBlock(r),!1):!!(n.component!==e||n.permissions!==t&&(a=t,n.permissions.some((function(e){return!a.find((function(t){return JSON.stringify(t)===JSON.stringify(e)}))}))))||(r&&n.actionBlock&&n.actionBlock(r),!1);var a})),a.permissionDialogs.length>0&&a.presentPermissionsDialog(a.permissionDialogs[0]);case 7:case"end":return n.stop()}}),n)}))),function(e){return r.apply(this,arguments)})},s=pr()(this.permissionDialogs,{component:e});this.permissionDialogs.push(o),s?this.log("Existing dialog, not presenting."):this.presentPermissionsDialog(o)}},{key:"presentPermissionsDialog",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"openModalComponent",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"registerHandler",value:function(e){var t=this;return this.handlers.push(e),function(){var n=pr()(t.handlers,{identifier:e.identifier});n?Object(u.B)(t.handlers,n):t.log("Attempting to deregister non-existing handler")}}},{key:"findOrCreateDataForComponent",value:function(e){var t=this.componentState[e.uuid];return t||(t={},this.componentState[e.uuid]=t),t}},{key:"setReadonlyStateForComponent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.findOrCreateDataForComponent(e);r.readonly=t,r.lockReadonly=n}},{key:"getReadonlyStateForComponent",value:function(e){var t=this.findOrCreateDataForComponent(e);return{readonly:t.readonly,lockReadonly:t.lockReadonly}}},{key:"registerComponentWindow",value:(f=Or(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Register component window",t),(r=this.findOrCreateDataForComponent(t)).window===n&&this.log("Web|componentManager","attempting to re-register same component window."),this.log("Web|componentManager|registerComponentWindow",t),r.window=n,e.next=7,h.GenerateUuid();case 7:r.sessionKey=e.sent,this.sendMessageToComponent(t,{action:X.ComponentRegistered,sessionKey:r.sessionKey,componentData:t.componentData,data:{uuid:t.uuid,environment:(i=this.environment,s=void 0,(mr(s={},cr.Web,"web"),mr(s,cr.Desktop,"desktop"),mr(s,cr.Mobile,"mobile"),s)[i]),platform:(a=this.platform,o=void 0,(mr(o={},ur.MacWeb,"mac-web"),mr(o,ur.MacDesktop,"mac-desktop"),mr(o,ur.LinuxWeb,"linux-web"),mr(o,ur.LinuxDesktop,"linux-desktop"),mr(o,ur.WindowsWeb,"windows-web"),mr(o,ur.WindowsDesktop,"windows-desktop"),mr(o,ur.Ios,"ios"),mr(o,ur.Android,"android"),o)[a]),activeThemeUrls:this.urlsForActiveThemes()}}),this.postActiveThemesToComponent(t),this.desktopManager&&this.desktopManager.notifyComponentActivation(t);case 11:case"end":return e.stop()}var a,o,i,s}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"registerComponent",value:function(e){this.log("Registering component",e),Object(u.b)(this.activeComponents,e);var t,n=this.itemManager.findItem(e),r=Pr(this.handlers);try{for(r.s();!(t=r.n()).done;){var a=t.value;(a.areas.includes(n.area)||a.areas.includes(Y.Any))&&a.activationHandler&&a.activationHandler(n)}}catch(e){r.e(e)}finally{r.f()}n.area===Y.Themes&&this.postActiveThemesToAllComponents()}},{key:"activateComponent",value:(l=Or(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Activating component",t),(n=this.itemManager.findItem(t)).active){e.next=5;break}return e.next=5,this.itemManager.changeComponent(n.uuid,(function(e){e.active=!0}));case 5:this.registerComponent(t),this.syncService.sync();case 7:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"deregisterComponent",value:function(e){this.log("Degregistering component",e);var t=this.itemManager.findItem(e);Object(u.B)(this.activeComponents,e),delete this.componentState[t.uuid];var n,r=Pr(this.handlers);try{for(r.s();!(n=r.n()).done;){var a=n.value;(a.areas.includes(t.area)||a.areas.includes(Y.Any))&&a.activationHandler&&a.activationHandler(t)}}catch(e){r.e(e)}finally{r.f()}this.streamObservers=this.streamObservers.filter((function(t){return t.componentUuid!==e})),this.contextStreamObservers=this.contextStreamObservers.filter((function(t){return t.componentUuid!==e})),t.area===Y.Themes&&this.postActiveThemesToAllComponents()}},{key:"deactivateComponent",value:(c=Or(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Deactivating component",t),!(r=null===(n=this.itemManager)||void 0===n?void 0:n.findItem(t)).active){e.next=5;break}return e.next=5,this.itemManager.changeComponent(r.uuid,(function(e){e.active=!1}));case 5:this.findOrCreateDataForComponent(r).sessionKey=void 0,this.deregisterComponent(t),this.syncService.sync();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"reloadComponent",value:(o=Or(i.a.mark((function e(t){var n,r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Reloading component",t),r=null===(n=this.itemManager)||void 0===n?void 0:n.findItem(t),e.next=4,this.itemManager.changeComponent(r.uuid,(function(e){e.active=!1}));case 4:return this.deregisterComponent(r.uuid),e.abrupt("return",new Promise((function(e){a.timeout(Or(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.itemManager.changeComponent(r.uuid,(function(e){e.active=!0}));case 2:a.registerComponent(r.uuid),e();case 4:case"end":return t.stop()}}),t)}))))})));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"deleteComponent",value:(a=Or(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t);case 2:this.syncService.sync();case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"isComponentActive",value:function(e){return e.active}},{key:"iframeForComponent",value:function(e){for(var t=0,n=Array.from(document.getElementsByTagName("iframe"));t<n.length;t++){var r=n[t];if(r.dataset.componentId===e)return r}}},{key:"focusChangedForComponent",value:function(e){var t,n=document.activeElement===this.iframeForComponent(e.uuid),r=Pr(this.handlers);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.focusHandler&&a.focusHandler(e,n)}}catch(e){r.e(e)}finally{r.f()}}},{key:"handleSetSizeEvent",value:function(e,t){var n=function(e,n){var r=Object(u.s)(n.width)?n.width:"".concat(t.width,"px"),a=Object(u.s)(n.height)?n.height:"".concat(t.height,"px");e&&e.setAttribute("style","width:".concat(r,"; height:").concat(a,";"))};if(e.area===Y.Rooms||e.area===Y.Modal){var r=e.area===Y.Rooms?"inner":"outer",a=document.getElementById("component-content-".concat(r,"-").concat(e.uuid));a&&n(a,t)}else{var o=this.iframeForComponent(e.uuid);if(!o)return;if(n(o,t),e.area===Y.EditorStack){var i=o.parentElement;i&&n(i,t)}}}},{key:"editorForNote",value:function(e){var t,n,r=Pr(this.componentsForArea(Y.Editor));try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.isExplicitlyEnabledForItem(e.uuid))return a}}catch(e){r.e(e)}finally{r.f()}return this.isMobile?e.mobilePrefersPlainEditor||(n=this.getDefaultEditor()):e.prefersPlainEditor||(n=this.getDefaultEditor()),n&&!n.isExplicitlyDisabledForItem(e.uuid)?n:void 0}},{key:"getDefaultEditor",value:function(){var e=this.componentsForArea(Y.Editor);return this.isMobile?e.filter((function(e){return e.isMobileDefault}))[0]:e.filter((function(e){return e.isDefaultEditor()}))[0]}},{key:"permissionsStringForPermissions",value:function(e,t){var n="",r=e.length,a=function(e,t){return e>0?e===t-1?2===t?" and ":", and ":", ":""};return e.forEach((function(e,o){if(e.name===X.StreamItems){for(var i=e.content_types.map((function(e){var t=Object(O.c)(e);return t?t+"s":"items of type "+e})),s="",c=0;c<i.length;c++){var u=i[c];s+=a(c,i.length+r-o-1),s+=u}n+=a(o,r),n+=s,i.length>=2&&o<r-1&&(n+=", ")}else if(e.name===X.StreamContextItem){var l,f=(Sr(l={},Y.EditorStack,"working note"),Sr(l,Y.NoteTags,"working note"),Sr(l,Y.Editor,"working note"),l);n+=a(o,r),n+=f[t.area]}})),n+"."}},{key:"isDesktop",get:function(){return this.environment===cr.Desktop}},{key:"isMobile",get:function(){return this.environment===cr.Mobile}},{key:"components",get:function(){return this.itemManager.getItems([O.a.Component,O.a.Theme])}}])&&Dr(t.prototype,n),r&&Dr(t,r),m}(Jt.a);function Tr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Kr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Fr=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseCollection=t,this.applyCollection=n,this.relatedCollectionSet=r}var t,n,r,a,o;return t=e,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override PayloadDelta.resultingCollection.";case 1:case"end":return e.stop()}}),e)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Tr(o,n,r,i,s,"next",e)}function s(e){Tr(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})},{key:"findBasePayload",value:function(e){return this.baseCollection.find(e)}},{key:"findRelatedPayload",value:function(e,t){var n,r=null===(n=this.relatedCollectionSet)||void 0===n?void 0:n.collectionForSource(t);return null==r?void 0:r.find(e)}}])&&Kr(t.prototype,n),r&&Kr(t,r),e}();function Lr(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Vr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Vr(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Vr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Nr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ur=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.directMap={},this.inverseMap={}}var t,n,r;return t=e,(n=[{key:"makeCopy",value:function(){var t=new e;return t.directMap=Object.assign({},this.directMap),t.inverseMap=Object.assign({},this.inverseMap),t}},{key:"getDirectRelationships",value:function(e){return this.directMap[e]||[]}},{key:"getInverseRelationships",value:function(e){return this.inverseMap[e]||[]}},{key:"establishRelationship",value:function(e,t){this.establishDirectRelationship(e,t),this.establishInverseRelationship(e,t)}},{key:"deestablishRelationship",value:function(e,t){this.deestablishDirectRelationship(e,t),this.deestablishInverseRelationship(e,t)}},{key:"setAllRelationships",value:function(e,t){var n=this.directMap[e]||[];this.directMap[e]=t;var r,a=Lr(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;this.deestablishInverseRelationship(e,o)}}catch(e){a.e(e)}finally{a.f()}var i,s=Lr(t);try{for(s.s();!(i=s.n()).done;){var c=i.value;this.establishInverseRelationship(e,c)}}catch(e){s.e(e)}finally{s.f()}}},{key:"removeFromMap",value:function(e){var t,n=Lr(this.directMap[e]||[]);try{for(n.s();!(t=n.n()).done;){var r=t.value;Object(u.B)(this.inverseMap[r]||[],e)}}catch(e){n.e(e)}finally{n.f()}delete this.directMap[e];var a,o=Lr(this.inverseMap[e]||[]);try{for(o.s();!(a=o.n()).done;){var i=a.value;Object(u.B)(this.directMap[i]||[],e)}}catch(e){o.e(e)}finally{o.f()}delete this.inverseMap[e]}},{key:"establishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(u.b)(n,t),this.directMap[e]=n}},{key:"establishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(u.b)(n,e),this.inverseMap[t]=n}},{key:"deestablishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(u.B)(n,t),this.directMap[e]=n}},{key:"deestablishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(u.B)(n,e),this.inverseMap[t]=n}}])&&Nr(t.prototype,n),r&&Nr(t,r),e}();function Wr(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Br(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Br(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Br(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Hr(e){if(null==e)throw new TypeError("Cannot destructure undefined")}function zr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function qr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Jr=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1?arguments[1]:void 0,a=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;zr(this,e),this.map={},this.typedMap=(Hr(t={}),t),this.dirtyIndex=new Set,this.invalidsIndex=new Set,this.nondeletedIndex=new Set,n?(this.map=r,this.typedMap=a,this.referenceMap=o,this.conflictMap=i):(this.referenceMap=new Ur,this.conflictMap=new Ur)}var t,n,r;return t=e,(n=[{key:"uuids",value:function(){return Object.keys(this.map)}},{key:"all",value:function(e){var t=this;if(e){if(Array.isArray(e)){var n,r=[],a=Wr(e);try{for(a.s();!(n=a.n()).done;){var o=n.value;Object(u.j)(r,this.typedMap[o]||[])}}catch(e){a.e(e)}finally{a.f()}return r}var i;return(null===(i=this.typedMap[e])||void 0===i?void 0:i.slice())||[]}return Object.keys(this.map).map((function(e){return t.map[e]}))}},{key:"find",value:function(e){return this.map[e]}},{key:"dirtyElements",value:function(){var e=Array.from(this.dirtyIndex);return this.findAll(e)}},{key:"invalidElements",value:function(){var e=Array.from(this.invalidsIndex);return this.findAll(e)}},{key:"nondeletedElements",value:function(){var e=Array.from(this.nondeletedIndex);return this.findAll(e)}},{key:"findAll",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[],a=Wr(e);try{for(a.s();!(t=a.n()).done;){var o=t.value,i=this.map[o];(i||n)&&r.push(i)}}catch(e){a.e(e)}finally{a.f()}return r}},{key:"set",value:function(e){if(0!==(e=Array.isArray(e)?e:[e]).length){var t,n=Wr(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(this.map[r.uuid]=r,this.setToTypedMap(r),r.dirty?this.dirtyIndex.add(r.uuid):this.dirtyIndex.delete(r.uuid),r.errorDecrypting||r.waitingForKey?this.invalidsIndex.add(r.uuid):this.invalidsIndex.delete(r.uuid),r.deleted)this.referenceMap.removeFromMap(r.uuid),this.nondeletedIndex.delete(r.uuid);else{this.nondeletedIndex.add(r.uuid);var a=r.safeContent.conflict_of;a&&this.conflictMap.establishRelationship(a,r.uuid),this.referenceMap.setAllRelationships(r.uuid,r.references.map((function(e){return e.uuid})))}}}catch(e){n.e(e)}finally{n.f()}}else console.warn("Attempting to set 0 elements onto collection")}},{key:"discard",value:function(e){var t,n=Wr(e=Array.isArray(e)?e:[e]);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.conflictMap.removeFromMap(r.uuid),this.referenceMap.removeFromMap(r.uuid),this.deleteFromTypedMap(r),delete this.map[r.uuid]}}catch(e){n.e(e)}finally{n.f()}}},{key:"setToTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];vr()(t,{uuid:e.uuid}),t.push(e),this.typedMap[e.content_type]=t}},{key:"deleteFromTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];vr()(t,{uuid:e.uuid}),this.typedMap[e.content_type]=t}},{key:"uuidsThatReferenceUuid",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");return this.referenceMap.getInverseRelationships(e)}},{key:"elementsReferencingElement",value:function(e){var t=this.uuidsThatReferenceUuid(e.uuid);return this.findAll(t)}},{key:"conflictsOf",value:function(e){var t=this.conflictMap.getDirectRelationships(e);return this.findAll(t)}}])&&qr(t.prototype,n),r&&qr(t,r),e}();function Gr(e){return(Gr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function $r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Qr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Yr(e,t){return(Yr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Xr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ea(e);if(t){var a=ea(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Zr(this,n)}}function Zr(e,t){return!t||"object"!==Gr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ea(e){return(ea=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ta=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Yr(e,t)}(o,e);var t,n,r,a=Xr(o);function o(){return $r(this,o),a.apply(this,arguments)}return t=o,r=[{key:"WithPayloads",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,n=new o;return n.source=t,e.length>0&&n.set(e),Object.freeze(n),n}},{key:"FromCollection",value:function(e){var t=new o(!0,Object.freeze(Object.assign({},e.map)),Object.freeze(Object.assign({},e.typedMap)),Object.freeze(e.referenceMap.makeCopy()),Object.freeze(e.conflictMap.makeCopy()));return Object.freeze(t),t}}],(n=[{key:"payloads",get:function(){return this.all()}}])&&Qr(t.prototype,n),r&&Qr(t,r),o}(Jr);function na(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ra(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ra(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function ra(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function aa(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function oa(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?aa(Object(n),!0).forEach((function(t){ca(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aa(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ia(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function sa(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ia(o,r,a,i,s,"next",e)}function s(e){ia(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ca(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ua=ca({},O.a.Note,(function(e,t,n){var r=n.all(O.a.Component).map((function(e){return Nt(e)})).filter((function(e){return e.area===Y.Editor})).find((function(t){return t.isExplicitlyEnabledForItem(e.uuid)}));if(r){var a=new ye(r,d.c.Internal);return a.associateWithItem(t.uuid),[a.getResult()]}}));function la(e,t,n){return fa.apply(this,arguments)}function fa(){return(fa=sa(i.a.mark((function e(t,n,r){var a,o,s,c,l,f,p;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=[],e.next=3,h.GenerateUuid();case 3:return e.t0=e.sent,e.t1=new Date,o={uuid:e.t0,dirty:!0,dirtiedDate:e.t1,lastSyncBegan:null,lastSyncEnd:null},r&&(o.content=oa(oa({},t.safeContent),{},{conflict_of:t.uuid})),s=Object(P.b)(t,o),a.push(s),c=n.elementsReferencingElement(t),e.next=12,ha(c,[{uuid:s.uuid,content_type:s.content_type}]);case 12:return l=e.sent,Object(u.j)(a,l),(f=ua[t.content_type])&&(p=f(t,s,n))&&Object(u.j)(a,p),e.abrupt("return",a);case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pa(e,t){return ya.apply(this,arguments)}function ya(){return(ya=sa(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],e.t0=P.b,e.t1=t,e.next=5,h.GenerateUuid();case 5:return e.t2=e.sent,e.t3=new Date,e.t4={uuid:e.t2,dirty:!0,dirtiedDate:e.t3,lastSyncBegan:null,lastSyncEnd:null},a=(0,e.t0)(e.t1,e.t4),r.push(a),o=n.elementsReferencingElement(t),e.next=13,ha(o,[{uuid:a.uuid,content_type:a.content_type}],[t.uuid]);case 13:return s=e.sent,Object(u.j)(r,s),c=Object(P.b)(t,{deleted:!0,dirty:!1,content:void 0}),r.push(c),e.abrupt("return",r);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ha(e,t,n){return da.apply(this,arguments)}function da(){return(da=sa(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f,p,y,h,d,v;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=[],o=na(t);try{for(o.s();!(s=o.n()).done;){if(c=s.value,u=c.contentObject.references.slice(),n){l=na(n);try{for(l.s();!(f=l.n()).done;)p=f.value,u.push(p)}catch(e){l.e(e)}finally{l.f()}}if(r){y=na(r);try{for(y.s();!(h=y.n()).done;)d=h.value,vr()(u,{uuid:d})}catch(e){y.e(e)}finally{y.f()}}v=Object(P.b)(c,{dirty:!0,dirtiedDate:new Date,content:oa(oa({},c.safeContent),{},{references:u})}),a.push(v)}}catch(e){o.e(e)}finally{o.f()}return e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function va(e,t){var n=Nt(e),r=Nt(t);return n.isItemContentEqualWith(r)}var ma=n(5);function ba(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ga(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ba(Object(n),!0).forEach((function(t){wa(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ba(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function wa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ka(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Sa(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ka(o,r,a,i,s,"next",e)}function s(e){ka(o,r,a,i,s,"throw",e)}i(void 0)}))}}function xa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Oa=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseCollection=t,this.basePayload=n,this.applyPayload=r,this.source=a}var t,n,r,a,o;return t=e,(n=[{key:"resultingCollection",value:(o=Sa(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Nt(this.basePayload),n=Nt(this.applyPayload),r=t.strategyWhenConflictingWithItem(n),e.next=5,this.payloadsByHandlingStrategy(r);case 5:return a=e.sent,e.abrupt("return",ta.WithPayloads(a,this.source));case 7:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"payloadsByHandlingStrategy",value:(a=Sa(i.a.mark((function e(t){var n,r,a,o,s,c,l,f,p,y,h,d;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.baseCollection.conflictsOf(this.applyPayload.uuid)[0])||!va(n,this.applyPayload)){e.next=3;break}return e.abrupt("return",[]);case 3:if(t!==te.a.KeepLeft){e.next=7;break}return r=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),a=Object(P.b)(this.basePayload,{updated_at:r,dirty:!0,dirtiedDate:new Date}),e.abrupt("return",[a]);case 7:if(t!==te.a.KeepRight){e.next=10;break}return o=Object(P.g)(this.applyPayload,this.basePayload,[ma.a.LastSyncBegan],{lastSyncEnd:new Date}),e.abrupt("return",[o]);case 10:if(t!==te.a.KeepLeftDuplicateRight){e.next=17;break}return s=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),c=Object(P.b)(this.basePayload,{updated_at:s,dirty:!0,dirtiedDate:new Date}),e.next=15,la(this.applyPayload,this.baseCollection,!0);case 15:return l=e.sent,e.abrupt("return",[c].concat(l));case 17:if(t!==te.a.DuplicateLeftKeepRight){e.next=23;break}return e.next=20,la(this.basePayload,this.baseCollection,!0);case 20:return f=e.sent,p=Object(P.g)(this.applyPayload,this.basePayload,[ma.a.LastSyncBegan],{lastSyncEnd:new Date}),e.abrupt("return",f.concat([p]));case 23:if(t!==te.a.KeepLeftMergeRefs){e.next=28;break}return y=Object(u.J)(this.basePayload.contentObject.references,this.applyPayload.contentObject.references,["uuid","content_type"]),h=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),d=Object(P.b)(this.basePayload,{updated_at:h,dirty:!0,dirtiedDate:new Date,content:ga(ga({},this.basePayload.safeContent),{},{references:y})}),e.abrupt("return",[d]);case 28:throw"Unhandled strategy";case 29:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}])&&xa(t.prototype,n),r&&xa(t,r),e}();function Pa(e){return(Pa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ja(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Da(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Da(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Da(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ca(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function _a(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Ca(o,r,a,i,s,"next",e)}function s(e){Ca(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ia(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ra(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ea(e,t){return(Ea=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Aa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ta(e);if(t){var a=Ta(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ma(this,n)}}function Ma(e,t){return!t||"object"!==Pa(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ta(e){return(Ta=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ka=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ea(e,t)}(c,e);var t,n,r,a,o,s=Aa(c);function c(){return Ia(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(o=_a(i.a.mark((function e(){var t,n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=ja(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=13;break}return a=r.value,e.next=8,this.payloadsByHandlingPayload(a,t);case 8:o=e.sent,s=o.map((function(e){return Object(P.b)(e,{dirty:!0,dirtiedDate:new Date,deleted:!1})})),Object(u.j)(t,s);case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),n.e(e.t0);case 18:return e.prev=18,n.f(),e.finish(18);case 21:return e.abrupt("return",ta.WithPayloads(t,j.a.FileImport));case 22:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),function(){return o.apply(this,arguments)})},{key:"payloadsByHandlingPayload",value:(a=_a(i.a.mark((function e(t,n){var r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=n.find((function(e){return e.contentObject.conflict_of===t.uuid})))||(r=n.find((function(e){return e.uuid===t.uuid}))),r||(r=this.findBasePayload(t.uuid)),r){e.next=5;break}return e.abrupt("return",[t]);case 5:return a=new Oa(this.baseCollection,r,t,j.a.FileImport),e.next=8,a.resultingCollection();case 8:return o=e.sent,e.abrupt("return",o.all());case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})}])&&Ra(t.prototype,n),r&&Ra(t,r),c}(Fr);function Fa(e){return(Fa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function La(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Va(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Va(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Va(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Na(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ua(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Na(o,r,a,i,s,"next",e)}function s(e){Na(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Wa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ba(e,t,n){return(Ba="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ja(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ha(e,t){return(Ha=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function za(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ja(e);if(t){var a=Ja(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return qa(this,n)}}function qa(e,t){return!t||"object"!==Fa(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ja(e){return(Ja=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ga=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ha(e,t)}(y,e);var t,n,r,a,o,c,l,f,p=za(y);function y(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,y),(e=p.call(this)).changeObservers=[],e.emitQueue=[],e.collection=new Jr,e}return t=y,(n=[{key:"getMasterCollection",value:function(){return ta.FromCollection(this.collection)}},{key:"deinit",value:function(){Ba(Ja(y.prototype),"deinit",this).call(this),this.changeObservers.length=0,this.resetState()}},{key:"resetState",value:function(){this.collection=new Jr}},{key:"find",value:function(e){return this.collection.findAll(e)}},{key:"emitCollection",value:(f=Ua(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.emitPayloads(t.all(),t.source,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"emitPayload",value:(l=Ua(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.emitPayloads([t],n,r);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"emitPayloads",value:(c=Ua(i.a.mark((function e(t,n,r){var a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return 0===t.length&&console.warn("Attempting to emit 0 payloads."),e.abrupt("return",new Promise((function(e){a.emitQueue.push({payloads:t,source:n,sourceKey:r,resolve:e}),1===a.emitQueue.length&&a.popQueue()})));case 2:case"end":return e.stop()}}),e)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"popQueue",value:(o=Ua(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.emitQueue[0],n=this.mergePayloadsOntoMaster(t.payloads),r=n.changed,a=n.inserted,o=n.discarded,this.notifyChangeObservers(r,a,o,t.source,t.sourceKey),Object(u.B)(this.emitQueue,t),t.resolve(),this.emitQueue.length>0&&this.popQueue();case 6:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"mergePayloadsOntoMaster",value:function(e){var t,n=[],r=[],a=[],o=La(e);try{for(o.s();!(t=o.n()).done;){var i=t.value;if(i.uuid&&i.content_type){var s=this.collection.find(i.uuid),c=s?Object(P.g)(s,i):i;c.discardable?(this.collection.discard(c),a.push(c)):(this.collection.set(c),s?n.push(c):r.push(c))}else console.error("Payload is corrupt:",i)}}catch(e){o.e(e)}finally{o.f()}return{changed:n,inserted:r,discarded:a}}},{key:"addObserver",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Array.isArray(e)||(e=[e]);var a={types:e,priority:r,callback:t};return this.changeObservers.push(a),function(){Object(u.B)(n.changeObservers,a)}}},{key:"notifyChangeObservers",value:function(e,t,n,r,a){var o,i=function(e,t){return t.includes(O.a.Any)?e.slice():e.slice().filter((function(e){return t.includes(e.content_type)}))},s=La(this.changeObservers.slice().sort((function(e,t){return e.priority<t.priority?-1:1})));try{for(s.s();!(o=s.n()).done;){var c=o.value;c.callback(i(e,c.types),i(t,c.types),i(n,c.types),r,a)}}catch(e){s.e(e)}finally{s.f()}}},{key:"importPayloads",value:(a=Ua(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Ka(this.getMasterCollection(),ta.WithPayloads(t,j.a.FileImport)),e.next=3,n.resultingCollection();case 3:return r=e.sent,e.next=6,this.emitCollection(r);case 6:return e.abrupt("return",Object(s.b)(r.payloads));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"removePayloadLocally",value:function(e){this.collection.discard(e)}}])&&Wa(t.prototype,n),r&&Wa(t,r),y}(Jt.a),$a=n(8);function Qa(e){return(Qa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ya(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Xa(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Xa(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Xa(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Za(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function eo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Za(o,r,a,i,s,"next",e)}function s(e){Za(o,r,a,i,s,"throw",e)}i(void 0)}))}}function to(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function no(e,t,n){return(no="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=io(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ro(e,t){return(ro=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ao(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=io(e);if(t){var a=io(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return oo(this,n)}}function oo(e,t){return!t||"object"!==Qa(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function io(e){return(io=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var so=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ro(e,t)}(f,e);var t,n,r,a,o,c,l=ao(f);function f(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(n=l.call(this)).resolveQueue=[],n.registeredPredicates=[],n.itemManager=e,n.syncService=t,n.addObservers(),n}return t=f,(n=[{key:"deinit",value:function(){this.syncService=void 0,this.itemManager=void 0,this.resolveQueue.length=0,this.registeredPredicates.length=0,this.removeItemObserver(),this.removeItemObserver=void 0,this.removeSyncObserver(),this.removeSyncObserver=void 0,no(io(f.prototype),"deinit",this).call(this)}},{key:"popResolveQueue",value:function(){var e=this.resolveQueue.slice();return this.resolveQueue=[],e}},{key:"addObservers",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(O.a.Any,(function(t,n){n.length>0&&(e.resolveQueue=e.resolveQueue.concat(n))})),this.removeSyncObserver=this.syncService.addEventObserver(function(){var t=eo(i.a.mark((function t(n){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==$a.a.DownloadFirstSyncCompleted&&n!==$a.a.FullSyncCompleted){t.next=3;break}return t.next=3,e.resolveSingletonsForItems(e.popResolveQueue(),n);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"registerPredicate",value:function(e){this.registeredPredicates.push(e)}},{key:"validItemsMatchingPredicate",value:function(e){return this.itemManager.itemsMatchingPredicate(e).filter((function(e){return!e.errorDecrypting}))}},{key:"resolveSingletonsForItems",value:(c=eo(i.a.mark((function e(t,n){var r,a,o,s,c,l,f,p,y=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=function(e){var t,n=Ya(y.registeredPredicates);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(e.satisfiesPredicate(r))return y.validItemsMatchingPredicate(r)}}catch(e){n.e(e)}finally{n.f()}},a=function(e){return e.isSingleton?y.validItemsMatchingPredicate(e.singletonPredicate):null},o=function(e){var t=a(e);return t&&t.length>0?t:r(e)},s=[],c=Ya(t),e.prev=5,c.s();case 7:if((l=c.n()).done){e.next=19;break}if(f=l.value,!s.includes(f)){e.next=11;break}return e.abrupt("continue",17);case 11:if(p=o(f),Object(u.j)(s,p||[]),p&&!(p.length<=1)){e.next=15;break}return e.abrupt("continue",17);case 15:return e.next=17,this.handleStrategy(p,f.singletonStrategy);case 17:e.next=7;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(5),c.e(e.t0);case 24:return e.prev=24,c.f(),e.finish(24);case 27:s.length>0&&n===$a.a.FullSyncCompleted&&setTimeout((function(){y.syncService.sync()}));case 28:case"end":return e.stop()}}),e,this,[[5,21,24,27]])}))),function(e,t){return c.apply(this,arguments)})},{key:"handleStrategy",value:(o=eo(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n===d.e.KeepEarliest){e.next=2;break}throw"Unhandled singleton strategy";case 2:return r=t.sort((function(e,t){return e.errorDecrypting?1:t.errorDecrypting||e.created_at<t.created_at?-1:1})),a=Object(u.d)(r,0),e.next=6,this.itemManager.setItemsToBeDeleted(Object(s.b)(a));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"findOrCreateSingleton",value:(a=eo(i.a.mark((function e(t,n,r){var a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=eo(i.a.mark((function e(o){var c,u,l,f,p,y,d;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((c=a.validItemsMatchingPredicate(t)).length>0)){e.next=3;break}return e.abrupt("return",o(c[0]));case 3:if(a.syncService.getLastSyncDate()){e.next=14;break}return u=!1,l=a.itemManager.addObserver(n,(function(e,n){if(n.length>0){var r=a.itemManager.subItemsMatchingPredicates(n,[t]);r.length>0&&(u=!0,o(r[0]))}})),e.next=8,a.syncService.sync();case 8:if(l(),!u){e.next=11;break}return e.abrupt("return");case 11:if(!((f=a.validItemsMatchingPredicate(t)).length>0)){e.next=14;break}return e.abrupt("return",o(f[0]));case 14:return p=a.itemManager.itemsMatchingPredicate(t).filter((function(e){return e.errorDecrypting})),e.next=17,a.itemManager.setItemsToBeDeleted(Object(s.b)(p));case 17:return e.t0=P.e,e.next=20,h.GenerateUuid();case 20:return e.t1=e.sent,e.t2=n,e.t3=r,e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},y=(0,e.t0)(e.t5),e.next=28,a.itemManager.emitItemFromPayload(y);case 28:if(d=e.sent){e.next=31;break}throw Error("Created singleton item should not be null ".concat(n));case 31:return e.next=33,a.syncService.sync();case 33:return e.abrupt("return",o(d));case 34:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n){return a.apply(this,arguments)})}])&&to(t.prototype,n),r&&to(t,r),f}(Jt.a);function co(e){return(co="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function uo(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return lo(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return lo(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function lo(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function fo(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function po(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){fo(o,r,a,i,s,"next",e)}function s(e){fo(o,r,a,i,s,"throw",e)}i(void 0)}))}}function yo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ho(e,t,n){return(ho="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=go(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function vo(e,t){return(vo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function mo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=go(e);if(t){var a=go(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return bo(this,n)}}function bo(e,t){return!t||"object"!==co(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function go(e){return(go=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var wo=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&vo(e,t)}(d,e);var t,n,r,a,o,s,c,u,l,f,p,y,h=mo(d);function d(e,t,n,r,a,o,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d),(s=h.call(this)).previousPasswords=[],s.itemManager=e,s.alertService=t,s.deviceInterface=n,s.httpService=r,s.modelManager=a,s.protocolService=o,s.syncService=i,s.previousPasswords=[],s}return t=d,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.alertService=void 0,this.deviceInterface=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.syncService=void 0,this.previousPasswords.length=0,ho(go(d.prototype),"deinit",this).call(this)}},{key:"getExtensions",value:function(){return this.itemManager.nonErroredItemsForContentType(O.a.ActionsExtension)}},{key:"extensionsInContextOfItem",value:function(e){return this.getExtensions().filter((function(t){return t.supported_types.includes(e.content_type)||t.actionsWithContextForItem(e).length>0}))}},{key:"loadExtensionInContextOfItem",value:(y=po(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={content_type:n.content_type,item_uuid:n.uuid},e.next=3,this.httpService.getAbsolute(t.url,r).catch((function(e){return console.error("Error loading extension",e),null}));case 3:if(a=e.sent){e.next=6;break}return e.abrupt("return");case 6:return o=a.description||t.description,s=a.supported_types||t.supported_types,c=a.actions?a.actions.map((function(e){return new Te(e)})):[],e.next=11,this.itemManager.changeActionsExtension(t.uuid,(function(e){e.description=o,e.supported_types=s,e.actions=c,e.hidden=!1}));case 11:return e.abrupt("return",this.itemManager.findItem(t.uuid));case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"runAction",value:(p=po(i.a.mark((function e(t,n,r){var a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.verb,e.next="get"===e.t0?3:"render"===e.t0?7:"show"===e.t0?11:"post"===e.t0?15:19;break;case 3:return e.next=5,this.handleGetAction(t,r);case 5:return a=e.sent,e.abrupt("break",20);case 7:return e.next=9,this.handleRenderAction(t,r);case 9:return a=e.sent,e.abrupt("break",20);case 11:return e.next=13,this.handleShowAction(t);case 13:return a=e.sent,e.abrupt("break",20);case 15:return e.next=17,this.handlePostAction(t,n);case 17:return a=e.sent,e.abrupt("break",20);case 19:return e.abrupt("break",20);case 20:return e.abrupt("return",a);case 21:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return p.apply(this,arguments)})},{key:"handleGetAction",value:(f=po(i.a.mark((function e(t,n){var r=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){r.alertService.confirm("Are you sure you want to replace the current note contents with this action's results?",void 0,void 0,void 0,(function(){r.runConfirmedGetAction(t,n).then((function(t){e(t)}))}),(function(){e({error:{message:"Action canceled by user."}})}))})));case 1:case"end":return e.stop()}}),e)}))),function(e,t){return f.apply(this,arguments)})},{key:"runConfirmedGetAction",value:(l=po(i.a.mark((function e(t,n){var r,a,o=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpService.getAbsolute(t.url).catch((function(e){var t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return o.alertService.alert(t.message),{error:t}}));case 2:if(!(r=e.sent).error){e.next=5;break}return e.abrupt("return",{response:r});case 5:return e.next=7,this.payloadByDecryptingResponse(r,n);case 7:return a=e.sent,e.next=10,this.modelManager.emitPayload(Object(P.b)(a,{dirty:!0,dirtiedDate:new Date}),j.a.RemoteActionRetrieved);case 10:return this.syncService.sync(),e.abrupt("return",{response:r,item:r.item});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"handleRenderAction",value:(u=po(i.a.mark((function e(t,n){var r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpService.getAbsolute(t.url).then(function(){var e=po(i.a.mark((function e(t){var r,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.payloadByDecryptingResponse(t,n);case 2:if(!(r=e.sent)){e.next=8;break}return e.next=6,a.itemManager.createItem(r.content_type,r.contentObject);case 6:return o=e.sent,e.abrupt("return",{response:t,item:o});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){var t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return a.alertService.alert(t.message),{error:t}}));case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"payloadByDecryptingResponse",value:(c=po(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f,p,y;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(P.e)(t.item),e.next=3,this.protocolService.payloadByDecryptingPayload(a,r);case 3:if((o=e.sent).errorDecrypting){e.next=6;break}return e.abrupt("return",o);case 6:if(t.auth_params){e.next=9;break}return this.alertService.alert("We were unable to decrypt this revision using your current keys, and this revision is missing metadata that would allow us to try different keys to decrypt it. This can likely be fixed with some manual intervention. Please email hello@standardnotes.org for assistance."),e.abrupt("return",void 0);case 9:s=[],c=uo(this.previousPasswords),e.prev=11,c.s();case 13:if((u=c.n()).done){e.next=30;break}if(l=u.value,!s.includes(l)){e.next=17;break}return e.abrupt("continue",28);case 17:return s.push(l),e.next=20,this.protocolService.computeRootKey(l,t.auth_params);case 20:if(f=e.sent){e.next=23;break}return e.abrupt("continue",28);case 23:return e.next=25,this.payloadByDecryptingResponse(t,n,f);case 25:if(!(p=e.sent)){e.next=28;break}return e.abrupt("return",p);case 28:e.next=13;break;case 30:e.next=35;break;case 32:e.prev=32,e.t0=e.catch(11),c.e(e.t0);case 35:return e.prev=35,c.f(),e.finish(35);case 38:return e.next=40,n();case 40:return y=e.sent,this.previousPasswords.push(y),e.abrupt("return",this.payloadByDecryptingResponse(t,n,r));case 43:case"end":return e.stop()}}),e,this,[[11,32,35,38]])}))),function(e,t,n){return c.apply(this,arguments)})},{key:"handlePostAction",value:(s=po(i.a.mark((function e(t,n){var r,a,o,s=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.access_type===Ie.Decrypted,e.next=3,this.outgoingPayloadForItem(n,r);case 3:return a=e.sent,o={items:[a]},e.abrupt("return",this.httpService.postAbsolute(t.url,o).then((function(e){return{response:e}})).catch((function(e){return console.error("Action error response:",e),s.alertService.alert("An issue occurred while processing this action. Please try again."),{response:e}})));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"handleShowAction",value:(o=po(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.deviceInterface.openUrl(t.url),e.abrupt("return",{response:void 0});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"outgoingPayloadForItem",value:(a=po(i.a.mark((function e(t){var n,r,a,o=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]&&o[1],r=n?qt.a.FileDecrypted:qt.a.FileEncrypted,e.next=4,this.protocolService.payloadByEncryptingPayload(t.payloadRepresentation(),r);case 4:return a=e.sent,e.abrupt("return",a.ejected());case 6:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}])&&yo(t.prototype,n),r&&yo(t,r),d}(Jt.a);function ko(e){return(ko="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function So(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function xo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Oo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Po(e,t){return(Po=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function jo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Co(e);if(t){var a=Co(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Do(this,n)}}function Do(e,t){return!t||"object"!==ko(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Co(e){return(Co=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var _o=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Po(e,t)}(u,e);var t,n,r,a,o,c=jo(u);function u(){return xo(this,u),c.apply(this,arguments)}return t=u,n=[{key:"compare",value:function(e){if(this.version!==e.version)return!1;var t=this.serverPassword&&e.serverPassword;return this.masterKey===e.masterKey&&(!t||this.serverPassword===e.serverPassword)}},{key:"getPersistableValue",value:function(){var e={version:this.version};return this.masterKey&&(e.masterKey=this.masterKey),this.dataAuthenticationKey&&(e.dataAuthenticationKey=this.dataAuthenticationKey),e}},{key:"version",get:function(){if(!this.payload.safeContent.version)throw"Attempting to create key without version.";return this.payload.safeContent.version}},{key:"isRootKey",get:function(){return!0}},{key:"itemsKey",get:function(){return this.masterKey}},{key:"masterKey",get:function(){return this.payload.safeContent.masterKey}},{key:"serverPassword",get:function(){return this.payload.safeContent.serverPassword}},{key:"dataAuthenticationKey",get:function(){return this.payload.safeContent.dataAuthenticationKey}}],r=[{key:"Create",value:(a=i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=4;break}return e.next=3,h.GenerateUuid();case 3:n=e.sent;case 4:return t.version||(t.dataAuthenticationKey?t.version=St.a.V002:t.version=St.a.V001),r=Object(P.e)({uuid:n,content_type:O.a.RootKey,content:Object(s.a)(t)}),e.abrupt("return",new u(r));case 7:case"end":return e.stop()}}),e)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){So(o,n,r,i,s,"next",e)}function s(e){So(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e,t){return o.apply(this,arguments)})}],n&&Oo(t.prototype,n),r&&Oo(t,r),u}(d.d);function Io(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ro(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Eo=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services=t,this.stageHandlers={},this.registerStageHandlers()}var t,n,r,a,o;return t=e,n=[{key:"registerStageHandler",value:function(e,t){this.stageHandlers[e]=t}},{key:"markDone",value:function(){var e;null===(e=this.onDoneHandler)||void 0===e||e.call(this),this.onDoneHandler=void 0}},{key:"onDone",value:function(e){this.onDoneHandler=e}},{key:"handleStage",value:(a=i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.stageHandlers[t])){e.next=4;break}return e.next=4,n();case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Io(o,n,r,i,s,"next",e)}function s(e){Io(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e){return o.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){throw"Must override"}}],n&&Ro(t.prototype,n),r&&Ro(t,r),e}();function Ao(e){return(Ao="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Mo(e){return function(e){if(Array.isArray(e))return Lo(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||Fo(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function To(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=Fo(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Ko(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||Fo(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Fo(e,t){if(e){if("string"==typeof e)return Lo(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Lo(e,t):void 0}}function Lo(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Vo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function No(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Uo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){No(o,r,a,i,s,"next",e)}function s(e){No(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Wo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Bo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ho(e,t){return(Ho=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function zo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Jo(e);if(t){var a=Jo(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return qo(this,n)}}function qo(e,t){return!t||"object"!==Ao(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Jo(e){return(Jo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Go={WebPasscodeParamsKey:"offlineParams",MobilePasscodeParamsKey:"pc_params",AllAccountKeyParamsKey:"auth_params",WebEncryptedStorageKey:"encryptedStorage",MobileWrappedRootKeyKey:"encrypted_account_keys",AllMigrations:"migrations"},$o=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ho(e,t)}(x,e);var t,n,r,o,c,l,f,d,v,m,b,w,k,S=zo(x);function x(){return Wo(this,x),S.apply(this,arguments)}return t=x,n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,Uo(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!gr(e.services.environment)){t.next=4;break}return t.abrupt("return",e.migrateStorageStructureForWebDesktop());case 4:if(!wr(e.services.environment)){t.next=6;break}return t.abrupt("return",e.migrateStorageStructureForMobile());case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.StorageDecrypted_09,Uo(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateArbitraryRawStorageToManagedStorageAllPlatforms();case 2:return t.next=4,e.migrateSessionStorage();case 4:return t.next=6,e.deleteLegacyStorageValues();case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.LoadingDatabase_11,Uo(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.createDefaultItemsKeyForAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateStorageStructureForWebDesktop",value:(k=Uo(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f,p,y,h,d,v,m,b,g,w,k;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.services.deviceInterface,Vo(t={},zt.Wrapped,{}),Vo(t,zt.Unwrapped,{}),Vo(t,zt.Nonwrapped,{}),r=t,e.next=4,n.getJsonParsedStorageValue(Go.AllAccountKeyParamsKey);case 4:return(a=e.sent)&&(r.nonwrapped[Lt.RootKeyParams]=a),e.next=8,n.getJsonParsedStorageValue(Go.WebEncryptedStorageKey);case 8:if(!(o=e.sent)){e.next=36;break}return s=Object(P.e)(o),e.next=13,this.webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(s);case 13:if(c=e.sent,l=c.key,f=c.decryptedStoragePayload,p=c.keyParams,r.nonwrapped[Lt.RootKeyWrapperKeyParams]=p.getPortableValue(),y=Object(u.a)(f.contentObject.storage),h=Object(u.v)(y),r.nonwrapped[Lt.RootKeyParams]=h[Go.AllAccountKeyParamsKey],d=l,Object(u.p)(h.mk)){e.next=31;break}return e.next=26,this.webDesktopHelperExtractAndWrapAccountKeysFromValueStore(l,h);case 26:v=e.sent,m=v.accountKey,b=v.wrappedKey,d=m,r.nonwrapped[Lt.WrappedRootKey]=b;case 31:return e.next=33,this.webDesktopHelperEncryptStorage(d,f,h);case 33:r.wrapped=e.sent,e.next=55;break;case 36:return e.next=38,this.services.deviceInterface.getRawStorageValue("ak");case 38:return g=e.sent,w=Object(u.p)(g)?St.a.V002:St.a.V003,e.t0=_o,e.next=43,this.services.deviceInterface.getRawStorageValue("mk");case 43:return e.t1=e.sent,e.next=46,this.services.deviceInterface.getRawStorageValue("pw");case 46:return e.t2=e.sent,e.t3=g,e.t4=w,e.t5={masterKey:e.t1,serverPassword:e.t2,dataAuthenticationKey:e.t3,version:e.t4},e.next=52,e.t0.Create.call(e.t0,e.t5);case 52:return k=e.sent,e.next=55,this.services.deviceInterface.setKeychainValue(k.getPersistableValue());case 55:return e.next=57,this.allPlatformHelperSetStorageStructure(r);case 57:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"allPlatformHelperSetStorageStructure",value:(w=Uo(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=sn.defaultValuesObject(t.wrapped,t.unwrapped,t.nonwrapped))[zt.Unwrapped]=void 0,e.next=4,this.services.deviceInterface.setRawStorageValue(Ut(this.services.namespace,Ft.StorageObject),JSON.stringify(n));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage",value:(b=Uo(i.a.mark((function e(t){var n,r,a,o,s,c,u,l,f,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(Go.WebPasscodeParamsKey);case 2:n=e.sent,r=this.services.protocolService.createKeyParams(n),o=!0,c=new g([p.LocalPasscode],y.Migration);case 6:if(!o){e.next=23;break}return e.next=9,this.services.challengeService.promptForChallengeResponseWithCustomValidation(c);case 9:return u=e.sent,l=Ko(u,1),f=l[0],h=f.value,e.next=15,this.services.protocolService.computeRootKey(h,r);case 15:return s=e.sent,e.next=18,this.services.protocolService.payloadByDecryptingPayload(t,s);case 18:a=e.sent,o=a.errorDecrypting,this.services.challengeService.setValidationStatusForChallenge(c,f,!a.errorDecrypting),e.next=6;break;case 23:return e.abrupt("return",{decryptedStoragePayload:a,key:s,keyParams:r});case 24:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"webDesktopHelperExtractAndWrapAccountKeysFromValueStore",value:(m=Uo(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.ak?St.a.V003:St.a.V002,e.next=3,_o.Create({masterKey:n.mk,serverPassword:n.pw,dataAuthenticationKey:n.ak,version:a});case 3:if(o=e.sent,delete n.mk,delete n.pw,delete n.ak,s=Object(P.e)(o),!t){e.next=12;break}return e.next=11,this.services.protocolService.payloadByEncryptingPayload(s,qt.a.LocalStorageEncrypted,t);case 11:c=e.sent;case 12:return e.abrupt("return",{accountKey:o,wrappedKey:null===(r=c)||void 0===r?void 0:r.ejected()});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"webDesktopHelperEncryptStorage",value:(v=Uo(i.a.mark((function e(t,n,r){var a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.payloadByEncryptingPayload(Object(P.b)(n,{content_type:O.a.EncryptedStorage,content:r}),qt.a.LocalStoragePreferEncrypted,t);case 2:return a=e.sent,e.abrupt("return",a.ejected());case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return v.apply(this,arguments)})},{key:"migrateStorageStructureForMobile",value:(d=Uo(i.a.mark((function e(){var t,n,r,a,o,c,l,f,d,v,m,b,w,k,S,x,j,D,C,_,I,R,E=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(Go.MobileWrappedRootKeyKey);case 2:return r=e.sent,e.next=5,this.services.deviceInterface.getJsonParsedStorageValue(Go.AllAccountKeyParamsKey);case 5:return a=e.sent,e.next=8,this.services.deviceInterface.getJsonParsedStorageValue(Go.MobilePasscodeParamsKey);case 8:return o=e.sent,Vo(n={},zt.Nonwrapped,(Vo(t={},Lt.WrappedRootKey,r),Vo(t,Lt.RootKeyWrapperKeyParams,o),Vo(t,Lt.RootKeyParams,a),t)),Vo(n,zt.Unwrapped,{}),Vo(n,zt.Wrapped,{}),c=n,e.next=12,this.services.deviceInterface.getKeychainValue();case 12:if(l=e.sent,!o){e.next=59;break}if(f=this.services.protocolService.createKeyParams(o),d=function(){var e=Uo(i.a.mark((function e(){var t,n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=l.offline.pw,r=new g([p.LocalPasscode],y.Migration);case 2:if(n&&n.serverPassword===t){e.next=15;break}return e.next=5,E.services.challengeService.promptForChallengeResponseWithCustomValidation(r);case 5:return a=e.sent,o=Ko(a,1),s=o[0],c=s.value,e.next=11,E.services.protocolService.computeRootKey(c,f);case 11:n=e.sent,E.services.challengeService.setValidationStatusForChallenge(r,s,n.serverPassword===t),e.next=2;break;case 15:return e.abrupt("return",n);case 16:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),v=l.offline.timing,c.unwrapped[Lt.MobilePasscodeTiming]=v,m=l.biometrics_prefs,c.unwrapped[Lt.BiometricsState]=m.enabled,c.unwrapped[Lt.MobileBiometricsTiming]=m.timing,!r){e.next=39;break}return e.next=24,d();case 24:return b=e.sent,e.next=27,this.services.protocolService.payloadByDecryptingPayload(Object(P.e)(r),b);case 27:return w=e.sent,k=w.contentObject.accountKeys,S=Object(u.p)(k.ak)?St.a.V002:St.a.V003,x=Object(P.b)(w,{content:{masterKey:k.mk,serverPassword:k.pw,dataAuthenticationKey:k.ak,version:k.version||S,accountKeys:null}}),e.next=33,this.services.protocolService.payloadByEncryptingPayload(x,qt.a.LocalStoragePreferEncrypted,b);case 33:return j=e.sent,c.nonwrapped[Lt.WrappedRootKey]=j.ejected(),e.next=37,this.services.deviceInterface.clearKeychainValue();case 37:e.next=57;break;case 39:if(r){e.next=57;break}return e.next=42,d();case 42:return D=e.sent,e.t0=P.e,e.next=46,h.GenerateUuid();case 46:return e.t1=e.sent,e.t2=Object(s.a)(c.unwrapped),e.t3=O.a.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},C=(0,e.t0)(e.t4),e.next=53,this.services.protocolService.payloadByEncryptingPayload(C,qt.a.LocalStoragePreferEncrypted,D);case 53:return _=e.sent,c.wrapped=_.ejected(),e.next=57,this.services.deviceInterface.clearKeychainValue();case 57:e.next=67;break;case 59:if(!l||!l.mk){e.next=67;break}return I=Object(u.p)(l.ak)?St.a.V002:St.a.V003,e.next=64,_o.Create({masterKey:l.mk,serverPassword:l.pw,dataAuthenticationKey:l.ak,version:l.version||I});case 64:return R=e.sent,e.next=67,this.services.deviceInterface.setKeychainValue(R.getPersistableValue());case 67:return e.next=69,this.allPlatformHelperSetStorageStructure(c);case 69:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"migrateArbitraryRawStorageToManagedStorageAllPlatforms",value:(f=Uo(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f,p,y;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getAllRawStorageKeyValues();case 2:t=e.sent,n=Object(u.x)(Go),r=function(e){try{return JSON.parse(e)}catch(t){return e}},a=this.services.namespace,o=To(t),e.prev=7,o.s();case 9:if((s=o.n()).done){e.next=22;break}if(c=s.value,l=c.key,f=c.value,p=a&&a.length>0&&l.startsWith(a),!n.includes(l)&&!p){e.next=16;break}return e.abrupt("continue",20);case 16:if(Object(u.p)(f)){e.next=20;break}return y=r(f),e.next=20,this.services.storageService.setValue(l,y);case 20:e.next=9;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(7),o.e(e.t0);case 27:return e.prev=27,o.f(),e.finish(27);case 30:case"end":return e.stop()}}),e,this,[[7,24,27,30]])}))),function(){return f.apply(this,arguments)})},{key:"deleteLegacyStorageValues",value:(l=Uo(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=["mk","ak","jwt","ephemeral","cachedThemes"],n=[].concat(Mo(Object(u.x)(Lt)),Mo(Object(u.x)(Go)),t),r=To(n),e.prev=3,r.s();case 5:if((a=r.n()).done){e.next=11;break}return o=a.value,e.next=9,this.services.deviceInterface.removeRawStorageValue(o);case 9:e.next=5;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(3),r.e(e.t0);case 16:return e.prev=16,r.f(),e.finish(16);case 19:case"end":return e.stop()}}),e,this,[[3,13,16,19]])}))),function(){return l.apply(this,arguments)})},{key:"migrateSessionStorage",value:(c=Uo(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.services.storageService.getValue("jwt");case 3:if(t=e.sent){e.next=6;break}return e.abrupt("return");case 6:return n=new gn(t),e.next=9,this.services.storageService.setValue(Lt.Session,n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"createDefaultItemsKeyForAllPlatforms",value:(o=Uo(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.getRootKey();case 2:if(!(t=e.sent)){e.next=19;break}return e.next=6,this.services.protocolService.getRootKeyParams();case 6:return n=e.sent,e.t0=P.e,e.next=10,h.GenerateUuid();case 10:return e.t1=e.sent,e.t2=O.a.ItemsKey,e.t3=Object(s.a)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n.version}),e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},r=(0,e.t0)(e.t5),a=Nt(r),e.next=19,this.services.itemManager.emitItemFromPayload(a.payloadRepresentation(),j.a.LocalChanged);case 19:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){return new Date("2020-01-15").getTime()}}],n&&Bo(t.prototype,n),r&&Bo(t,r),x}(Eo);function Qo(e){return(Qo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Yo(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Xo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Yo(o,r,a,i,s,"next",e)}function s(e){Yo(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Zo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ei(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ti(e,t){return(ti=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ni(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ai(e);if(t){var a=ai(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ri(this,n)}}function ri(e,t){return!t||"object"!==Qo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ai(e){return(ai=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var oi=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ti(e,t)}(c,e);var t,n,r,o,s=ni(c);function c(){return Zo(this,c),s.apply(this,arguments)}return t=c,n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,Xo(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateMigrationTimestampAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateMigrationTimestampAllPlatforms",value:(o=Xo(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,n=0,r=["migrations","ephemeral","user","cachedThemes","syncToken","encryptedStorage"];case 3:if(!(n<r.length)){e.next=14;break}return a=r[n],e.next=7,this.services.deviceInterface.getRawStorageValue(a);case 7:if(!e.sent){e.next=11;break}return t=!0,e.abrupt("break",14);case 11:n++,e.next=3;break;case 14:return o=Ut(this.services.namespace,Ft.LastMigrationTimestamp),e.next=17,this.services.deviceInterface.getRawStorageValue(o);case 17:if(s=e.sent,(c=!Object(u.p)(s))||!t){e.next=25;break}return l=new Date(0).getTime(),e.next=23,this.services.deviceInterface.setRawStorageValue(o,l);case 23:e.next=32;break;case 25:if(c||t){e.next=31;break}return f=(new Date).getTime(),e.next=29,this.services.deviceInterface.setRawStorageValue(o,f);case 29:e.next=32;break;case 31:case 32:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){return new Date("2020-01-01").getTime()}}],n&&ei(t.prototype,n),r&&ei(t,r),c}(Eo);function ii(e){return(ii="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function si(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ci(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ci(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function ci(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ui(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function li(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ui(o,r,a,i,s,"next",e)}function s(e){ui(o,r,a,i,s,"throw",e)}i(void 0)}))}}function fi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function pi(e,t,n){return(pi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=vi(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function yi(e,t){return(yi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function hi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=vi(e);if(t){var a=vi(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return di(this,n)}}function di(e,t){return!t||"object"!==ii(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function vi(e){return(vi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var mi=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&yi(e,t)}(b,e);var t,n,o,s,l,f,p,y,h,d,v,m=hi(b);function b(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,b),(t=m.call(this)).services=e,t.handledFullSyncStage=!1,t}return t=b,(n=[{key:"deinit",value:function(){this.services=void 0,this.activeMigrations&&(this.activeMigrations.length=0),pi(vi(b.prototype),"deinit",this).call(this)}},{key:"initialize",value:(v=li(i.a.mark((function e(){var t,n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runBaseMigration();case 2:return e.next=4,this.getRequiredMigrations();case 4:this.activeMigrations=e.sent,this.activeMigrations.length>0&&(t=Object(u.w)(this.activeMigrations)).onDone(li(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.saveLastMigrationTimestamp(t.constructor.timestamp());case 2:case"end":return e.stop()}}),e)}))));case 6:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"handleApplicationStage",value:(d=li(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,pi(vi(b.prototype),"handleApplicationStage",this).call(this,t);case 2:return e.next=4,this.handleStage(t);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"handleApplicationEvent",value:(h=li(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==c.a.SignedIn){e.next=5;break}return e.next=3,this.handleStage(a.SignedIn_30);case 3:e.next=10;break;case 5:if(t!==c.a.CompletedFullSync){e.next=10;break}if(this.handledFullSyncStage){e.next=10;break}return this.handledFullSyncStage=!0,e.next=10,this.handleStage(a.FullSyncCompleted_13);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"runBaseMigration",value:(y=li(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new oi(this.services),e.next=3,t.handleStage(a.PreparingForLaunch_0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"getRequiredMigrations",value:(p=li(i.a.mark((function e(){var t,n,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastMigrationTimestamp();case 2:t=e.sent,n=[],a=Object.keys(r).map((function(e){return r[e]})).sort((function(e,t){var n=e.timestamp(),r=t.timestamp();return n<r?-1:n>r?1:0})),o=si(a);try{for(o.s();!(s=o.n()).done;)(c=s.value).timestamp()>t&&n.push(new c(this.services))}catch(e){o.e(e)}finally{o.f()}return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getTimeStampKey",value:function(){return Ut(this.services.namespace,Ft.LastMigrationTimestamp)}},{key:"getLastMigrationTimestamp",value:(f=li(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getRawStorageValue(this.getTimeStampKey());case 2:if(t=e.sent,!Object(u.p)(t)){e.next=5;break}throw"Timestamp should not be null. Be sure to run base migration first.";case 5:return e.abrupt("return",JSON.parse(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"saveLastMigrationTimestamp",value:(l=li(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.setRawStorageValue(this.getTimeStampKey(),JSON.stringify(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"handleStage",value:(s=li(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=si(this.activeMigrations),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return a=r.value,e.next=7,a.handleStage(t);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e){return s.apply(this,arguments)})}])&&fi(t.prototype,n),o&&fi(t,o),b}(Jt.a);function bi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function gi(e){return new Oi(e)}var wi,ki,Si,xi,Oi=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.content=t}var t,n,r;return t=e,(n=[{key:"getPortableValue",value:function(){return Object(St.b)(this.version,St.a.V003)>=0?Object(u.y)(this.content,["pw_cost"]):this.content}},{key:"isKeyParamsObject",get:function(){return!0}},{key:"kdfIterations",get:function(){return this.content.pw_cost}},{key:"seed",get:function(){return this.content.pw_nonce}},{key:"identifier",get:function(){return this.content.identifier||this.content.email}},{key:"salt",get:function(){return this.content.pw_salt}},{key:"version",get:function(){return this.content.version}}])&&bi(t.prototype,n),r&&bi(t,r),e}();function Pi(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ji(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Pi(o,r,a,i,s,"next",e)}function s(e){Pi(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Di(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ci(e){return(Ci="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _i(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ii(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){_i(o,r,a,i,s,"next",e)}function s(e){_i(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ri(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ei(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ai(e,t,n){return(Ai="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Fi(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Mi(e,t){return(Mi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ti(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Fi(e);if(t){var a=Fi(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ki(this,n)}}function Ki(e,t){return!t||"object"!==Ci(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Fi(e){return(Fi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=512]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength"}(wi||(wi={})),function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(ki||(ki={})),function(e){e[e.SaltSeedLength=256]="SaltSeedLength",e[e.PbkdfCost=11e4]="PbkdfCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(Si||(Si={})),function(e){e[e.ArgonSaltSeedLength=256]="ArgonSaltSeedLength",e[e.ArgonSaltLength=128]="ArgonSaltLength",e[e.ArgonIterations=5]="ArgonIterations",e[e.ArgonMemLimit=67108864]="ArgonMemLimit",e[e.ArgonOutputKeyBytes=64]="ArgonOutputKeyBytes",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionNonceLength=192]="EncryptionNonceLength"}(xi||(xi={}));var Li="00000000000000000000000000000000",Vi=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Mi(e,t)}(h,e);var t,n,r,a,o,s,c,u,l,f,p,y=Ti(h);function h(){return Ri(this,h),y.apply(this,arguments)}return t=h,(n=[{key:"getEncryptionDisplayName",value:function(){return"AES-256"}},{key:"generateNewItemsKeyContent",value:(p=Ii(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=wi.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,r={itemsKey:n,version:this.version},e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"createRootKey",value:(f=Ii(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=wi.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey(wi.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+"SN"+a);case 6:return o=e.sent,e.next=9,this.deriveKey(n,o,r);case 9:return s=e.sent,c=gi({email:t,pw_cost:r,pw_nonce:a,pw_salt:o,version:this.version}),e.abrupt("return",{key:s,keyParams:c});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"computeRootKey",value:(l=Ii(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"decryptString",value:(u=Ii(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,Li,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"encryptString",value:(c=Ii(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,Li,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=Ii(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==lt.a.DecryptedBareObject&&n!==lt.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",Ai(Fi(h.prototype),"generateEncryptedParameters",this).call(this,t,n,r));case 2:if(n===lt.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(n);case 4:if(r){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*wi.EncryptionKeyLength);case 8:return a=e.sent,e.next=11,this.encryptString(a,r.itemsKey);case 11:return o=e.sent,e.next=14,this.firstHalfOfKey(a);case 14:return s=e.sent,e.next=17,this.secondHalfOfKey(a);case 17:return c=e.sent,e.next=20,this.encryptString(JSON.stringify(t.content),s);case 20:return u=e.sent,l=r.version+u,e.next=24,this.crypto.hmac256(l,c);case 24:return f=e.sent,e.abrupt("return",Object(P.c)({uuid:t.uuid,items_key_id:r instanceof Mt?r.uuid:void 0,content:l,enc_item_key:o,auth_hash:f}));case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(o=Ii(i.a.mark((function e(t,n){var r,a,o,s,c,u,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==lt.a.DecryptedBareObject&&r!==lt.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",Ai(Fi(h.prototype),"generateDecryptedParameters",this).call(this,t,n));case 3:if(t.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",t);case 6:return a=t.enc_item_key,a=this.version+a,o=this.encryptionComponentsFromString(a,n.itemsKey),e.next=11,this.decryptString(o.ciphertext,o.key);case 11:if(s=e.sent){e.next=15;break}return console.error("Error decrypting parameters",t),e.abrupt("return",Object(P.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 15:return e.next=17,this.firstHalfOfKey(s);case 17:return c=e.sent,u=this.encryptionComponentsFromString(t.contentString,c),e.next=21,this.decryptString(u.ciphertext,u.key);case 21:if(l=e.sent){e.next=26;break}return e.abrupt("return",Object(P.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 26:return e.abrupt("return",Object(P.a)(t,{content:JSON.parse(l),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===t.errorDecrypting,waitingForKey:!1}));case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"encryptionComponentsFromString",value:function(e,t){var n=e.substring(0,St.a.VersionLength);return{ciphertext:e.substring(St.a.VersionLength,e.length),version:n,key:t}}},{key:"deriveKey",value:(a=Ii(i.a.mark((function e(t,n,r){var a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,wi.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,2);case 5:return o=e.sent,e.next=8,_o.Create({serverPassword:o[0],masterKey:o[1],version:this.version});case 8:return s=e.sent,e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"version",get:function(){return St.a.V001}}])&&Ei(t.prototype,n),r&&Ei(t,r),h}(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.crypto=t}var t,n,r,a,o,c,u,l;return t=e,(n=[{key:"firstHalfOfKey",value:(l=ji(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(0,t.length/2));case 1:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},{key:"secondHalfOfKey",value:(u=ji(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(t.length/2,t.length));case 1:case"end":return e.stop()}}),e)}))),function(e){return u.apply(this,arguments)})},{key:"splitKey",value:function(e,t){for(var n=e.length/t,r=[],a=0;a<t;a++){var o=e.slice(n*a,n*(a+1));r.push(o)}return r}},{key:"createItemsKey",value:(c=ji(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateNewItemsKeyContent();case 2:return t=e.sent,e.t0=P.e,e.next=6,h.GenerateUuid();case 6:return e.t1=e.sent,e.t2=O.a.ItemsKey,e.t3=Object(s.a)(t),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},n=(0,e.t0)(e.t4),e.abrupt("return",Nt(n));case 12:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(o=ji(i.a.mark((function e(t,n,r){var a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==lt.a.DecryptedBareObject){e.next=4;break}return e.abrupt("return",Object(P.c)({content:t.content}));case 4:if(n!==lt.a.DecryptedBase64String){e.next=13;break}return a=JSON.stringify(t.content),e.next=8,this.crypto.base64Encode(a);case 8:return o=e.sent,s=St.a.V000Base64Decrypted+o,e.abrupt("return",Object(P.c)({content:s}));case 13:throw"Must override generateEncryptedParameters to handle format ".concat(n,".");case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(a=ji(i.a.mark((function e(t,n){var r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==lt.a.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(r!==lt.a.DecryptedBase64String){e.next=20;break}return a=t.contentString.substring(St.a.VersionLength,t.contentString.length),e.prev=7,e.next=10,this.crypto.base64Decode(a);case 10:s=e.sent,o=JSON.parse(s),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(7),o=t.content;case 17:return e.abrupt("return",Object(P.a)(t,{content:o}));case 20:throw"Must override generateDecryptedParameters to handle format ".concat(r,".");case 21:case"end":return e.stop()}}),e,this,[[7,14]])}))),function(e,t){return a.apply(this,arguments)})}])&&Di(t.prototype,n),r&&Di(t,r),e}());function Ni(e){return(Ni="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ui(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Wi(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Ui(o,r,a,i,s,"next",e)}function s(e){Ui(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Bi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Hi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function zi(e,t,n){return(zi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=$i(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function qi(e,t){return(qi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ji(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=$i(e);if(t){var a=$i(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Gi(this,n)}}function Gi(e,t){return!t||"object"!==Ni(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function $i(e){return($i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Qi=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qi(e,t)}(v,e);var t,n,r,a,o,s,c,u,l,f,p,y,h,d=Ji(v);function v(){return Bi(this,v),d.apply(this,arguments)}return t=v,(n=[{key:"generateNewItemsKeyContent",value:(h=Wi(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=ki.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,e.next=6,this.crypto.generateRandomKey(t);case 6:return r=e.sent,a={itemsKey:n,dataAuthenticationKey:r,version:this.version},e.abrupt("return",a);case 9:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"createRootKey",value:(y=Wi(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=ki.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey(ki.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+":"+a);case 6:return o=e.sent,e.next=9,this.deriveKey(n,o,r);case 9:return s=e.sent,c=gi({email:t,pw_cost:r,pw_nonce:a,pw_salt:o,version:this.version}),e.abrupt("return",{key:s,keyParams:c});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"computeRootKey",value:(p=Wi(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"decryptString002",value:(f=Wi(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"encryptString002",value:(l=Wi(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"encryptTextParams",value:(u=Wi(i.a.mark((function e(t,n,r,a,o){var s,c,u,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(ki.EncryptionIvLength);case 2:return s=e.sent,e.next=5,this.encryptString002(t,n,s);case 5:return c=e.sent,u=[o,a,s,c].join(":"),e.next=9,this.crypto.hmac256(u,r);case 9:return l=e.sent,f=[o,l,a,s,c].join(":"),e.abrupt("return",f);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return u.apply(this,arguments)})},{key:"decryptTextParams",value:(c=Wi(i.a.mark((function e(t,n,r,a,o,s){var c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"Attempting to decryptTextParams with null encryptionKey";case 2:return e.next=4,this.crypto.hmac256(t,s);case 4:if(c=e.sent,!1!==this.crypto.timingSafeEqual(o,c)){e.next=8;break}return console.error("Auth hash does not match, returning null."),e.abrupt("return",null);case 8:return e.abrupt("return",this.decryptString002(n,r,a));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a,o){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=Wi(i.a.mark((function e(t,n,r){var a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==lt.a.DecryptedBareObject&&n!==lt.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",zi($i(v.prototype),"generateEncryptedParameters",this).call(this,t,n,r));case 2:if(n===lt.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(n);case 4:if(r&&r.itemsKey){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*ki.EncryptionKeyLength);case 8:return a=e.sent,e.next=11,this.encryptTextParams(a,r.itemsKey,r.dataAuthenticationKey,t.uuid,r.version);case 11:return o=e.sent,e.next=14,this.firstHalfOfKey(a);case 14:return s=e.sent,e.next=17,this.secondHalfOfKey(a);case 17:return c=e.sent,e.next=20,this.encryptTextParams(JSON.stringify(t.content),s,c,t.uuid,r.version);case 20:return u=e.sent,e.abrupt("return",Object(P.c)({uuid:t.uuid,items_key_id:r instanceof Mt?r.uuid:void 0,content:u,enc_item_key:o}));case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(o=Wi(i.a.mark((function e(t,n){var r,a,o,s,c,u,l,f,p;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==lt.a.DecryptedBareObject&&r!==lt.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",zi($i(v.prototype),"generateDecryptedParameters",this).call(this,t,n));case 3:if(t.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",t);case 6:if(n&&n.itemsKey){e.next=8;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 8:return a=t.enc_item_key,o=this.encryptionComponentsFromString002(a,n.itemsKey,n.dataAuthenticationKey),e.next=12,this.decryptTextParams(o.ciphertextToAuth,o.contentCiphertext,o.encryptionKey,o.iv,o.authHash,o.authKey);case 12:if(s=e.sent){e.next=16;break}return console.error("Error decrypting item_key parameters",t),e.abrupt("return",Object(P.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 16:return e.next=18,this.firstHalfOfKey(s);case 18:return c=e.sent,e.next=21,this.secondHalfOfKey(s);case 21:return u=e.sent,l=this.encryptionComponentsFromString002(t.contentString,c,u),e.next=25,this.decryptTextParams(l.ciphertextToAuth,l.contentCiphertext,l.encryptionKey,l.iv,l.authHash,l.authKey);case 25:if(f=e.sent){e.next=30;break}return e.abrupt("return",Object(P.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 30:return e.prev=30,e.t0=JSON,e.next=34,this.crypto.base64Decode(l.authParams);case 34:e.t1=e.sent,p=e.t0.parse.call(e.t0,e.t1),e.next=40;break;case 38:e.prev=38,e.t2=e.catch(30);case 40:return e.abrupt("return",Object(P.a)(t,{content:JSON.parse(f),items_key_id:void 0,enc_item_key:void 0,auth_params:p,errorDecrypting:!1,errorDecryptingValueChanged:!0===t.errorDecrypting,waitingForKey:!1}));case 41:case"end":return e.stop()}}),e,this,[[30,38]])}))),function(e,t){return o.apply(this,arguments)})},{key:"deriveKey",value:(a=Wi(i.a.mark((function e(t,n,r){var a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,ki.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,3);case 5:return o=e.sent,e.next=8,_o.Create({serverPassword:o[0],masterKey:o[1],dataAuthenticationKey:o[2],version:this.version});case 8:return s=e.sent,e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"encryptionComponentsFromString002",value:function(e,t,n){var r=e.split(":");return{encryptionVersion:r[0],authHash:r[1],uuid:r[2],iv:r[3],contentCiphertext:r[4],authParams:r[5],ciphertextToAuth:[r[0],r[2],r[3],r[4]].join(":"),encryptionKey:t,authKey:n}}},{key:"version",get:function(){return St.a.V002}}])&&Hi(t.prototype,n),r&&Hi(t,r),v}(Vi);function Yi(e){return(Yi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Xi(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Zi(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Xi(o,r,a,i,s,"next",e)}function s(e){Xi(o,r,a,i,s,"throw",e)}i(void 0)}))}}function es(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ts(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ns(e,t){return(ns=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function rs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=os(e);if(t){var a=os(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return as(this,n)}}function as(e,t){return!t||"object"!==Yi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function os(e){return(os=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var is=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ns(e,t)}(u,e);var t,n,r,a,o,s,c=rs(u);function u(){return es(this,u),c.apply(this,arguments)}return t=u,(n=[{key:"computeRootKey",value:(s=Zi(i.a.mark((function e(t,n){var r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Si.PbkdfCost,a=this.version,e.next=4,this.generateSalt(n.identifier,a,r,n.seed);case 4:return o=e.sent,e.next=7,this.deriveKey(t,o,r);case 7:return s=e.sent,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"createRootKey",value:(o=Zi(i.a.mark((function e(t,n){var r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=Si.PbkdfCost,e.next=4,this.crypto.generateRandomKey(Si.SaltSeedLength);case 4:return o=e.sent,e.next=7,this.generateSalt(t,r,a,o);case 7:return s=e.sent,e.next=10,this.deriveKey(n,s,a);case 10:return c=e.sent,u=gi({identifier:t,pw_cost:a,pw_nonce:o,version:r}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"generateSalt",value:(a=Zi(i.a.mark((function e(t,n,r,a){var o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,"SF",n,r,a].join(":"));case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return a.apply(this,arguments)})},{key:"version",get:function(){return St.a.V003}}])&&ts(t.prototype,n),r&&ts(t,r),u}(Qi);function ss(e){return(ss="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function cs(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function us(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){cs(o,r,a,i,s,"next",e)}function s(e){cs(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ls(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ps(e,t,n){return(ps="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=vs(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ys(e,t){return(ys=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function hs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=vs(e);if(t){var a=vs(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ds(this,n)}}function ds(e,t){return!t||"object"!==ss(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function vs(e){return(vs=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ms,bs=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ys(e,t)}(m,e);var t,n,r,a,o,s,c,l,f,p,y,h,d,v=hs(m);function m(){return ls(this,m),v.apply(this,arguments)}return t=m,(n=[{key:"getEncryptionDisplayName",value:function(){return"XChaCha20"}},{key:"generateNewItemsKeyContent",value:(d=us(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(xi.EncryptionKeyLength);case 2:return t=e.sent,n={itemsKey:t,version:this.version},e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"generateSalt004",value:(h=us(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,n].join(":"));case 2:return r=e.sent,e.abrupt("return",Object(u.I)(r,xi.ArgonSaltLength));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"computeRootKey",value:(y=us(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateSalt004(n.identifier,n.seed);case 2:return r=e.sent,e.next=5,this.deriveKey(t,r,xi.ArgonIterations);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"createRootKey",value:(p=us(i.a.mark((function e(t,n){var r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=xi.ArgonIterations,e.next=4,this.crypto.generateRandomKey(xi.ArgonSaltSeedLength);case 4:return o=e.sent,e.next=7,this.generateSalt004(t,o);case 7:return s=e.sent,e.next=10,this.deriveKey(n,s,a);case 10:return c=e.sent,u=gi({identifier:t,pw_cost:a,pw_nonce:o,version:r}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"encryptString004",value:(f=us(i.a.mark((function e(t,n,r,a){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"encryptString null nonce";case 2:if(n){e.next=4;break}throw"encryptString null rawKey";case 4:return e.abrupt("return",this.crypto.xchacha20Encrypt(t,r,n,JSON.stringify(a)));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return f.apply(this,arguments)})},{key:"decryptString004",value:(l=us(i.a.mark((function e(t,n,r,a){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.xchacha20Decrypt(t,r,n,JSON.stringify(a)));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return l.apply(this,arguments)})},{key:"generateEncryptedProtocolString",value:(c=us(i.a.mark((function e(t,n,r){var a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(xi.EncryptionNonceLength);case 2:return a=e.sent,o=this.version,e.next=6,this.encryptString004(t,n,a,{u:r,v:o});case 6:return s=e.sent,c=[o,a,s].join(":"),e.abrupt("return",c);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=us(i.a.mark((function e(t,n,r){var a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==lt.a.DecryptedBareObject&&n!==lt.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",ps(vs(m.prototype),"generateEncryptedParameters",this).call(this,t,n,r));case 2:if(n===lt.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(n);case 4:if(t.uuid){e.next=6;break}throw"payload.uuid cannot be null";case 6:if(r&&r.itemsKey){e.next=8;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 8:return e.next=10,this.crypto.generateRandomKey(xi.EncryptionKeyLength);case 10:return a=e.sent,o=JSON.stringify(t.content),e.next=14,this.generateEncryptedProtocolString(o,a,t.uuid);case 14:return s=e.sent,e.next=17,this.generateEncryptedProtocolString(a,r.itemsKey,t.uuid);case 17:return c=e.sent,e.abrupt("return",Object(P.c)({uuid:t.uuid,items_key_id:r instanceof Mt?r.uuid:void 0,content:s,enc_item_key:c}));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(o=us(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==lt.a.DecryptedBareObject&&r!==lt.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",ps(vs(m.prototype),"generateDecryptedParameters",this).call(this,t,n));case 3:if(t.uuid){e.next=5;break}throw"encryptedParameters.uuid cannot be null";case 5:if(n&&n.itemsKey){e.next=7;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 7:return a=this.deconstructEncryptedPayloadString(t.enc_item_key),e.next=10,this.decryptString004(a.ciphertext,n.itemsKey,a.nonce,{u:t.uuid,v:a.version});case 10:if(o=e.sent){e.next=14;break}return console.error("Error decrypting itemKey parameters",t),e.abrupt("return",Object(P.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 14:return s=this.deconstructEncryptedPayloadString(t.contentString),e.next=17,this.decryptString004(s.ciphertext,o,s.nonce,{u:t.uuid,v:s.version});case 17:if(c=e.sent){e.next=22;break}return e.abrupt("return",Object(P.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 22:return e.abrupt("return",Object(P.a)(t,{content:JSON.parse(c),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===t.errorDecrypting,waitingForKey:!1}));case 23:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"deconstructEncryptedPayloadString",value:function(e){var t=e.split(":");return{version:t[0],nonce:t[1],ciphertext:t[2]}}},{key:"deriveKey",value:(a=us(i.a.mark((function e(t,n,r){var a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.argon2(t,n,r,xi.ArgonMemLimit,xi.ArgonOutputKeyBytes);case 2:return a=e.sent,o=this.splitKey(a,2),s=o[0],c=o[1],e.abrupt("return",_o.Create({masterKey:s,serverPassword:c,version:this.version}));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"version",get:function(){return St.a.V004}}])&&fs(t.prototype,n),r&&fs(t,r),m}(is);function gs(e){return(gs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ws(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||Ss(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ks(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=Ss(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Ss(e,t){if(e){if("string"==typeof e)return xs(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?xs(e,t):void 0}}function xs(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Os(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ps(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function js(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Ps(o,r,a,i,s,"next",e)}function s(e){Ps(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ds(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Cs(e,t,n){return(Cs="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=As(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function _s(e,t){return(_s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Is(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=As(e);if(t){var a=As(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Rs(this,n)}}function Rs(e,t){return!t||"object"!==gs(t)&&"function"!=typeof t?Es(e):t}function Es(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function As(e){return(As=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.RootKeyNone=0]="RootKeyNone",e[e.RootKeyOnly=1]="RootKeyOnly",e[e.RootKeyPlusWrapper=2]="RootKeyPlusWrapper",e[e.WrapperOnly=3]="WrapperOnly"}(ms||(ms={}));var Ms=St.a.V003,Ts=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_s(e,t)}(re,e);var t,n,r,a,o,l,f,p,y,d,v,m,b,g,w,k,S,x,D,C,_,I,R,E,A,M,T,K,F,L,V,N,U,W,B,H,z,q,J,G,$,Q,Y,X,Z,ee,te,ne=Is(re);function re(e,t,n,r,a){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,re),(o=ne.call(this)).operators={},o.keyMode=ms.RootKeyNone,o.keyObservers=[],o.itemManager=e,o.modelManager=t,o.deviceInterface=n,o.storageService=r,o.crypto=a,Object(u.r)()?h.SetGenerators(o.crypto.generateUUID,void 0):h.SetGenerators(o.crypto.generateUUID,o.crypto.generateUUIDSync),Object.defineProperty(Es(o),"rootKey",{enumerable:!1,writable:!0}),o.removeItemsObserver=o.itemManager.addObserver([O.a.ItemsKey],(function(e,t){t.length>0&&o.decryptErroredItems()})),o}return t=re,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.modelManager=void 0,this.deviceInterface=void 0,this.storageService=void 0,this.crypto.deinit(),this.crypto=void 0,this.operators={},this.keyObservers.length=0,this.removeItemsObserver(),this.removeItemsObserver=null,this.rootKey=void 0,Cs(As(re.prototype),"deinit",this).call(this)}},{key:"initialize",value:(te=js(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:return t=e.sent,e.next=5,this.getAccountKeyParams();case 5:return n=e.sent,e.next=8,this.hasRootKeyWrapper();case 8:if(r=e.sent,a=!Object(u.p)(t)||!Object(u.p)(n),!r||!a){e.next=14;break}this.keyMode=ms.RootKeyPlusWrapper,e.next=27;break;case 14:if(!r||a){e.next=18;break}this.keyMode=ms.WrapperOnly,e.next=27;break;case 18:if(r||!a){e.next=22;break}this.keyMode=ms.RootKeyOnly,e.next=27;break;case 22:if(r||a){e.next=26;break}this.keyMode=ms.RootKeyNone,e.next=27;break;case 26:throw"Invalid key mode condition";case 27:if(this.keyMode!==ms.RootKeyOnly){e.next=33;break}return e.next=30,this.getRootKeyFromKeychain();case 30:return this.rootKey=e.sent,e.next=33,this.notifyObserversOfKeyChange();case 33:case"end":return e.stop()}}),e,this)}))),function(){return te.apply(this,arguments)})},{key:"getDefaultOperatorEncryptionDisplayName",value:function(){return this.defaultOperator().getEncryptionDisplayName()}},{key:"getLatestVersion",value:function(){return St.a.V004}},{key:"hasAccount",value:function(){switch(this.keyMode){case ms.RootKeyNone:case ms.WrapperOnly:return!1;case ms.RootKeyOnly:case ms.RootKeyPlusWrapper:return!0;default:throw Error("Unhandled keyMode value '".concat(this.keyMode,"'."))}}},{key:"getUserVersion",value:(ee=js(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getAccountKeyParams();case 2:return t=e.sent,e.abrupt("return",t&&t.version);case 4:case"end":return e.stop()}}),e,this)}))),function(){return ee.apply(this,arguments)})},{key:"upgradeAvailable",value:(Z=js(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.accountUpgradeAvailable();case 2:return t=e.sent,e.next=5,this.passcodeUpgradeAvailable();case 5:return n=e.sent,e.abrupt("return",t||n);case 7:case"end":return e.stop()}}),e,this)}))),function(){return Z.apply(this,arguments)})},{key:"accountUpgradeAvailable",value:(X=js(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUserVersion();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return X.apply(this,arguments)})},{key:"passcodeUpgradeAvailable",value:(Y=js(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t.version!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return Y.apply(this,arguments)})},{key:"platformSupportsKeyDerivation",value:function(e){return Object(St.b)(e.version,St.a.V004)>=0||!!Object(u.t)()}},{key:"supportedVersions",value:function(){return[St.a.V001,St.a.V002,St.a.V003,St.a.V004]}},{key:"isVersionNewerThanLibraryVersion",value:function(e){var t=this.getLatestVersion();return 1===Object(St.b)(e,t)}},{key:"isProtocolVersionOutdated",value:function(e){var t,n=(Os(t={},St.a.V001,Date.parse("2018-01-01")),Os(t,St.a.V002,Date.parse("2020-01-01")),t)[e];return!!n&&(new Date).getTime()>n}},{key:"costMinimumForVersion",value:function(e){if(Object(St.b)(e,St.a.V003)>=0)throw"Cost minimums only apply to versions <= 002";if(e===St.a.V001)return wi.PbkdfMinCost;if(e===St.a.V002)return ki.PbkdfMinCost;throw"Invalid version for cost minimum: ".concat(e)}},{key:"createOperatorForLatestVersion",value:function(){return this.createOperatorForVersion(this.getLatestVersion())}},{key:"createOperatorForVersion",value:function(e){if(e===St.a.V001)return new Vi(this.crypto);if(e===St.a.V002)return new Qi(this.crypto);if(e===St.a.V003)return new is(this.crypto);if(e===St.a.V004)return new bs(this.crypto);if(e===St.a.V000Base64Decrypted)return this.createOperatorForLatestVersion();throw"Unable to find operator for version ".concat(e)}},{key:"operatorForVersion",value:function(e){var t=e,n=this.operators[t];return n||(n=this.createOperatorForVersion(e),this.operators[t]=n),n}},{key:"defaultOperator",value:function(){return this.operatorForVersion(this.getLatestVersion())}},{key:"computeRootKey",value:(Q=js(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.version,a=this.operatorForVersion(r),e.abrupt("return",a.computeRootKey(t,n));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return Q.apply(this,arguments)})},{key:"createRootKey",value:($=js(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.defaultOperator(),e.abrupt("return",r.createRootKey(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return $.apply(this,arguments)})},{key:"payloadContentFormatForIntent",value:function(e,t){if(t){if(e===qt.a.Sync||e===qt.a.FileEncrypted||e===qt.a.FilePreferEncrypted||e===qt.a.LocalStorageEncrypted||e===qt.a.LocalStoragePreferEncrypted)return lt.a.EncryptedString;throw"Unhandled encrypted case in protocolService.payloadContentFormatForIntent."}if(e===qt.a.LocalStorageDecrypted||e===qt.a.LocalStoragePreferEncrypted||e===qt.a.FileDecrypted||e===qt.a.FilePreferEncrypted)return lt.a.DecryptedBareObject;if(e===qt.a.SyncDecrypted)return lt.a.DecryptedBase64String;throw"Unhandled decrypted case in protocolService.payloadContentFormatForIntent."}},{key:"payloadByEncryptingPayload",value:(G=js(i.a.mark((function e(t,n,r){var a,o,s,c,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.errorDecrypting){e.next=2;break}return e.abrupt("return",t);case 2:if(!t.deleted){e.next=4;break}return e.abrupt("return",t);case 4:if(!Object(u.p)(n)){e.next=6;break}throw"Attempting to encrypt payload with null intent";case 6:if(r||Object(qt.c)(n)){e.next=10;break}return e.next=9,this.keyToUseForEncryptionOfPayload(t,n);case 9:r=e.sent;case 10:if(r||!Object(qt.b)(n)){e.next=12;break}throw Error("Attempting to generate encrypted payload with no key.");case 12:if(t.format===lt.a.DecryptedBareObject){e.next=14;break}throw"Attempting to encrypt already encrypted payload.";case 14:if(t.content){e.next=16;break}throw"Attempting to encrypt payload with no content.";case 16:if(t.uuid){e.next=18;break}throw"Attempting to encrypt payload with no uuid.";case 18:return a=r?r.version:this.getLatestVersion(),o=this.payloadContentFormatForIntent(n,r),s=this.operatorForVersion(a),e.next=23,s.generateEncryptedParameters(t,o,r);case 23:if(c=e.sent){e.next=26;break}throw"Unable to generate encryption parameters";case 26:return l=Object(P.d)(t,n,c),e.abrupt("return",l);case 28:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return G.apply(this,arguments)})},{key:"payloadsByEncryptingPayloads",value:(J=js(i.a.mark((function e(t,n){var r,a,o,s,c,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=ks(t),e.prev=2,a.s();case 4:if((o=a.n()).done){e.next=13;break}return s=o.value,c=Object(u.o)(n)?n(s):n,e.next=9,this.payloadByEncryptingPayload(s,c);case 9:l=e.sent,r.push(l);case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),a.e(e.t0);case 18:return e.prev=18,a.f(),e.finish(18);case 21:return e.abrupt("return",r);case 22:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),function(e,t){return J.apply(this,arguments)})},{key:"payloadByDecryptingPayload",value:(q=js(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.content){e.next=2;break}throw"Attempting to decrypt payload that has no content.";case 2:if((r=t.format)!==lt.a.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(n||r!==lt.a.EncryptedString){e.next=11;break}return e.next=8,this.keyToUseForDecryptionOfPayload(t);case 8:if(n=e.sent){e.next=11;break}return e.abrupt("return",Object(P.e)(t,{waitingForKey:!0,errorDecrypting:!0}));case 11:return a=t.version,o=this.operatorForVersion(a),s=Object(P.c)(t),e.next=16,o.generateDecryptedParameters(s,n);case 16:return c=e.sent,e.abrupt("return",Object(P.e)(t,c));case 18:case"end":return e.stop()}}),e,this)}))),function(e,t){return q.apply(this,arguments)})},{key:"payloadsByDecryptingPayloads",value:(z=js(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=ks(t),e.prev=2,a.s();case 4:if((o=a.n()).done){e.next=29;break}if(s=o.value){e.next=9;break}return r.push(s),e.abrupt("continue",27);case 9:if(!0!==s.deleted||!Object(u.p)(s.content)){e.next=12;break}return r.push(s),e.abrupt("continue",27);case 12:if(Object(u.s)(s.content)){e.next=16;break}return r.push(s),e.abrupt("continue",27);case 16:return e.prev=16,e.next=19,this.payloadByDecryptingPayload(s,n);case 19:c=e.sent,r.push(c),e.next=27;break;case 23:e.prev=23,e.t0=e.catch(16),r.push(Object(P.e)(s,{errorDecrypting:!0,errorDecryptingValueChanged:!s.errorDecrypting})),console.error("Error decrypting payload",s,e.t0);case 27:e.next=4;break;case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(2),a.e(e.t1);case 34:return e.prev=34,a.f(),e.finish(34);case 37:return e.abrupt("return",r);case 38:case"end":return e.stop()}}),e,this,[[2,31,34,37],[16,23]])}))),function(e,t){return z.apply(this,arguments)})},{key:"decryptErroredItems",value:(H=js(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(t=this.itemManager.invalidItems).length){e.next=3;break}return e.abrupt("return");case 3:return n=t.map((function(e){return e.payloadRepresentation()})),e.next=6,this.payloadsByDecryptingPayloads(n);case 6:return r=e.sent,e.next=9,this.modelManager.emitPayloads(r,j.a.LocalChanged);case 9:case"end":return e.stop()}}),e,this)}))),function(){return H.apply(this,arguments)})},{key:"payloadsByDecryptingBackupFile",value:(B=js(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.keyParams||t.auth_params,a=t.items,o=a.map((function(e){return Object(P.f)(e,j.a.FileImport)})),!r){e.next=12;break}return e.next=6,this.computeRootKey(n,r);case 6:return c=e.sent,e.next=9,this.payloadsByDecryptingPayloads(o,c);case 9:s=e.sent,e.next=13;break;case 12:s=o;case 13:return e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return B.apply(this,arguments)})},{key:"createKeyParams",value:function(e){return e.version||(e.version=St.a.V002),gi(e)}},{key:"createBackupFile",value:(W=js(i.a.mark((function e(t){var n,r,a,o,s,c,u,l,f,p,y,h,d=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=d.length>1&&void 0!==d[1]?d[1]:qt.a.FilePreferEncrypted,r=d.length>2&&void 0!==d[2]&&d[2],a=t||this.itemManager.items,!r||0!==a.length){e.next=5;break}return e.abrupt("return",void 0);case 5:o=[],s=ks(a),e.prev=7,s.s();case 9:if((c=s.n()).done){e.next=22;break}if(!(u=c.value).errorDecrypting){e.next=15;break}o.push(u.payload),e.next=20;break;case 15:return l=Object(P.f)(u.payload,j.a.FileImport),e.next=18,this.payloadByEncryptingPayload(l,n);case 18:f=e.sent,o.push(f);case 20:e.next=9;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(7),s.e(e.t0);case 27:return e.prev=27,s.f(),e.finish(27);case 30:return p={items:o.map((function(e){return e.ejected()}))},e.next=33,this.getRootKeyParams();case 33:return(y=e.sent)&&n!==qt.a.FileDecrypted&&(p.keyParams=y.getPortableValue()),h=2,e.abrupt("return",JSON.stringify(p,null,h));case 37:case"end":return e.stop()}}),e,this,[[7,24,27,30]])}))),function(e){return W.apply(this,arguments)})},{key:"onKeyStatusChange",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(u.B)(t.keyObservers,e)}}},{key:"notifyObserversOfKeyChange",value:(U=js(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=ks(this.keyObservers),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,r();case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(){return U.apply(this,arguments)})},{key:"getRootKeyFromKeychain",value:(N=js(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getKeychainValue();case 2:if(t=e.sent,!Object(u.p)(t)){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.next=7,_o.Create(t);case 7:return n=e.sent,e.abrupt("return",n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"saveRootKeyToKeychain",value:(V=js(i.a.mark((function e(){var t,n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(u.p)(this.rootKey)){e.next=2;break}throw"Attempting to non-existent root key to the keychain.";case 2:if(this.keyMode===ms.RootKeyOnly){e.next=4;break}throw"Should not be persisting wrapped key to keychain.";case 4:return t=this.rootKey.getPersistableValue(),e.abrupt("return",this.executeCriticalFunction((function(){return n.deviceInterface.setKeychainValue(t)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return V.apply(this,arguments)})},{key:"hasRootKeyWrapper",value:(L=js(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return t=e.sent,e.abrupt("return",!Object(u.p)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return L.apply(this,arguments)})},{key:"hasPasscode",value:function(){return this.keyMode===ms.WrapperOnly||this.keyMode===ms.RootKeyPlusWrapper}},{key:"rootKeyNeedsUnwrapping",value:(F=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.hasRootKeyWrapper();case 2:if(e.t0=e.sent,!e.t0){e.next=5;break}e.t0=Object(u.p)(this.rootKey);case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"getRootKeyWrapperKeyParams",value:(K=js(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.RootKeyWrapperKeyParams,Ht.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"getWrappedRootKey",value:(T=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(Lt.WrappedRootKey,Ht.Nonwrapped));case 1:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"getRootKeyParams",value:(M=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==ms.WrapperOnly){e.next=4;break}return e.abrupt("return",this.getRootKeyWrapperKeyParams());case 4:if(this.keyMode!==ms.RootKeyOnly&&this.keyMode!==ms.RootKeyPlusWrapper){e.next=8;break}return e.abrupt("return",this.getAccountKeyParams());case 8:if(this.keyMode!==ms.RootKeyNone){e.next=12;break}return e.abrupt("return",void 0);case 12:throw"Unhandled key mode for getRootKeyParams ".concat(this.keyMode);case 13:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"getAccountKeyParams",value:(A=js(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.RootKeyParams,Ht.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return A.apply(this,arguments)})},{key:"validateWrappingKey",value:(E=js(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:if(n=e.sent,this.keyMode!==ms.WrapperOnly){e.next=7;break}return e.abrupt("return",this.storageService.canDecryptWithKey(t));case 7:if(this.keyMode!==ms.RootKeyOnly&&this.keyMode!==ms.RootKeyPlusWrapper){e.next=15;break}return r=Object(P.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:return a=e.sent,e.abrupt("return",!a.errorDecrypting);case 15:throw"Unhandled case in validateWrappingKey";case 16:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"computeWrappingKey",value:(R=js(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)})},{key:"unwrapRootKey",value:(I=js(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==ms.WrapperOnly){e.next=3;break}return this.rootKey=t,e.abrupt("return");case 3:if(this.keyMode===ms.RootKeyPlusWrapper){e.next=5;break}throw"Invalid key mode condition for unwrapping.";case 5:return e.next=7,this.getWrappedRootKey();case 7:return n=e.sent,r=Object(P.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:if(!(a=e.sent).errorDecrypting){e.next=16;break}throw Error("Unable to decrypt root key with provided wrapping key.");case 16:return e.next=18,_o.Create(a.contentObject,a.uuid);case 18:return this.rootKey=e.sent,e.next=21,this.notifyObserversOfKeyChange();case 21:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"setNewRootKeyWrapper",value:(_=js(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==ms.RootKeyNone){e.next=4;break}this.keyMode=ms.WrapperOnly,e.next=9;break;case 4:if(this.keyMode!==ms.RootKeyOnly){e.next=8;break}this.keyMode=ms.RootKeyPlusWrapper,e.next=9;break;case 8:throw Error("Attempting to set wrapper on already wrapped key.");case 9:return e.next=11,this.deviceInterface.clearKeychainValue();case 11:if(this.keyMode!==ms.WrapperOnly&&this.keyMode!==ms.RootKeyPlusWrapper){e.next=26;break}if(this.keyMode!==ms.WrapperOnly){e.next=18;break}return this.rootKey=t,e.next=16,this.reencryptItemsKeys();case 16:e.next=20;break;case 18:return e.next=20,this.wrapAndPersistRootKey(t);case 20:return e.next=22,this.storageService.setValue(Lt.RootKeyWrapperKeyParams,n.getPortableValue(),Ht.Nonwrapped);case 22:return e.next=24,this.notifyObserversOfKeyChange();case 24:e.next=27;break;case 26:throw Error("Invalid keyMode on setNewRootKeyWrapper");case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return _.apply(this,arguments)})},{key:"wrapAndPersistRootKey",value:(C=js(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(P.e)(this.rootKey,{content:this.rootKey.getPersistableValue()}),e.next=3,this.payloadByEncryptingPayload(n,qt.a.LocalStorageEncrypted,t);case 3:return r=e.sent,e.next=6,this.storageService.setValue(Lt.WrappedRootKey,r.ejected(),Ht.Nonwrapped);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"removeRootKeyWrapper",value:(D=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode===ms.WrapperOnly||this.keyMode===ms.RootKeyPlusWrapper){e.next=2;break}throw"Attempting to remove root key wrapper on unwrapped key.";case 2:return this.keyMode===ms.WrapperOnly?(this.keyMode=ms.RootKeyNone,this.rootKey=void 0):this.keyMode===ms.RootKeyPlusWrapper&&(this.keyMode=ms.RootKeyOnly),e.next=5,this.storageService.removeValue(Lt.WrappedRootKey,Ht.Nonwrapped);case 5:return e.next=7,this.storageService.removeValue(Lt.RootKeyWrapperKeyParams,Ht.Nonwrapped);case 7:if(this.keyMode!==ms.RootKeyOnly){e.next=10;break}return e.next=10,this.saveRootKeyToKeychain();case 10:return e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"setNewRootKey",value:(x=js(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}throw Error("keyParams must be supplied if setting root key.");case 2:if(this.rootKey!==t){e.next=4;break}throw Error("Attempting to set root key as same current value.");case 4:if(this.keyMode!==ms.WrapperOnly){e.next=8;break}this.keyMode=ms.RootKeyPlusWrapper,e.next=16;break;case 8:if(this.keyMode!==ms.RootKeyNone){e.next=12;break}this.keyMode=ms.RootKeyOnly,e.next=16;break;case 12:if(this.keyMode!==ms.RootKeyOnly&&this.keyMode!==ms.RootKeyPlusWrapper){e.next=15;break}e.next=16;break;case 15:throw Error("Unhandled key mode for setNewRootKey ".concat(this.keyMode));case 16:return this.rootKey=t,e.next=19,this.storageService.setValue(Lt.RootKeyParams,n.getPortableValue(),Ht.Nonwrapped);case 19:if(this.keyMode!==ms.RootKeyOnly){e.next=24;break}return e.next=22,this.saveRootKeyToKeychain();case 22:e.next=29;break;case 24:if(this.keyMode!==ms.RootKeyPlusWrapper){e.next=29;break}if(r){e.next=27;break}throw Error("wrappingKey must be supplied");case 27:return e.next=29,this.wrapAndPersistRootKey(r);case 29:return e.next=31,this.notifyObserversOfKeyChange();case 31:return e.next=33,this.reencryptItemsKeys();case 33:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return x.apply(this,arguments)})},{key:"getRootKey",value:(S=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rootKey);case 1:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"clearLocalKeyState",value:(k=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.clearKeychainValue();case 2:return e.next=4,this.storageService.removeValue(Lt.WrappedRootKey,Ht.Nonwrapped);case 4:return e.next=6,this.storageService.removeValue(Lt.RootKeyWrapperKeyParams,Ht.Nonwrapped);case 6:return e.next=8,this.storageService.removeValue(Lt.RootKeyParams,Ht.Nonwrapped);case 8:return this.keyMode=ms.RootKeyNone,this.rootKey=void 0,e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"validateAccountPassword",value:(w=js(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:if(r=e.sent,!(a=r.compare(this.rootKey))){e.next=11;break}return e.abrupt("return",{valid:a,artifacts:{rootKey:r}});case 11:return e.abrupt("return",{valid:!1});case 12:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"validatePasscode",value:(g=js(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.next=8,this.validateWrappingKey(r);case 8:if(!(a=e.sent)){e.next=13;break}return e.abrupt("return",{valid:a,artifacts:{wrappingKey:r}});case 13:return e.abrupt("return",{valid:!1});case 14:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"contentTypeUsesRootKeyEncryption",value:function(e){return e===O.a.ItemsKey||e===O.a.EncryptedStorage}},{key:"keyToUseForEncryptionOfPayload",value:(b=js(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(u.p)(n)){e.next=2;break}throw"Intent must be supplied when looking up key for encryption of item.";case 2:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=15;break}return e.next=5,this.getRootKey();case 5:if(r=e.sent){e.next=12;break}if(!Object(qt.b)(n)){e.next=11;break}throw"Root key encryption is required but no root key is available.";case 11:return e.abrupt("return",void 0);case 12:return e.abrupt("return",r);case 15:return e.abrupt("return",this.getDefaultItemsKey());case 16:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"keyToUseForDecryptionOfPayload",value:(m=js(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=2;break}return e.abrupt("return",this.getRootKey());case 2:if(!t.items_key_id){e.next=5;break}return n=this.itemsKeyForPayload(t),e.abrupt("return",n);case 5:if((r=t.version)!==this.getLatestVersion()){e.next=8;break}throw"No associated key found for item encrypted with latest protocol version.";case 8:return e.abrupt("return",this.defaultItemsKeyForItemVersion(r));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"onSyncEvent",value:(v=js(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==c.b.FullSyncCompleted){e.next=3;break}return e.next=3,this.handleFullSyncCompletion();case 3:if(t!==c.b.DownloadFirstSyncCompleted){e.next=6;break}return e.next=6,this.handleDownloadFirstSyncCompletion();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"handleDownloadFirstSyncCompletion",value:(d=js(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.latestItemsKeys(),n=t.filter((function(e){return e.neverSynced})),r=t.find((function(e){return!e.neverSynced&&e.isDefault})),Object(u.p)(r)){e.next=9;break}return e.next=7,this.itemManager.setItemsToBeDeleted(Object(s.b)(n));case 7:e.next=20;break;case 9:return e.next=11,this.getRootKey();case 11:if(!(a=e.sent)){e.next=20;break}if(!((o=n.filter((function(e){return e.version!==a.version}))).length>0)){e.next=17;break}return e.next=17,this.itemManager.setItemsToBeDeleted(Object(s.b)(o));case 17:if(0!==this.latestItemsKeys().length){e.next=20;break}return e.next=20,this.createNewDefaultItemsKey();case 20:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"handleFullSyncCompletion",value:(y=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.getDefaultItemsKey()){e.next=6;break}return e.next=4,this.createNewDefaultItemsKey();case 4:if(this.keyMode!==ms.WrapperOnly){e.next=6;break}return e.abrupt("return",this.repersistAllItems());case 6:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"repersistAllItems",value:(p=js(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.items,n=t.map((function(e){return Object(P.e)(e)})),e.abrupt("return",this.storageService.savePayloads(n));case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"latestItemsKeys",value:function(){return this.itemManager.itemsKeys()}},{key:"itemsKeyForPayload",value:function(e){return this.latestItemsKeys().find((function(t){return t.uuid===e.items_key_id}))}},{key:"getDefaultItemsKey",value:function(){var e=this.latestItemsKeys();return 1===e.length?e[0]:e.find((function(e){return e.isDefault}))}},{key:"reencryptItemsKeys",value:(f=js(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((t=this.latestItemsKeys()).length>0)){e.next=4;break}return e.next=4,this.itemManager.setItemsDirty(Object(s.b)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"defaultItemsKeyForItemVersion",value:(l=js(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.latestItemsKeys().find((function(e){return e.version===t})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"createNewDefaultItemsKey",value:(o=js(i.a.mark((function e(){var t,n,r,a,o,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKey();case 2:if(t=e.sent,n=t?t.version:this.getLatestVersion(),!(Object(St.b)(n,Ms)<=0)){e.next=16;break}return e.t0=P.e,e.next=8,h.GenerateUuid();case 8:e.t1=e.sent,e.t2=O.a.ItemsKey,e.t3=Object(s.a)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n}),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},a=(0,e.t0)(e.t4),r=Nt(a),e.next=19;break;case 16:return e.next=18,this.operatorForVersion(n).createItemsKey();case 18:r=e.sent;case 19:if(!(o=this.getDefaultItemsKey())){e.next=23;break}return e.next=23,this.itemManager.changeItemsKey(o.uuid,(function(e){e.isDefault=!1}));case 23:return e.next=25,this.itemManager.insertItem(r);case 25:return c=e.sent,e.next=28,this.itemManager.changeItemsKey(c.uuid,(function(e){e.isDefault=!0}));case 28:return e.abrupt("return",c);case 29:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"changePassword",value:(a=js(i.a.mark((function e(t,n,r,a){var o,s,c,u,l,f,p,y,h,d,v=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this.getRootKey(),this.getRootKeyParams()]);case 2:return o=e.sent,s=ws(o,2),c=s[0],u=s[1],l=this.getDefaultItemsKey(),e.next=9,this.computeRootKey(n,u);case 9:if(f=e.sent,c.compare(f)){e.next=12;break}return e.abrupt("return",[Error("Invalid password.")]);case 12:return e.next=14,this.createRootKey(t,r);case 14:return p=e.sent,y=p.key,h=p.keyParams,e.next=19,this.setNewRootKey(y,h,a);case 19:return e.next=21,this.createNewDefaultItemsKey();case 21:return d=e.sent,e.abrupt("return",[null,{currentServerPassword:f.serverPassword,newRootKey:y,newKeyParams:h,rollback:function(){var e=js(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.setNewRootKey(c,u,a);case 2:return e.next=4,Promise.all([v.itemManager.setItemToBeDeleted(d.uuid),v.itemManager.changeItem(l.uuid,(function(e){e.isDefault=!0}))]);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}]);case 23:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return a.apply(this,arguments)})}])&&Ds(t.prototype,n),r&&Ds(t,r),re}(Jt.a);function Ks(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Fs=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.defaultContentKeyToDiffOn="text",this.textCharDiffLength=0,this.hasPreviousEntry=!1;var n=t.updated_at;Object(u.s)(n)&&(n=new Date(n)),this.payload=Object(P.b)(t,{updated_at:n})}var t,n,r;return t=e,(n=[{key:"setPreviousEntry",value:function(e){this.hasPreviousEntry=null!=e,this.payload.contentObject[this.defaultContentKeyToDiffOn]&&(this.textCharDiffLength=e?this.payload.contentObject[this.defaultContentKeyToDiffOn].length-e.payload.contentObject[this.defaultContentKeyToDiffOn].length:this.payload.contentObject[this.defaultContentKeyToDiffOn].length)}},{key:"operationVector",value:function(){return void 0!==this.textCharDiffLength?this.hasPreviousEntry&&0!==this.textCharDiffLength?this.textCharDiffLength<0?-1:1:0:1}},{key:"deltaSize",value:function(){return void 0!==this.textCharDiffLength?Math.abs(this.textCharDiffLength):1}},{key:"isSameAsEntry",value:function(e){if(!e)return!1;var t=Nt(this.payload),n=Nt(e.payload);return t.isItemContentEqualWith(n)}}])&&Ks(t.prototype,n),r&&Ks(t,r),e}();function Ls(e){return(Ls="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Vs(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ns(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Us(e,t){return(Us=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ws(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Hs(e);if(t){var a=Hs(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Bs(this,n)}}function Bs(e,t){return!t||"object"!==Ls(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Hs(e){return(Hs=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var zs=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Us(e,t)}(o,e);var t,n,r,a=Ws(o);function o(){return Vs(this,o),a.apply(this,arguments)}return t=o,(n=[{key:"previewTitle",value:function(){return this.payload.updated_at.toLocaleString()}},{key:"previewSubTitle",value:function(){return this.hasPreviousEntry?this.textCharDiffLength<0?"".concat(-1*this.textCharDiffLength," characters removed"):this.textCharDiffLength>0?"".concat(this.textCharDiffLength," characters added"):"Title or metadata changed":"".concat(this.textCharDiffLength," characters loaded")}}])&&Ns(t.prototype,n),r&&Ns(t,r),o}(Fs);function qs(e){var t,n,r,a=(t={},n=O.a.Note,r=zs,n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t)[e[ma.a.ContentType]];if(!a)throw"Invalid item history class";return new a(e)}function Js(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Gs(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Gs(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Gs(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function $s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Qs=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.entries=[],t){var n,r=Js(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;a.setPreviousEntry(this.getLastEntry()),this.entries.push(a)}}catch(e){r.e(e)}finally{r.f()}}}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){return new e(t.entries.map((function(e){return qs(e.payload)})))}}],(n=[{key:"getLastEntry",value:function(){return this.entries[this.entries.length-1]}},{key:"addHistoryEntryForItem",value:function(e){var t=qs(e),n=this.getLastEntry();if(t.setPreviousEntry(n),!t.isSameAsEntry(n))return this.entries.push(t),t}},{key:"clear",value:function(){this.entries.length=0}},{key:"optimize",value:function(){var e=this,t=[],n=function(e){return e.deltaSize()>15},r=function(r,a,o){if(o)t.push(r);else{var i=t.indexOf(r);-1!==i&&t.splice(i,1)}if(o&&n(r)&&-1===r.operationVector()){var s=e.entries[a-1];s&&t.push(s)}};this.entries.forEach((function(t,a){if(0===a||a===e.entries.length-1)r(t,a,!0);else{var o=n(t);r(t,a,o)}})),this.entries=this.entries.filter((function(e,n){return-1!==t.indexOf(e)}))}}])&&$s(t.prototype,n),r&&$s(t,r),e}();function Ys(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Xs=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.itemRevisionThreshold=60,this.content=t,this.content||(this.content={itemUUIDToItemHistoryMapping:{}})}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){if(t){var n=t.content;return Object.keys(n.itemUUIDToItemHistoryMapping).forEach((function(e){var t=n.itemUUIDToItemHistoryMapping[e];n.itemUUIDToItemHistoryMapping[e]=Qs.FromJson(t)})),new e(n)}return new e}}],(n=[{key:"addEntryForPayload",value:function(e){return this.historyForItem(e.uuid).addHistoryEntryForItem(e)}},{key:"historyForItem",value:function(e){var t=this.content.itemUUIDToItemHistoryMapping[e];return t||(t=new Qs,this.content.itemUUIDToItemHistoryMapping[e]=t),t}},{key:"clearItemHistory",value:function(e){this.historyForItem(e.uuid).clear()}},{key:"clearAllHistory",value:function(){this.content.itemUUIDToItemHistoryMapping={}}},{key:"setItemRevisionThreshold",value:function(e){this.itemRevisionThreshold=e}},{key:"optimizeHistoryForItem",value:function(e){var t=this.historyForItem(e);t.entries.length>this.itemRevisionThreshold&&t.optimize()}}])&&Ys(t.prototype,n),r&&Ys(t,r),e}();function Zs(e){return(Zs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ec(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return tc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return tc(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function tc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function nc(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function rc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){nc(o,r,a,i,s,"next",e)}function s(e){nc(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ac(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oc(e,t,n){return(oc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=uc(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ic(e,t){return(ic=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function sc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=uc(e);if(t){var a=uc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return cc(this,n)}}function cc(e,t){return!t||"object"!==Zs(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function uc(e){return(uc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var lc,fc,pc,yc=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ic(e,t)}(h,e);var t,n,r,a,o,s,c,l,f,p,y=sc(h);function h(e,t,n,r){var a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),(a=y.call(this)).contentTypes=[],a.persistable=!1,a.autoOptimize=!1,a.itemManager=e,a.storageService=t,a.contentTypes=n,a.timeout=r,a}return t=h,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.storageService=void 0,this.contentTypes.length=0,this.historySession=void 0,this.timeout=null,this.removeChangeObserver&&(this.removeChangeObserver(),this.removeChangeObserver=null),oc(uc(h.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(p=rc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.SessionHistoryPersistable);case 2:return this.persistable=e.sent,e.next=5,this.storageService.getValue(Lt.SessionHistoryRevisions).then((function(e){return Xs.FromJson(e)}));case 5:return this.historySession=e.sent,e.next=8,this.storageService.getValue(Lt.SessionHistoryOptimize);case 8:t=e.sent,Object(u.p)(t)?this.autoOptimize=!0:this.autoOptimize=t,this.addChangeObserver();case 11:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"addChangeObserver",value:function(){var e=this;this.removeChangeObserver=this.itemManager.addObserver(this.contentTypes,(function(t,n,r,a){var o=Object(u.f)(t,n,r);if(a!==j.a.LocalChanged){var i,s=ec(o);try{for(s.s();!(i=s.n()).done;){var c=i.value;try{c.deleted||c.errorDecrypting||e.addHistoryEntryForItem(c)}catch(e){console.error("Unable to add item history entry:",e)}}}catch(e){s.e(e)}finally{s.f()}}}))}},{key:"isDiskEnabled",value:function(){return this.persistable}},{key:"isAutoOptimizeEnabled",value:function(){return this.autoOptimize}},{key:"saveToDisk",value:(f=rc(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable){e.next=2;break}return e.abrupt("return");case 2:this.storageService.setValue(Lt.SessionHistoryRevisions,this.historySession);case 3:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"setSessionItemRevisionThreshold",value:function(e){this.historySession.setItemRevisionThreshold(e)}},{key:"addHistoryEntryForItem",value:(l=rc(i.a.mark((function e(t){var n,r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Object(P.f)(t,j.a.SessionHistory),r=this.historySession.addEntryForPayload(n),this.autoOptimize&&this.historySession.optimizeHistoryForItem(t.uuid),r&&this.persistable&&(this.saveTimeout&&(this.timeout.hasOwnProperty("cancel")?this.timeout.cancel(this.saveTimeout):clearTimeout(this.saveTimeout)),this.saveTimeout=this.timeout((function(){a.saveToDisk()}),2e3));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"historyForItem",value:function(e){return this.historySession.historyForItem(e.uuid)}},{key:"clearHistoryForItem",value:(c=rc(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearItemHistory(t),e.abrupt("return",this.saveToDisk());case 2:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"clearAllHistory",value:(s=rc(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearAllHistory(),e.abrupt("return",this.storageService.removeValue(Lt.SessionHistoryRevisions));case 2:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"toggleDiskSaving",value:(o=rc(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable=!this.persistable,!this.persistable){e.next=6;break}this.storageService.setValue(Lt.SessionHistoryPersistable,!0),this.saveToDisk(),e.next=8;break;case 6:return this.storageService.setValue(Lt.SessionHistoryPersistable,!1),e.abrupt("return",this.storageService.removeValue(Lt.SessionHistoryRevisions));case 8:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"toggleAutoOptimize",value:(a=rc(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.autoOptimize=!this.autoOptimize,this.autoOptimize?this.storageService.setValue(Lt.SessionHistoryOptimize,!0):this.storageService.setValue(Lt.SessionHistoryOptimize,!1);case 2:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})}])&&ac(t.prototype,n),r&&ac(t,r),h}(Jt.a);function hc(e){return(hc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function dc(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return vc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return vc(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function vc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function mc(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function bc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){mc(o,r,a,i,s,"next",e)}function s(e){mc(o,r,a,i,s,"throw",e)}i(void 0)}))}}function gc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function wc(e,t,n){return(wc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Oc(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function kc(e,t){return(kc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Sc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Oc(e);if(t){var a=Oc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return xc(this,n)}}function xc(e,t){return!t||"object"!==hc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Oc(e){return(Oc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Pc(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.None=0]="None",e[e.FiveMinutes=300]="FiveMinutes",e[e.OneHour=3600]="OneHour",e[e.OneWeek=604800]="OneWeek"}(pc||(pc={}));var jc,Dc=(Pc(lc={},L.AccountPassword,{label:"Account Password",prompt:"Please enter your account password."}),Pc(lc,L.LocalPasscode,{label:"Local Passcode",prompt:"Please enter your local passcode."}),lc),Cc=(Pc(fc={},F.ManageExtensions,{label:"Manage Extensions"}),Pc(fc,F.ManageBackups,{label:"Download/Import Backups"}),Pc(fc,F.ViewProtectedNotes,{label:"View Protected Notes"}),Pc(fc,F.ManagePrivileges,{label:"Manage Privileges"}),Pc(fc,F.ManagePasscode,{label:"Manage Passcode"}),Pc(fc,F.DeleteNote,{label:"Delete Notes"}),fc),_c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&kc(e,t)}(m,e);var t,n,r,a,o,c,u,l,f,p,y,h,d,v=Sc(m);function m(e,t,n,r,a,o){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),(i=v.call(this)).availableActions=[],i.availableCredentials=[],i.itemManager=e,i.syncService=t,i.singletonManager=n,i.protocolService=r,i.storageService=a,i.sessionManager=o,i.loadDefaults(),i}return t=m,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.syncService=void 0,this.singletonManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.sessionManager=void 0,wc(Oc(m.prototype),"deinit",this).call(this)}},{key:"loadDefaults",value:function(){this.availableActions=Object.keys(F).map((function(e){return F[e]})),this.availableCredentials=[L.AccountPassword,L.LocalPasscode]}},{key:"getAvailableActions",value:function(){return this.availableActions}},{key:"getAvailableCredentials",value:function(){return this.availableCredentials}},{key:"netCredentialsForAction",value:(d=bc(i.a.mark((function e(t){var n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPrivileges();case 2:n=e.sent,r=n.getCredentialsForAction(t),a=[],o=dc(r),e.prev=6,o.s();case 8:if((s=o.n()).done){e.next=24;break}if((c=s.value)!==L.AccountPassword){e.next=17;break}return e.next=13,this.sessionManager.online();case 13:e.sent&&a.push(c),e.next=22;break;case 17:if(c!==L.LocalPasscode){e.next=22;break}return e.next=20,this.protocolService.hasRootKeyWrapper();case 20:e.sent&&a.push(c);case 22:e.next=8;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(6),o.e(e.t0);case 29:return e.prev=29,o.f(),e.finish(29);case 32:return e.abrupt("return",a);case 33:case"end":return e.stop()}}),e,this,[[6,26,29,32]])}))),function(e){return d.apply(this,arguments)})},{key:"getPrivileges",value:(h=bc(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=O.a.Privileges,n=new D.a("content_type","=",t),e.abrupt("return",this.singletonManager.findOrCreateSingleton(n,t,Object(s.a)({})));case 3:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"setSessionLength",value:(y=bc(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t,a=void 0,(a=new Date).setSeconds(a.getSeconds()+r),n=a,e.next=4,this.storageService.setValue(Lt.PrivilegesExpirey,n);case 4:return e.next=6,this.storageService.setValue(Lt.PrivilegesSessionLength,t);case 6:case"end":return e.stop()}var r,a}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"clearSession",value:(p=bc(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setSessionLength(pc.None));case 1:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getSelectedSessionLength",value:(f=bc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.PrivilegesSessionLength);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",t);case 7:return e.abrupt("return",pc.None);case 8:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"getSessionExpirey",value:(l=bc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.PrivilegesExpirey);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",new Date(t));case 7:return e.abrupt("return",new Date);case 8:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"actionHasPrivilegesConfigured",value:(u=bc(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:return e.t0=e.sent.length,e.abrupt("return",e.t0>0);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"actionRequiresPrivilege",value:(c=bc(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionExpirey();case 2:if(!(e.sent>new Date)){e.next=5;break}return e.abrupt("return",!1);case 5:return e.next=7,this.netCredentialsForAction(t);case 7:return n=e.sent,e.abrupt("return",n.length>0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"authenticateAction",value:(o=bc(i.a.mark((function e(t,n){var r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:r=e.sent,a=[],o=[],s=dc(r),e.prev=6,s.s();case 8:if((c=s.n()).done){e.next=16;break}return u=c.value,e.next=12,this.verifyAuthenticationParameters(u,n[u]);case 12:e.sent?a.push(u):o.push(u);case 14:e.next=8;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(6),s.e(e.t0);case 21:return e.prev=21,s.f(),e.finish(21);case 24:return e.abrupt("return",{success:0===o.length,successfulCredentials:a,failedCredentials:o});case 25:case"end":return e.stop()}}),e,this,[[6,18,21,24]])}))),function(e,t){return o.apply(this,arguments)})},{key:"verifyAuthenticationParameters",value:(a=bc(i.a.mark((function e(t,n){var r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==L.AccountPassword){e.next=8;break}return e.next=3,this.protocolService.validateAccountPassword(n);case 3:return r=e.sent,a=r.valid,e.abrupt("return",a);case 8:if(t!==L.LocalPasscode){e.next=14;break}return e.next=11,this.protocolService.validatePasscode(n);case 11:return o=e.sent,s=o.valid,e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"displayInfoForCredential",value:function(e){return Dc[e]}},{key:"displayInfoForAction",value:function(e){return Cc[e]}},{key:"getSessionLengthOptions",value:function(){return[{value:pc.None,label:"Don't Remember"},{value:pc.FiveMinutes,label:"5 Minutes"},{value:pc.OneHour,label:"1 Hour"},{value:pc.OneWeek,label:"1 Week"}]}}])&&gc(t.prototype,n),r&&gc(t,r),m}(Jt.a);function Ic(e){return(Ic="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Rc(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ec(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ec(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Ec(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ac(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Mc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Tc(e,t,n){return(Tc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Vc(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Kc(e,t){return(Kc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Fc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Vc(e);if(t){var a=Vc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Lc(this,n)}}function Lc(e,t){return!t||"object"!==Ic(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Vc(e){return(Vc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.CreatedAt="created_at",e.UpdatedAt="userModifiedDate",e.Title="title"}(jc||(jc={}));var Nc=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Kc(e,t)}(o,e);var t,n,r,a=Fc(o);function o(){var e;return Ac(this,o),(e=a.apply(this,arguments)).displaySortBy={},e.displayFilter={},e.filteredMap={},e.sortedMap={},e}return t=o,(n=[{key:"set",value:function(e){e=Array.isArray(e)?e:[e],Tc(Vc(o.prototype),"set",this).call(this,e),this.filterSortElements(e)}},{key:"discard",value:function(e){e=Array.isArray(e)?e:[e],Tc(Vc(o.prototype),"discard",this).call(this,e),this.filterSortElements(e)}},{key:"setDisplayOptions",value:function(e,t,n,r){var a=this.displaySortBy[e],o=this.displayFilter[e];if(!a||a.key!==t||a.dir!==n||o||r){this.displaySortBy[e]=t?{key:t,dir:n}:void 0,this.displayFilter[e]=r,this.filteredMap[e]={},this.sortedMap[e]=[];var i=this.all(e);i.length>0&&this.filterSortElements(i)}}},{key:"displayElements",value:function(e){var t=this.sortedMap[e];if(!t)throw Error("Attempting to access display elements for \n        non-configured content type ".concat(e));return t.slice()}},{key:"filterSortElements",value:function(e){if(0!==Object.keys(this.displaySortBy).length){var t,n=new Set,r=Rc(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=a.content_type,i=this.displaySortBy[o];if(i){var s=this.displayFilter[o],c=this.filteredMap[o],l=this.sortedMap[o],f=!(a.deleted||!this.map[a.uuid])&&(!s||s(a)),p=c[a.uuid];if(f)if(Object(u.p)(p))l.push(a),n.add(o);else{var y=l[p],h=y[i.key],d=a[i.key];l[p]=a;var v=y.pinned!==a.pinned;Object(u.e)(h,d)&&!v||n.add(o)}else Object(u.p)(p)||(delete c[a.uuid],l[p]=void 0,n.add(o))}}}catch(e){r.e(e)}finally{r.f()}var m,b=Rc(n.values());try{for(b.s();!(m=b.n()).done;){var g=m.value;this.resortContentType(g)}}catch(e){b.e(e)}finally{b.f()}}}},{key:"resortContentType",value:function(e){var t,n=this.sortedMap[e],r=this.displaySortBy[e],a=this.filteredMap[e],o=[],i=0,s=Rc(n.sort((function(e,t){return function e(t,n){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t)return-1;if(!n)return 1;if(!a){if(t.pinned&&n.pinned)return e(t,n,!0);if(t.pinned)return-1;if(n.pinned)return 1}var o=t[r.key]||"",i=n[r.key]||"",s=1;if("asc"===r.dir&&(s*=-1),r.key===jc.Title){if(o=o.toLowerCase(),i=i.toLowerCase(),0===o.length&&0===i.length)return 0;if(0===o.length&&0!==i.length)return 1*s;if(0!==o.length&&0===i.length)return-1*s;s*=-1}return o>i?-1*s:o<i?1*s:0}(e,t)})));try{for(s.s();!(t=s.n()).done;){var c=t.value;c&&(o.push(c),a[c.uuid]=i,i++)}}catch(e){s.e(e)}finally{s.f()}this.sortedMap[e]=o}}])&&Mc(t.prototype,n),r&&Mc(t,r),o}(Jr);function Uc(e){return(Uc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wc(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Bc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Bc(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Bc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Hc(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function zc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Hc(o,r,a,i,s,"next",e)}function s(e){Hc(o,r,a,i,s,"throw",e)}i(void 0)}))}}function qc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Jc(e,t){return(Jc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Gc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Yc(e);if(t){var a=Yc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return $c(this,n)}}function $c(e,t){return!t||"object"!==Uc(t)&&"function"!=typeof t?Qc(e):t}function Qc(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Yc(e){return(Yc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Xc=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Jc(e,t)}(F,e);var t,n,r,a,o,c,l,f,p,y,v,m,b,g,w,k,S,x,C,_,I,R,E,A,M,T,K=Gc(F);function F(e){var t,n,r,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,F),(t=K.call(this)).observers=[],t.modelManager=e,t.createCollection(),t.unsubChangeObserver=t.modelManager.addObserver(O.a.Any,t.onPayloadChange.bind(Qc(t))),t.systemSmartTags=(n=Object(P.e)({uuid:"all-notes",content_type:O.a.SmartTag,content:Object(s.a)({title:"All notes",isSystemTag:!0,isAllTag:!0,predicate:D.a.FromArray(["content_type","=",O.a.Note])})}),r=Object(P.e)({uuid:"archived-notes",content_type:O.a.SmartTag,content:Object(s.a)({title:"Archived",isSystemTag:!0,isArchiveTag:!0,predicate:D.a.FromArray(["archived","=",JSON.stringify(!0)])})}),a=Object(P.e)({uuid:"trashed-notes",content_type:O.a.SmartTag,content:Object(s.a)({title:"Trash",isSystemTag:!0,isTrashTag:!0,predicate:D.a.FromArray(["trashed","=",JSON.stringify(!0)])})}),[Nt(n),Nt(r),Nt(a)]),t}return t=F,(n=[{key:"setDisplayOptions",value:function(e,t,n,r){this.collection.setDisplayOptions(e,t,n,r)}},{key:"getDisplayableItems",value:function(e){return this.collection.displayElements(e)}},{key:"deinit",value:function(){this.unsubChangeObserver(),this.unsubChangeObserver=void 0,this.modelManager=void 0,this.collection=void 0}},{key:"resetState",value:function(){this.createCollection()}},{key:"createCollection",value:function(){this.collection=new Nc,this.collection.setDisplayOptions(O.a.Note,jc.CreatedAt,"dsc"),this.collection.setDisplayOptions(O.a.Tag,jc.Title,"asc"),this.collection.setDisplayOptions(O.a.ItemsKey,jc.CreatedAt,"asc"),this.collection.setDisplayOptions(O.a.Component,jc.CreatedAt,"asc"),this.collection.setDisplayOptions(O.a.SmartTag,jc.Title,"asc")}},{key:"findItem",value:function(e){return this.collection.find(e)}},{key:"findItems",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.collection.findAll(e,t)}},{key:"itemsKeys",value:function(){return this.collection.displayElements(O.a.ItemsKey)}},{key:"addObserver",value:function(e,t){var n=this;Array.isArray(e)||(e=[e]);var r={contentType:e,callback:t};return this.observers.push(r),function(){Object(u.B)(n.observers,r)}}},{key:"itemsReferencingItem",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");var t=this.collection.uuidsThatReferenceUuid(e);return this.findItems(t)}},{key:"referencesForItem",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");var t=this.findItem(e).references.map((function(e){return e.uuid}));return this.findItems(t)}},{key:"onPayloadChange",value:(T=zc(i.a.mark((function e(t,n,r,a,o){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setPayloads(t,n,r,a,o));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return T.apply(this,arguments)})},{key:"setPayloads",value:(M=zc(i.a.mark((function e(t,n,r,a,o){var s,c,u,l,f,p,y;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=t.map((function(e){return Nt(e)})),c=n.map((function(e){return Nt(e)})),(u=s.concat(c)).length>0&&this.collection.set(u),l=r.map((function(e){return Nt(e)})),f=Wc(l);try{for(f.s();!(p=f.n()).done;)y=p.value,this.collection.discard(y)}catch(e){f.e(e)}finally{f.f()}return e.next=9,this.notifyObservers(s,c,l,a,o);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return M.apply(this,arguments)})},{key:"notifyObservers",value:(A=zc(i.a.mark((function e(t,n,r,a,o){var s,c,u,l,f,p,y,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=function(e,t){return e.filter((function(e){return t.includes(O.a.Any)||t.includes(e.content_type)}))},c=this.observers.slice(),u=Wc(c),e.prev=3,u.s();case 5:if((l=u.n()).done){e.next=16;break}if(f=l.value,p=s(t,f.contentType),y=s(n,f.contentType),h=s(r,f.contentType),0!==p.length||0!==y.length||0!==h.length){e.next=12;break}return e.abrupt("continue",14);case 12:return e.next=14,f.callback(p,y,h,a,o);case 14:e.next=5;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(3),u.e(e.t0);case 21:return e.prev=21,u.f(),e.finish(21);case 24:case"end":return e.stop()}}),e,this,[[3,18,21,24]])}))),function(e,t,n,r,a){return A.apply(this,arguments)})},{key:"changeItem",value:(E=zc(i.a.mark((function e(t,n){var r,a,o,s,c=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]?c[2]:d.c.UserInteraction,a=c.length>3&&void 0!==c[3]?c[3]:j.a.LocalChanged,o=c.length>4?c[4]:void 0,Object(u.s)(t)){e.next=5;break}throw Error("Invalid uuid for changeItem");case 5:return e.next=7,this.changeItems([t],n,r,a,o);case 7:return s=e.sent,e.abrupt("return",s[0]);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return E.apply(this,arguments)})},{key:"createMutatorForItem",value:function(e,t){return e.content_type===O.a.Note?new kt(e,t):e.content_type===O.a.Tag?new rt(e,t):e.content_type===O.a.Component?new ye(e,t):e.content_type===O.a.ActionsExtension?new qe(e,t):e.content_type===O.a.ItemsKey?new Tt(e,t):e.content_type===O.a.Privileges?new ee(e,t):e.content_type===O.a.UserPrefs?new N(e,t):new d.b(e,t)}},{key:"changeItems",value:(R=zc(i.a.mark((function e(t,n){var r,a,o,s,c,u,l,f,p,y,h,v=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=v.length>2&&void 0!==v[2]?v[2]:d.c.UserInteraction,a=v.length>3&&void 0!==v[3]?v[3]:j.a.LocalChanged,o=v.length>4?v[4]:void 0,s=this.findItems(t,!0),c=[],u=Wc(s),e.prev=6,u.s();case 8:if((l=u.n()).done){e.next=18;break}if(f=l.value){e.next=12;break}throw Error("Attempting to change non-existant item");case 12:p=this.createMutatorForItem(f,r),n&&n(p),y=p.getResult(),c.push(y);case 16:e.next=8;break;case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(6),u.e(e.t0);case 23:return e.prev=23,u.f(),e.finish(23);case 26:return e.next=28,this.modelManager.emitPayloads(c,a,o);case 28:return h=this.findItems(c.map((function(e){return e.uuid}))),e.abrupt("return",h);case 30:case"end":return e.stop()}}),e,this,[[6,20,23,26]])}))),function(e,t){return R.apply(this,arguments)})},{key:"changeNote",value:(I=zc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:j.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant note");case 6:return c=new kt(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return I.apply(this,arguments)})},{key:"changeComponent",value:(_=zc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:j.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant component");case 6:return c=new ye(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return _.apply(this,arguments)})},{key:"changeActionsExtension",value:(C=zc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:j.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant extension");case 6:return c=new qe(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return C.apply(this,arguments)})},{key:"changeItemsKey",value:(x=zc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:j.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant itemsKey");case 6:return c=new Tt(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return x.apply(this,arguments)})},{key:"applyTransform",value:(S=zc(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]?s[2]:j.a.LocalChanged,a=s.length>3?s[3]:void 0,n(t),o=t.getResult(),e.abrupt("return",this.modelManager.emitPayload(o,r,a));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return S.apply(this,arguments)})},{key:"setItemDirty",value:(k=zc(i.a.mark((function e(t){var n,r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>1&&void 0!==a[1]&&a[1],Object(u.s)(t)){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.next=5,this.setItemsDirty([t],n);case 5:return r=e.sent,e.abrupt("return",r[0]);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"setItemsDirty",value:(w=zc(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]&&r[1],Object(u.s)(t[0])){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.abrupt("return",this.changeItems(t,void 0,n?d.c.UserInteraction:d.c.Internal));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"getDirtyItems",value:function(){return this.collection.dirtyElements().filter((function(e){return!e.errorDecrypting||e.deleted}))}},{key:"insertItem",value:(g=zc(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.payload,e.next=3,this.emitItemFromPayload(n);case 3:return r=e.sent,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"duplicateItem",value:(b=zc(i.a.mark((function e(t){var n,r,a,o,s,c=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>1&&void 0!==c[1]&&c[1],r=this.findItem(t),a=Object(P.e)(r),e.next=5,la(a,this.modelManager.getMasterCollection(),n);case 5:return o=e.sent,e.next=8,this.modelManager.emitPayloads(o,j.a.LocalChanged);case 8:return s=this.findItem(o[0].uuid),e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"createItem",value:(m=zc(i.a.mark((function e(t,n){var r,a,o,c=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]&&c[2],a=c.length>3?c[3]:void 0,t){e.next=4;break}throw"Attempting to create item with no contentType";case 4:return e.t0=P.e,e.next=7,h.GenerateUuid();case 7:return e.t1=e.sent,e.t2=t,e.t3=n?Object(s.a)(n):void 0,e.t4=r,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:e.t4},e.t6=a,o=(0,e.t0)(e.t5,e.t6),e.next=16,this.modelManager.emitPayload(o,j.a.Constructor);case 16:return e.abrupt("return",this.findItem(o.uuid));case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"createTemplateItem",value:(v=zc(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=P.e,e.next=3,h.GenerateUuid();case 3:return e.t1=e.sent,e.t2=t,e.t3=Object(s.a)(n||{}),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},r=(0,e.t0)(e.t4),e.abrupt("return",Nt(r));case 9:case"end":return e.stop()}}),e)}))),function(e,t){return v.apply(this,arguments)})},{key:"emitItemFromPayload",value:(y=zc(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:j.a.Constructor,e.next=3,this.modelManager.emitPayload(t,n);case 3:return e.abrupt("return",this.findItem(t.uuid));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"emitItemsFromPayloads",value:(p=zc(i.a.mark((function e(t){var n,r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:j.a.Constructor,e.next=3,this.modelManager.emitPayloads(t,n);case 3:return r=Object(s.b)(t),e.abrupt("return",this.findItems(r));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"setItemToBeDeleted",value:(f=zc(i.a.mark((function e(t){var n,r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.collection.uuidsThatReferenceUuid(t),r=this.findItem(t),e.next=4,this.changeItem(t,(function(e){e.setDeleted()}));case 4:a=e.sent,o=Wc(n),e.prev=6,o.s();case 8:if((s=o.n()).done){e.next=16;break}if(c=s.value,!(u=this.findItem(c))){e.next=14;break}return e.next=14,this.changeItem(u.uuid,(function(e){e.removeItemAsRelationship(r)}));case 14:e.next=8;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(6),o.e(e.t0);case 21:return e.prev=21,o.f(),e.finish(21);case 24:return e.abrupt("return",a);case 25:case"end":return e.stop()}}),e,this,[[6,18,21,24]])}))),function(e){return f.apply(this,arguments)})},{key:"setItemsToBeDeleted",value:(l=zc(i.a.mark((function e(t){var n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=Wc(t),e.prev=2,r.s();case 4:if((a=r.n()).done){e.next=12;break}return o=a.value,e.next=8,this.setItemToBeDeleted(o);case 8:s=e.sent,n.push(s);case 10:e.next=4;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),r.e(e.t0);case 17:return e.prev=17,r.f(),e.finish(17);case 20:return e.abrupt("return",n);case 21:case"end":return e.stop()}}),e,this,[[2,14,17,20]])}))),function(e){return l.apply(this,arguments)})},{key:"getItems",value:function(e){return this.collection.all(e)}},{key:"nonErroredItemsForContentType",value:function(e){return this.collection.all(e).filter((function(e){return!e.errorDecrypting&&!e.waitingForKey}))}},{key:"itemsMatchingPredicate",value:function(e){return this.itemsMatchingPredicates([e])}},{key:"itemsMatchingPredicates",value:function(e){return this.subItemsMatchingPredicates(this.items,e)}},{key:"subItemsMatchingPredicates",value:function(e,t){return e.filter((function(e){if(e.deleted)return!1;var n,r=Wc(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(!e.satisfiesPredicate(a))return!1}}catch(e){r.e(e)}finally{r.f()}return!0}))}},{key:"findTagByTitle",value:function(e){return Object(u.D)(this.tags,{title:e})}},{key:"findOrCreateTagByTitle",value:(c=zc(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.findTagByTitle(t),e.t0=n,e.t0){e.next=6;break}return e.next=5,this.createItem(O.a.Tag,Object(s.a)({title:t}),!0);case 5:e.t0=e.sent;case 6:return e.abrupt("return",e.t0);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"notesMatchingSmartTag",value:function(e){var t=[new D.a("content_type","=",O.a.Note),e.predicate];if(!e.isTrashTag){var n=new D.a("content.trashed","=",!1);t.push(n)}return this.itemsMatchingPredicates(t)}},{key:"emptyTrash",value:(o=zc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.trashedItems,e.abrupt("return",this.setItemsToBeDeleted(Object(s.b)(t)));case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"getSmartTags",value:function(){var e=this.collection.displayElements(O.a.SmartTag);return this.systemSmartTags.concat(e)}},{key:"removeAllItemsFromMemory",value:(a=zc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(s.b)(this.items),e.next=3,this.changeItems(t,(function(e){e.setDeleted()}),d.c.NonDirtying);case 3:this.resetState(),this.modelManager.resetState();case 5:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"removeItemLocally",value:function(e){this.collection.discard(e),this.modelManager.removePayloadLocally(e.payload)}},{key:"items",get:function(){return this.collection.all()}},{key:"nonDeletedItems",get:function(){return this.collection.nondeletedElements()}},{key:"invalidItems",get:function(){return this.collection.invalidElements()}},{key:"notes",get:function(){return this.collection.displayElements(O.a.Note)}},{key:"tags",get:function(){return this.collection.displayElements(O.a.Tag)}},{key:"components",get:function(){return this.collection.displayElements(O.a.Component)}},{key:"trashSmartTag",get:function(){return this.systemSmartTags.find((function(e){return e.isTrashTag}))}},{key:"trashedItems",get:function(){return this.notesMatchingSmartTag(this.trashSmartTag)}},{key:"noteCount",get:function(){return this.collection.all(O.a.Note).length}}])&&qc(t.prototype,n),r&&qc(t,r),F}(Jt.a);function Zc(e,t){return e.sort((function(e,n){var r=new Date(n.updated_at).getTime()-new Date(e.updated_at).getTime(),a=0,o=0;return t&&(a=t.indexOf(e.content_type),o=t.indexOf(n.content_type),-1===a&&(a=t.length),-1===o&&(o=t.length)),a===o?r:a<o?-1:1}))}function eu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var tu=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.inProgress=!1,this.completedUpload=0,this.totalUpload=0,this.downloaded=0,this.databaseLoadCurrent=0,this.databaseLoadTotal=0,this.databaseLoadDone=!1,this.syncing=!1,this.interval=t,this.receiver=n}var t,n,r;return t=e,(n=[{key:"deinit",value:function(){this.stopTimingMonitor()}},{key:"setSyncInProgress",value:function(e){this.inProgress=!0}},{key:"setUploadStatus",value:function(e,t){this.completedUpload=e,this.totalUpload=t,this.receiver($a.a.StatusChanged)}},{key:"setDownloadStatus",value:function(e){this.downloaded+=e,this.receiver($a.a.StatusChanged)}},{key:"setDatabaseLoadStatus",value:function(e,t,n){this.databaseLoadCurrent=e,this.databaseLoadTotal=t,this.databaseLoadDone=n,n?this.receiver($a.a.LocalDataLoaded):this.receiver($a.a.LocalDataIncrementalLoad)}},{key:"getStats",value:function(){return{uploadCompletionCount:this.completedUpload,uploadTotalCount:this.totalUpload,downloadCount:this.downloaded,localDataDone:this.databaseLoadDone,localDataCurrent:this.databaseLoadCurrent,localDataTotal:this.databaseLoadTotal}}},{key:"setDidBegin",value:function(){this.syncing=!0,this.syncStart=new Date}},{key:"setDidEnd",value:function(){this.syncing=!1,this.syncEnd=new Date}},{key:"startTimingMonitor",value:function(){var e=this;this.timingMonitor&&this.stopTimingMonitor(),this.timingMonitor=this.interval((function(){e.secondsSinceSyncStart>5&&(e.receiver($a.a.SyncTakingTooLong),e.stopTimingMonitor())}),500)}},{key:"stopTimingMonitor",value:function(){Object.prototype.hasOwnProperty.call(this.interval,"cancel")?this.interval.cancel(this.timingMonitor):clearInterval(this.timingMonitor),this.timingMonitor=null}},{key:"hasError",value:function(){return!!this.error}},{key:"setError",value:function(e){this.error=e}},{key:"clearError",value:function(){this.error=null}},{key:"reset",value:function(){this.downloaded=0,this.completedUpload=0,this.totalUpload=0,this.inProgress=!1,this.syncing=!1,this.error=null,this.stopTimingMonitor(),this.receiver($a.a.StatusChanged)}},{key:"syncInProgress",get:function(){return!0===this.syncing}},{key:"secondsSinceSyncStart",get:function(){return((new Date).getTime()-this.syncStart.getTime())/1e3}}])&&eu(t.prototype,n),r&&eu(t,r),e}();function nu(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ru(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var au=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.discordance=0,this.outOfSync=!1,this.receiver=t,this.maxDiscordance=n,this.reset()}var t,n,r,a,o;return t=e,(n=[{key:"isOutOfSync",value:function(){return this.outOfSync}},{key:"reset",value:function(){this.lastPreSyncSave=void 0,this.lastSyncDate=void 0,this.discordance=0,this.outOfSync=!1}},{key:"getLastClientIntegrityHash",value:function(){return this.lastClientHash}},{key:"clearIntegrityHashes",value:function(){this.lastClientHash=void 0,this.lastServerHash=void 0}},{key:"setIntegrityHashes",value:(a=i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.lastClientHash=t,this.lastServerHash=n,n&&0!==n.length&&t&&t!==n?(this.discordance++,this.discordance>=this.maxDiscordance&&!this.outOfSync&&(this.outOfSync=!0,this.receiver($a.a.EnterOutOfSync))):(this.outOfSync&&(this.outOfSync=!1,this.receiver($a.a.ExitOutOfSync)),this.discordance=0);case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){nu(o,n,r,i,s,"next",e)}function s(e){nu(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e,t){return o.apply(this,arguments)})},{key:"needsSync",get:function(){return this.discordance>0&&this.discordance<this.maxDiscordance}}])&&ru(t.prototype,n),r&&ru(t,r),e}();function ou(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function iu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var su=function(){function e(t,n,r,a,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.apiService=t,this.protocolService=n,this.contentType=r,this.customEvent=a,this.limit=o,this.progress={retrievedPayloads:[]}}var t,n,r,a,o;return t=e,(n=[{key:"run",value:(a=i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.apiService.sync([],this.progress.lastSyncToken,this.progress.paginationToken,this.limit||500,!1,this.contentType,this.customEvent);case 2:return t=e.sent,n=t.retrieved_items.map((function(e){return Object(P.f)(e,j.a.RemoteRetrieved)})),e.next=6,this.protocolService.payloadsByDecryptingPayloads(n);case 6:if(r=e.sent,this.progress.retrievedPayloads=this.progress.retrievedPayloads.concat(r),this.progress.lastSyncToken=t.sync_token,this.progress.paginationToken=t.cursor_token,!t.cursor_token){e.next=14;break}return e.abrupt("return",this.run());case 14:return e.abrupt("return",this.progress.retrievedPayloads);case 15:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){ou(o,n,r,i,s,"next",e)}function s(e){ou(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&iu(t.prototype,n),r&&iu(t,r),e}();function cu(e){return(cu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function uu(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return lu(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return lu(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function lu(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function fu(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function pu(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){fu(o,r,a,i,s,"next",e)}function s(e){fu(o,r,a,i,s,"throw",e)}i(void 0)}))}}function yu(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function hu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function du(e,t){return(du=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function vu(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=bu(e);if(t){var a=bu(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return mu(this,n)}}function mu(e,t){return!t||"object"!==cu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function bu(e){return(bu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var gu=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&du(e,t)}(l,e);var t,n,r,a,o,s,c=vu(l);function l(){return yu(this,l),c.apply(this,arguments)}return t=l,(n=[{key:"resultingCollection",value:(s=pu(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.applyCollection.source!==j.a.ConflictUuid){e.next=4;break}return e.abrupt("return",this.collectionsByHandlingUuidConflicts());case 4:if(this.applyCollection.source!==j.a.ConflictData){e.next=8;break}return e.abrupt("return",this.collectionsByHandlingDataConflicts());case 8:throw"Unhandled conflict type ".concat(this.applyCollection.source);case 9:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"collectionsByHandlingDataConflicts",value:(o=pu(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=uu(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=21;break}if(a=r.value,o=this.findBasePayload(a.uuid)){e.next=10;break}return t.push(a),e.abrupt("continue",19);case 10:if((s=this.findRelatedPayload(a.uuid,j.a.DecryptedTransient))||a.deleted){e.next=13;break}throw"Unable to find decrypted counterpart for data conflict.";case 13:return c=new Oa(this.baseCollection,o,s||a,j.a.ConflictData),e.next=16,c.resultingCollection();case 16:l=e.sent,f=l.all(),Object(u.j)(t,f);case 19:e.next=4;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(2),n.e(e.t0);case 26:return e.prev=26,n.f(),e.finish(26);case 29:return e.abrupt("return",ta.WithPayloads(t,j.a.RemoteRetrieved));case 30:case"end":return e.stop()}}),e,this,[[2,23,26,29]])}))),function(){return o.apply(this,arguments)})},{key:"collectionsByHandlingUuidConflicts",value:(a=pu(i.a.mark((function e(){var t,n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=uu(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=13;break}return a=r.value,o=this.findRelatedPayload(a.uuid,j.a.DecryptedTransient),e.next=9,pa(o,this.baseCollection);case 9:s=e.sent,Object(u.j)(t,s);case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),n.e(e.t0);case 18:return e.prev=18,n.f(),e.finish(18);case 21:return e.abrupt("return",ta.WithPayloads(t,j.a.RemoteRetrieved));case 22:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),function(){return a.apply(this,arguments)})}])&&hu(t.prototype,n),r&&hu(t,r),l}(Fr);function wu(e){return(wu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ku(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Su(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Su(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Su(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function xu(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ou(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Pu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ju(e,t){return(ju=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Du(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=_u(e);if(t){var a=_u(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Cu(this,n)}}function Cu(e,t){return!t||"object"!==wu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _u(e){return(_u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Iu=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ju(e,t)}(c,e);var t,n,r,a,o,s=Du(c);function c(){return Ou(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){var t,n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=ku(this.applyCollection.all());try{for(n.s();!(r=n.n()).done;)a=r.value,o=this.findBasePayload(a.uuid),s=o?o.deleted:a.deleted,c=Object(P.f)(a,j.a.RemoteSaved,{lastSyncEnd:new Date,deleted:s}),t.push(c)}catch(e){n.e(e)}finally{n.f()}return e.abrupt("return",ta.WithPayloads(t,j.a.RemoteSaved));case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){xu(o,n,r,i,s,"next",e)}function s(e){xu(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&Pu(t.prototype,n),r&&Pu(t,r),c}(Fr);function Ru(e){return(Ru="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Eu(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Au(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Au(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Au(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Mu(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Tu(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ku(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Fu(e,t){return(Fu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Lu(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Nu(e);if(t){var a=Nu(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Vu(this,n)}}function Vu(e,t){return!t||"object"!==Ru(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Nu(e){return(Nu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Uu=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Fu(e,t)}(c,e);var t,n,r,a,o,s=Lu(c);function c(){return Tu(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){var t,n,r,a,o,s,c,l,f,p,y,h,d,v,m,b,g;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=[],r=Eu(this.applyCollection.all()),e.prev=3,r.s();case 5:if((a=r.n()).done){e.next=24;break}if(o=a.value,s=this.findRelatedPayload(o.uuid,j.a.SavedOrSaving),c=this.findRelatedPayload(o.uuid,j.a.DecryptedTransient)){e.next=14;break}if(o.deleted){e.next=12;break}throw"Cannot find decrypted for non-deleted payload.";case 12:return t.push(o),e.abrupt("continue",22);case 14:if(!s){e.next=17;break}return n.push(c),e.abrupt("continue",22);case 17:if(!(l=this.findBasePayload(o.uuid))||!l.dirty){e.next=21;break}return n.push(c),e.abrupt("continue",22);case 21:t.push(c);case 22:e.next=5;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(3),r.e(e.t0);case 29:return e.prev=29,r.f(),e.finish(29);case 32:f=[],p=0,y=n;case 34:if(!(p<y.length)){e.next=51;break}if(h=y[p],d=this.findRelatedPayload(h.uuid,j.a.DecryptedTransient)){e.next=39;break}return e.abrupt("continue",48);case 39:if(v=this.findBasePayload(h.uuid)){e.next=42;break}return e.abrupt("continue",48);case 42:return m=new Oa(this.baseCollection,v,d,j.a.ConflictData),e.next=45,m.resultingCollection();case 45:b=e.sent,g=b.all(),Object(u.j)(f,g);case 48:p++,e.next=34;break;case 51:return e.abrupt("return",ta.WithPayloads(t.concat(f),j.a.RemoteRetrieved));case 52:case"end":return e.stop()}}),e,this,[[3,26,29,32]])})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Mu(o,n,r,i,s,"next",e)}function s(e){Mu(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&Ku(t.prototype,n),r&&Ku(t,r),c}(Fr);function Wu(e){return e===j.a.RemoteRetrieved?Uu:e===j.a.RemoteSaved?Iu:e===j.a.ConflictData||e===j.a.ConflictUuid?gu:void 0}function Bu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Hu=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.collections=t,Object.freeze(this)}var t,n,r;return t=e,(n=[{key:"collectionForSource",value:function(e){return this.collections.find((function(t){return t.source===e}))}}])&&Bu(t.prototype,n),r&&Bu(t,r),e}();function zu(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function qu(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){zu(o,r,a,i,s,"next",e)}function s(e){zu(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ju(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Gu,$u=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.response=t,this.baseCollection=r,this.relatedCollectionSet=new Hu([ta.WithPayloads(n,j.a.DecryptedTransient),ta.WithPayloads(a,j.a.SavedOrSaving)])}var t,n,r,a,o;return t=e,(n=[{key:"collectionsByProcessingResponse",value:(o=qu(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,this.collectionByProcessingPayloads(this.response.retrievedPayloads,j.a.RemoteRetrieved);case 3:return(n=e.sent).all().length>0&&t.push(n),e.next=7,this.collectionByProcessingPayloads(this.response.savedPayloads,j.a.RemoteSaved);case 7:if((r=e.sent).all().length>0&&t.push(r),!(this.response.uuidConflictPayloads.length>0)){e.next=14;break}return e.next=12,this.collectionByProcessingPayloads(this.response.uuidConflictPayloads,j.a.ConflictUuid);case 12:(a=e.sent).all().length>0&&t.push(a);case 14:if(!(this.response.dataConflictPayloads.length>0)){e.next=19;break}return e.next=17,this.collectionByProcessingPayloads(this.response.dataConflictPayloads,j.a.ConflictData);case 17:(o=e.sent).all().length>0&&t.push(o);case 19:return e.abrupt("return",t);case 20:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"collectionByProcessingPayloads",value:(a=qu(i.a.mark((function e(t,n){var r,a,o,s,c,u=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=ta.WithPayloads(t,n),a=Wu(n),o=new a(this.baseCollection,r,this.relatedCollectionSet),e.next=5,o.resultingCollection();case 5:return s=e.sent,c=s.all().map((function(e){var t=u.finalDirtyStateForPayload(e);return Object(P.b)(e,{dirty:t,dirtiedDate:t?new Date:void 0})})),e.abrupt("return",ta.WithPayloads(c,n));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"finalDirtyStateForPayload",value:function(e){var t=this.baseCollection.find(e.uuid);return t?e.dirtiedDate&&e.dirtiedDate>t.dirtiedDate?e.dirty:t.dirtiedDate>t.lastSyncBegan:e.dirty}}])&&Ju(t.prototype,n),r&&Ju(t,r),e}();function Qu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}!function(e){e.ConflictingData="sync_conflict",e.UuidConflict="uuid_conflict"}(Gu||(Gu={}));var Yu,Xu=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.rawResponse=t,this.savedPayloads=this.filterRawItemArray(t.saved_items).map((function(e){return Object(P.f)(e,j.a.RemoteSaved)})),this.retrievedPayloads=this.filterRawItemArray(t.retrieved_items).map((function(e){return Object(P.f)(e,j.a.RemoteRetrieved)})),this.dataConflictPayloads=this.filterRawItemArray(this.rawDataConflictItems).map((function(e){return Object(P.f)(e,j.a.ConflictData)})),this.uuidConflictPayloads=this.filterRawItemArray(this.rawUuidConflictItems).map((function(e){return Object(P.f)(e,j.a.ConflictUuid)})),this.deletedPayloads=this.allProcessedPayloads.filter((function(e){return e.discardable})),Object(u.g)(this)}var t,n,r;return t=e,(n=[{key:"filterRawItemArray",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter((function(e){return!!e.uuid}))}},{key:"error",get:function(){return this.rawResponse.error}},{key:"status",get:function(){return this.rawResponse.status}},{key:"lastSyncToken",get:function(){return this.rawResponse[Gn.LastSyncToken]}},{key:"paginationToken",get:function(){return this.rawResponse[Gn.PaginationToken]}},{key:"integrityHash",get:function(){return this.rawResponse[Gn.IntegrityResult]}},{key:"checkIntegrity",get:function(){return this.integrityHash&&!this.paginationToken}},{key:"numberOfItemsInvolved",get:function(){return this.allProcessedPayloads.length}},{key:"allProcessedPayloads",get:function(){return this.savedPayloads.concat(this.retrievedPayloads).concat(this.dataConflictPayloads).concat(this.uuidConflictPayloads)}},{key:"rawUuidConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===Gu.UuidConflict})).map((function(e){return e.unsaved_item||e.item}))}},{key:"rawDataConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===Gu.ConflictingData})).map((function(e){return e.server_item||e.item}))}},{key:"rawConflictObjects",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[];return e.concat(t)}},{key:"hasError",get:function(){return!Object(u.p)(this.rawResponse.error)}}])&&Qu(t.prototype,n),r&&Qu(t,r),e}();function Zu(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return el(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return el(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function el(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function tl(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function nl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}!function(e){e[e.Response=1]="Response",e[e.StatusChanged=2]="StatusChanged"}(Yu||(Yu={}));var rl=function(){function e(t,n,r,a,o,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.responses=[],this.payloads=t,this.lastSyncToken=r,this.paginationToken=a,this.checkIntegrity=o,this.apiService=i,this.receiver=n,this.pendingPayloads=t}var t,n,r,a,o;return t=e,(n=[{key:"popPayloads",value:function(e){var t=this.pendingPayloads.slice(0,e);return Object(u.G)(this.pendingPayloads,t),t}},{key:"run",value:(a=i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.popPayloads(this.upLimit),e.next=3,this.apiService.sync(t,this.lastSyncToken,this.paginationToken,this.downLimit,this.checkIntegrity,void 0,void 0);case 3:return n=e.sent,r=new Xu(n),this.responses.push(r),this.lastSyncToken=r.lastSyncToken,this.paginationToken=r.paginationToken,e.next=10,this.receiver(Yu.Response,r);case 10:if(this.done){e.next=12;break}return e.abrupt("return",this.run());case 12:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){tl(o,n,r,i,s,"next",e)}function s(e){tl(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})},{key:"pendingUploadCount",value:function(){return this.pendingPayloads.length}},{key:"totalUploadCount",value:function(){return this.payloads.length}},{key:"payloadsSavedOrSaving",get:function(){return Object(u.c)(this.payloads,this.pendingPayloads)}},{key:"done",get:function(){return 0===this.pendingPayloads.length&&!this.paginationToken}},{key:"upLimit",get:function(){return 150}},{key:"downLimit",get:function(){return 150}},{key:"numberOfItemsInvolved",get:function(){var e,t=0,n=Zu(this.responses);try{for(n.s();!(e=n.n()).done;)t+=e.value.numberOfItemsInvolved}catch(e){n.e(e)}finally{n.f()}return t}}])&&nl(t.prototype,n),r&&nl(t,r),e}();function al(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ol(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var il=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.payloads=t,this.receiver=n}var t,n,r,a,o;return t=e,(n=[{key:"run",value:(a=i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.payloads.map((function(e){return Object(P.f)(e,j.a.LocalSaved,{dirty:!1,lastSyncEnd:new Date})})),n=Object(u.a)(t),r=new Xu({saved_items:n}),e.next=5,this.receiver(Yu.Response,r);case 5:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){al(o,n,r,i,s,"next",e)}function s(e){al(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&ol(t.prototype,n),r&&ol(t,r),e}();function sl(e){return(sl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function cl(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ul(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ul(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function ul(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ll(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function fl(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function pl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function yl(e,t){return(yl=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function hl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=vl(e);if(t){var a=vl(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return dl(this,n)}}function dl(e,t){return!t||"object"!==sl(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function vl(e){return(vl=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ml=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&yl(e,t)}(c,e);var t,n,r,a,o,s=hl(c);function c(){return fl(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){var t,n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=cl(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=19;break}if(a=r.value,t.push(a),o=this.findBasePayload(a.uuid)){e.next=10;break}return e.abrupt("continue",17);case 10:if(!va(a,o)){e.next=13;break}return e.abrupt("continue",17);case 13:return e.next=15,la(o,this.baseCollection,!0);case 15:s=e.sent,Object(u.j)(t,s);case 17:e.next=4;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(2),n.e(e.t0);case 24:return e.prev=24,n.f(),e.finish(24);case 27:return e.abrupt("return",ta.WithPayloads(t,j.a.RemoteRetrieved));case 28:case"end":return e.stop()}}),e,this,[[2,21,24,27]])})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){ll(o,n,r,i,s,"next",e)}function s(e){ll(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&pl(t.prototype,n),r&&pl(t,r),c}(Fr);function bl(e){return(bl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function gl(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function wl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function kl(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Sl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Sl(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Sl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function xl(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ol(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){xl(o,r,a,i,s,"next",e)}function s(e){xl(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Pl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function jl(e,t,n){return(jl="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Il(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Dl(e,t){return(Dl=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Cl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Il(e);if(t){var a=Il(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return _l(this,n)}}function _l(e,t){return!t||"object"!==bl(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Il(e){return(Il=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Rl,El,Al;!function(e){e[e.ResolveOnNext=1]="ResolveOnNext",e[e.ForceSpawnNew=2]="ForceSpawnNew"}(Rl||(Rl={})),function(e){e[e.Default=1]="Default",e[e.DownloadFirst=2]="DownloadFirst"}(El||(El={})),function(e){e[e.External=1]="External",e[e.SpawnQueue=2]="SpawnQueue",e[e.ResolveQueue=3]="ResolveQueue",e[e.MoreDirtyItems=4]="MoreDirtyItems",e[e.AfterDownloadFirst=5]="AfterDownloadFirst",e[e.IntegrityCheck=6]="IntegrityCheck",e[e.ResolveOutOfSync=7]="ResolveOutOfSync"}(Al||(Al={}));var Ml=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Dl(e,t)}(L,e);var t,n,r,a,o,c,l,f,p,y,h,v,m,b,g,w,k,S,x,D,C,_,I,R,E,A,M,T,K,F=Cl(L);function L(e,t,n,r,a,o,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,L),(s=F.call(this)).resolveQueue=[],s.spawnQueue=[],s.completedOnlineDownloadFirstSync=!1,s.majorChangeThreshold=15,s.maxDiscordance=5,s.locked=!1,s.databaseLoaded=!1,s.localLoadPriorty=[O.a.ItemsKey,O.a.UserPrefs,O.a.Privileges,O.a.Component,O.a.Theme],s.nonEncryptedTypes=[O.a.Mfa,O.a.ServerExtension],s.itemManager=e,s.sessionManager=t,s.protocolService=n,s.modelManager=a,s.storageService=r,s.apiService=o,s.interval=i,s.initializeStatus(),s.initializeState(),s}return t=L,(n=[{key:"onNewDatabaseCreated",value:(K=Ol(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastSyncToken();case 2:if(!e.sent){e.next=5;break}return e.next=5,this.clearSyncPositionTokens();case 5:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"deinit",value:function(){this.sessionManager=void 0,this.itemManager=void 0,this.protocolService=void 0,this.modelManager=void 0,this.storageService=void 0,this.apiService=void 0,this.interval=void 0,this.state.reset(),this.opStatus.reset(),this.state=void 0,this.opStatus=void 0,this.resolveQueue.length=0,this.spawnQueue.length=0,jl(Il(L.prototype),"deinit",this).call(this)}},{key:"initializeStatus",value:function(){var e=this;this.opStatus=new tu(this.interval,(function(t){e.notifyEvent(t)}))}},{key:"initializeState",value:function(){var e=this;this.state=new au((function(t){t===$a.a.EnterOutOfSync?e.notifyEvent($a.a.EnterOutOfSync):t===$a.a.ExitOutOfSync&&e.notifyEvent($a.a.ExitOutOfSync)}),this.maxDiscordance)}},{key:"lockSyncing",value:function(){this.locked=!0}},{key:"unlockSyncing",value:function(){this.locked=!1}},{key:"isOutOfSync",value:function(){return this.state.isOutOfSync()}},{key:"getLastSyncDate",value:function(){return this.state.lastSyncDate}},{key:"getStatus",value:function(){return this.opStatus}},{key:"resetSyncState",value:function(){this.state.reset()}},{key:"isDatabaseLoaded",value:function(){return this.databaseLoaded}},{key:"getDatabasePayloads",value:(T=Ol(i.a.mark((function e(){var t=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getAllRawPayloads().catch((function(e){throw t.notifyEvent($a.a.DatabaseReadError,e),e})));case 1:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"loadDatabasePayloads",value:(M=Ol(i.a.mark((function e(t){var n,r,a,o,s,c,l,f,p,y,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.databaseLoaded){e.next=2;break}throw"Attempting to initialize already initialized local database.";case 2:if(0!==t.length){e.next=6;break}return this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0),e.abrupt("return");case 6:return n=t.map((function(e){return Object(P.e)(e)})),r=Zc(n,this.localLoadPriorty),a=r.filter((function(e){return e.content_type===O.a.ItemsKey})),Object(u.G)(r,a),e.next=12,this.protocolService.payloadsByDecryptingPayloads(a);case 12:return o=e.sent,e.next=15,this.modelManager.emitPayloads(o,j.a.LocalRetrieved);case 15:s=r.length,c=100,l=Math.ceil(s/c),f=0;case 19:if(!(f<l)){e.next=32;break}return p=f*c,y=r.slice(p,p+c),e.next=24,this.protocolService.payloadsByDecryptingPayloads(y);case 24:return h=e.sent,e.next=27,this.modelManager.emitPayloads(h,j.a.LocalRetrieved);case 27:this.notifyEvent($a.a.LocalDataIncrementalLoad),this.opStatus.setDatabaseLoadStatus(p,s,!1);case 29:f++,e.next=19;break;case 32:this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0);case 34:case"end":return e.stop()}}),e,this)}))),function(e){return M.apply(this,arguments)})},{key:"setLastSyncToken",value:(A=Ol(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=t,e.abrupt("return",this.storageService.setValue(Lt.LastSyncToken,t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return A.apply(this,arguments)})},{key:"setPaginationToken",value:(E=Ol(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken=t,!t){e.next=5;break}return e.abrupt("return",this.storageService.setValue(Lt.PaginationToken,t));case 5:return e.abrupt("return",this.storageService.removeValue(Lt.PaginationToken));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"getLastSyncToken",value:(R=Ol(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.syncToken){e.next=4;break}return e.next=3,this.storageService.getValue(Lt.LastSyncToken);case 3:this.syncToken=e.sent;case 4:return e.abrupt("return",this.syncToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"getPaginationToken",value:(I=Ol(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken){e.next=4;break}return e.next=3,this.storageService.getValue(Lt.PaginationToken);case 3:this.cursorToken=e.sent;case 4:return e.abrupt("return",this.cursorToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"clearSyncPositionTokens",value:(_=Ol(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=void 0,this.cursorToken=void 0,e.next=4,this.storageService.removeValue(Lt.LastSyncToken);case 4:return e.next=6,this.storageService.removeValue(Lt.PaginationToken);case 6:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"itemsNeedingSync",value:(C=Ol(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.getDirtyItems(),e.abrupt("return",t);case 2:case"end":return e.stop()}}),e,this)}))),function(){return C.apply(this,arguments)})},{key:"alternateUuidForItem",value:(D=Ol(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.itemManager.findItem(t),r=Object(P.e)(n),e.next=4,pa(r,this.modelManager.getMasterCollection());case 4:return a=e.sent,e.next=7,this.modelManager.emitPayloads(a,j.a.LocalChanged);case 7:return e.next=9,this.persistPayloads(a);case 9:return e.abrupt("return",this.itemManager.findItem(a[0].uuid));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)})},{key:"markAllItemsAsNeedingSync",value:(x=Ol(i.a.mark((function e(t){var n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Marking all items as needing sync"),!t){e.next=20;break}n=this.itemManager.items.filter((function(e){return!e.errorDecrypting})).slice(),r=kl(n),e.prev=4,r.s();case 6:if((a=r.n()).done){e.next=12;break}return o=a.value,e.next=10,this.alternateUuidForItem(o.uuid);case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),r.e(e.t0);case 17:return e.prev=17,r.f(),e.finish(17);case 20:return s=this.itemManager.items,c=s.map((function(e){return Object(P.e)(e,{dirty:!0,dirtiedDate:new Date})})),e.next=24,this.modelManager.emitPayloads(c,j.a.LocalChanged);case 24:return e.next=26,this.persistPayloads(c);case 26:case"end":return e.stop()}}),e,this,[[4,14,17,20]])}))),function(e){return x.apply(this,arguments)})},{key:"popPayloadsNeedingPreSyncSave",value:(S=Ol(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.state.lastPreSyncSave){e.next=3;break}return e.abrupt("return",t);case 3:return r=t.filter((function(e){return!e.dirtiedDate||e.dirtiedDate>n})),this.state.lastPreSyncSave=new Date,e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"queueStrategyResolveOnNext",value:function(){var e=this;return new Promise((function(t,n){e.resolveQueue.push({resolve:t,reject:n})}))}},{key:"queueStrategyForceSpawnNew",value:function(e){var t=this;return new Promise((function(n,r){t.spawnQueue.push({resolve:n,reject:r,options:e})}))}},{key:"popSpawnQueue",value:function(){if(0===this.spawnQueue.length)return null;var e=this.spawnQueue[0];return Object(u.C)(this.spawnQueue,0),this.log("Syncing again from spawn queue"),this.sync(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?gl(Object(n),!0).forEach((function(t){wl(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gl(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({queueStrategy:Rl.ForceSpawnNew,source:Al.SpawnQueue},e.options)).then((function(){e.resolve()})).catch((function(){e.reject()}))}},{key:"payloadsByPreparingForServer",value:(k=Ol(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.payloadsByEncryptingPayloads(t,(function(e){return n.nonEncryptedTypes.includes(e.content_type)?qt.a.SyncDecrypted:qt.a.Sync})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"sync",value:(w=Ol(i.a.mark((function e(){var t,n,r,a,o,c,l,f,p,y,h,v,m,b,g,w,k,S,x,O,P,D,C=this,_=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_.length>0&&void 0!==_[0]?_[0]:{},!this.locked){e.next=4;break}return this.log("Sync Locked"),e.abrupt("return");case 4:return n=function(){return C.syncLock},r=function(){C.syncLock=!0},a=function(){C.syncLock=!1},o=this.opStatus.syncInProgress,c=this.databaseLoaded,(l=!n())&&c&&!o&&r(),t.source||(t.source=Al.External),e.next=14,this.itemsNeedingSync();case 14:return f=e.sent,p=f.filter((function(e){return e.neverSynced&&e.deleted})),Object(u.G)(f,p),y=f.map((function(e){return e.payloadRepresentation()})),e.next=20,this.popPayloadsNeedingPreSyncSave(y);case 20:return h=e.sent,e.next=23,this.persistPayloads(h);case 23:if(v=this.resolveQueue.slice(),m=Object(u.p)(t.queueStrategy)?Rl.ResolveOnNext:t.queueStrategy,!o&&c&&l){e.next=36;break}if(this.log(l?o?"Attempting to sync while existing sync in progress.":"Attempting to sync before local database has loaded.":"Another function call has begun preparing for sync."),m!==Rl.ResolveOnNext){e.next=31;break}return e.abrupt("return",this.queueStrategyResolveOnNext());case 31:if(m!==Rl.ForceSpawnNew){e.next=35;break}return e.abrupt("return",this.queueStrategyForceSpawnNew({mode:t.mode,checkIntegrity:t.checkIntegrity,source:t.source}));case 35:throw"Unhandled timing strategy ".concat(m);case 36:if(this.opStatus.setDidBegin(),this.notifyEvent($a.a.SyncWillBegin),Object(u.G)(this.resolveQueue,v),b=new Date,!(f.length>0)){e.next=43;break}return e.next=43,this.itemManager.changeItems(Object(s.b)(f),(function(e){e.lastSyncBegan=b}),d.c.NonDirtying,j.a.PreSyncSave);case 43:if(g=this.sessionManager.online(),i=t.mode,w=g&&!C.completedOnlineDownloadFirstSync?El.DownloadFirst:Object(u.p)(i)?El.Default:i,k=[],w!==El.Default){e.next=58;break}if(!g||this.completedOnlineDownloadFirstSync){e.next=49;break}throw Error("Attempting to default mode sync without having completed initial.");case 49:if(!g){e.next=55;break}return e.next=52,this.payloadsByPreparingForServer(y);case 52:k=e.sent,e.next=56;break;case 55:k=y;case 56:e.next=59;break;case 58:w===El.DownloadFirst&&(k=[]);case 59:if(!g){e.next=65;break}return e.next=62,this.syncOnlineOperation(k,t.checkIntegrity,t.source,w);case 62:S=e.sent,e.next=68;break;case 65:return e.next=67,this.syncOfflineOperation(k,t.source,w);case 67:S=e.sent;case 68:return e.next=70,S.run();case 70:if(this.opStatus.setDidEnd(),a(),!this.opStatus.hasError()){e.next=74;break}return e.abrupt("return");case 74:if(this.opStatus.reset(),this.state.lastSyncDate=new Date,S instanceof rl&&S.numberOfItemsInvolved>=this.majorChangeThreshold&&this.notifyEvent($a.a.MajorDataChange),!(p.length>0)){e.next=80;break}return e.next=80,this.handleNeverSyncedDeleted(p);case 80:if(w===El.DownloadFirst){e.next=83;break}return e.next=83,this.notifyEvent($a.a.FullSyncCompleted,{source:t.source});case 83:if(w!==El.DownloadFirst){e.next=91;break}return g&&(this.completedOnlineDownloadFirstSync=!0),e.next=87,this.notifyEvent($a.a.DownloadFirstSyncCompleted);case 87:return e.next=89,this.sync({source:Al.AfterDownloadFirst,checkIntegrity:!0,awaitAll:t.awaitAll});case 89:e.next=117;break;case 91:if(this.popSpawnQueue()||!(this.resolveQueue.length>0)){e.next=99;break}if(this.log("Syncing again from resolve queue"),x=this.sync({source:Al.ResolveQueue,checkIntegrity:t.checkIntegrity}),!t.awaitAll){e.next=97;break}return e.next=97,x;case 97:e.next=117;break;case 99:return e.next=101,this.itemsNeedingSync();case 101:if(e.t0=e.sent.length,!(e.t0>0)){e.next=107;break}return e.next=105,this.sync({source:Al.MoreDirtyItems,checkIntegrity:t.checkIntegrity,awaitAll:t.awaitAll});case 105:e.next=117;break;case 107:if(!(S instanceof rl&&S.checkIntegrity)){e.next=116;break}if(!this.state.needsSync||!S.done){e.next=114;break}if(this.log("Syncing again from integrity check"),O=this.sync({checkIntegrity:!0,queueStrategy:Rl.ForceSpawnNew,source:Al.IntegrityCheck,awaitAll:t.awaitAll}),!t.awaitAll){e.next=114;break}return e.next=114,O;case 114:e.next=117;break;case 116:this.state.clearIntegrityHashes();case 117:P=kl(v);try{for(P.s();!(D=P.n()).done;)D.value.resolve()}catch(e){P.e(e)}finally{P.f()}case 119:case"end":return e.stop()}var i}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"syncOnlineOperation",value:(g=Ol(i.a.mark((function e(t,n,r,a){var o,s=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing online user","source:",r,"integrity check",n,"mode:",a,"payloads:",t),e.t0=rl,e.t1=t,e.t2=function(){var e=Ol(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==Yu.Response){e.next=10;break}if(!n.hasError){e.next=6;break}return e.next=4,s.handleErrorServerResponse(n);case 4:e.next=8;break;case 6:return e.next=8,s.handleSuccessServerResponse(o,n);case 8:e.next=13;break;case 10:if(t!==Yu.StatusChanged){e.next=13;break}return e.next=13,s.handleStatusChange(o);case 13:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),e.next=6,this.getLastSyncToken();case 6:return e.t3=e.sent,e.next=9,this.getPaginationToken();case 9:return e.t4=e.sent,e.t5=n,e.t6=this.apiService,o=new e.t0(e.t1,e.t2,e.t3,e.t4,e.t5,e.t6),e.abrupt("return",o);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return g.apply(this,arguments)})},{key:"syncOfflineOperation",value:(b=Ol(i.a.mark((function e(t,n,r){var a,o=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing offline user","source:",n,"mode:",r,"payloads:",t),a=new il(t,function(){var e=Ol(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==Yu.Response){e.next=3;break}return e.next=3,o.handleOfflineResponse(n);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),e.abrupt("return",a);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return b.apply(this,arguments)})},{key:"handleStatusChange",value:(m=Ol(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.pendingUploadCount(),r=t.totalUploadCount(),a=r-n,this.opStatus.setUploadStatus(a,r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"handleOfflineResponse",value:(v=Ol(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Offline Sync Response",t.rawResponse),!((n=t.savedPayloads).length>0)){e.next=8;break}return e.next=5,this.modelManager.emitPayloads(n,j.a.LocalSaved);case 5:return r=this.modelManager.find(Object(s.b)(n)),e.next=8,this.persistPayloads(r);case 8:if(!((a=t.deletedPayloads).length>0)){e.next=12;break}return e.next=12,this.deletePayloads(a);case 12:return this.opStatus.clearError(),this.opStatus.setDownloadStatus(t.retrievedPayloads.length),e.next=16,this.notifyEvent($a.a.SingleSyncCompleted,t);case 16:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"handleErrorServerResponse",value:(h=Ol(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.log("Sync Error",t),401===t.status&&this.notifyEvent($a.a.InvalidSession),this.opStatus.setError(t.error),this.notifyEvent($a.a.SyncError,t.error);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"handleSuccessServerResponse",value:(y=Ol(i.a.mark((function e(t,n){var r,a,o,s,c,l,f,p,y,h,d,v,m,b;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._simulate_latency){e.next=3;break}return e.next=3,Object(u.E)(this._simulate_latency.latency);case 3:this.log("Online Sync Response",n.rawResponse),this.setLastSyncToken(n.lastSyncToken),this.setPaginationToken(n.paginationToken),this.opStatus.clearError(),this.opStatus.setDownloadStatus(n.retrievedPayloads.length),r=[],a=kl(n.allProcessedPayloads),e.prev=10,a.s();case 12:if((o=a.n()).done){e.next=22;break}if(!(s=o.value).deleted&&s.fields.includes(ma.a.Content)){e.next=16;break}return e.abrupt("continue",20);case 16:return e.next=18,this.protocolService.payloadByDecryptingPayload(s);case 18:c=e.sent,r.push(c);case 20:e.next=12;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(10),a.e(e.t0);case 27:return e.prev=27,a.f(),e.finish(27);case 30:return l=this.modelManager.getMasterCollection(),f=new $u(n,r,l,t.payloadsSavedOrSaving),e.next=34,f.collectionsByProcessingResponse();case 34:p=e.sent,y=kl(p),e.prev=36,y.s();case 38:if((h=y.n()).done){e.next=47;break}return d=h.value,e.next=42,this.modelManager.emitCollection(d);case 42:return v=this.modelManager.find(d.uuids()),e.next=45,this.persistPayloads(v);case 45:e.next=38;break;case 47:e.next=52;break;case 49:e.prev=49,e.t1=e.catch(36),y.e(e.t1);case 52:return e.prev=52,y.f(),e.finish(52);case 55:if(!((m=n.deletedPayloads).length>0)){e.next=59;break}return e.next=59,this.deletePayloads(m);case 59:return e.next=61,this.notifyEvent($a.a.SingleSyncCompleted,n);case 61:if(!n.checkIntegrity){e.next=67;break}return e.next=64,this.computeDataIntegrityHash();case 64:return b=e.sent,e.next=67,this.state.setIntegrityHashes(b,n.integrityHash);case 67:case"end":return e.stop()}}),e,this,[[10,24,27,30],[36,49,52,55]])}))),function(e,t){return y.apply(this,arguments)})},{key:"handleNeverSyncedDeleted",value:(p=Ol(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.map((function(e){return e.payloadRepresentation({dirty:!1})})),e.next=3,this.modelManager.emitPayloads(n,j.a.LocalChanged);case 3:return e.next=5,this.persistPayloads(n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"persistPayloads",value:(f=Ol(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return");case 2:return e.abrupt("return",this.storageService.savePayloads(t).catch((function(e){throw n.notifyEvent($a.a.DatabaseWriteError,e),e})));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"deletePayloads",value:(l=Ol(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.persistPayloads(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"computeDataIntegrityHash",value:(c=Ol(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.itemManager.nonDeletedItems.sort((function(e,t){return t.updated_at.getTime()-e.updated_at.getTime()})),n=t.map((function(e){return e.updatedAtTimestamp()})),r=n.join(","),e.abrupt("return",this.protocolService.crypto.sha256(r));case 7:return e.prev=7,e.t0=e.catch(0),console.error("Error computing data integrity hash",e.t0),e.abrupt("return",void 0);case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return c.apply(this,arguments)})},{key:"resolveOutOfSync",value:(o=Ol(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new su(this.apiService,this.protocolService,void 0,"resolve-out-of-sync"),e.next=3,t.run();case 3:return n=e.sent,r=new ml(this.modelManager.getMasterCollection(),ta.WithPayloads(n,j.a.RemoteRetrieved)),e.next=7,r.resultingCollection();case 7:return a=e.sent,e.next=10,this.modelManager.emitCollection(a);case 10:return e.next=12,this.persistPayloads(a.payloads);case 12:return e.abrupt("return",this.sync({checkIntegrity:!0,source:Al.ResolveOutOfSync}));case 13:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"statelessDownloadAllItems",value:(a=Ol(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new su(this.apiService,this.protocolService,t,n),e.next=3,r.run();case 3:return a=e.sent,e.abrupt("return",a.map((function(e){return Nt(e)})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"ut_setDatabaseLoaded",value:function(e){this.databaseLoaded=e}},{key:"ut_clearLastSyncDate",value:function(){this.state.lastSyncDate=void 0}},{key:"ut_beginLatencySimulator",value:function(e){this._simulate_latency={latency:e||1e3,enabled:!0}}},{key:"ut_endLatencySimulator",value:function(){this._simulate_latency=null}}])&&Pl(t.prototype,n),r&&Pl(t,r),L}(Jt.a);function Tl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Kl=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.challenge=t,this.resolve=n,this.validValues=[],this.invalidValues=[],this.artifacts={}}var t,n,r;return t=e,(n=[{key:"complete",value:function(e){var t,n;e||(e=new k(this.challenge,this.validValues,this.artifacts)),null===(t=this.resolve)||void 0===t||t.call(this,e),null===(n=this.onComplete)||void 0===n||n.call(this)}},{key:"cancel",value:function(){var e,t;null===(e=this.resolve)||void 0===e||e.call(this,null),null===(t=this.onCancel)||void 0===t||t.call(this)}},{key:"isFinished",value:function(){return this.validValues.length===this.challenge.types.length}},{key:"setValueStatus",value:function(e,t,n){var r,a,o=t?this.validValues:this.invalidValues,i=o.find((function(t){return t.type===e.type}));i&&Object(u.B)(o,i),o.push(e),Object.assign(this.artifacts,n),this.isFinished()?this.complete():t?null===(r=this.onValidValue)||void 0===r||r.call(this,e):null===(a=this.onInvalidValue)||void 0===a||a.call(this,e)}}])&&Tl(t.prototype,n),r&&Tl(t,r),e}();function Fl(e){return(Fl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ll(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Vl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Vl(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Vl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Nl(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ul(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Nl(o,r,a,i,s,"next",e)}function s(e){Nl(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Wl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Bl(e,t,n){return(Bl="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Jl(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Hl(e,t){return(Hl=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function zl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Jl(e);if(t){var a=Jl(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ql(this,n)}}function ql(e,t){return!t||"object"!==Fl(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Jl(e){return(Jl=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Gl=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Hl(e,t)}(f,e);var t,n,r,a,o,s,c,u,l=zl(f);function f(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(n=l.call(this)).challengeOperations={},n.storageService=e,n.protocolService=t,n}return t=f,(n=[{key:"deinit",value:function(){this.storageService=void 0,this.protocolService=void 0,this.sendChallenge=void 0,Bl(Jl(f.prototype),"deinit",this).call(this)}},{key:"promptForChallengeResponse",value:function(e){var t=this;return new Promise((function(n){t.createOrGetChallengeOperation(e,n)}))}},{key:"promptForChallengeResponseWithCustomValidation",value:function(e){var t=this.createOrGetChallengeOperation(e);return new Promise((function(e){t.customValidator=e}))}},{key:"validateChallengeValue",value:function(e){switch(e.type){case p.LocalPasscode:return this.protocolService.validatePasscode(e.value);case p.AccountPassword:return this.protocolService.validateAccountPassword(e.value);case p.Biometric:return Promise.resolve({valid:!0===e.value})}}},{key:"getLaunchChallenge",value:(u=Ul(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.protocolService.hasPasscode()&&t.push(p.LocalPasscode),e.next=5,this.hasBiometricsEnabled();case 5:if(e.sent&&t.push(p.Biometric),!(t.length>0)){e.next=11;break}return e.abrupt("return",new g(t,y.ApplicationUnlock));case 11:return e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"isPasscodeLocked",value:function(){return this.protocolService.rootKeyNeedsUnwrapping()}},{key:"hasBiometricsEnabled",value:(c=Ul(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Lt.BiometricsState,Ht.Nonwrapped);case 2:return t=e.sent,e.abrupt("return",Boolean(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"enableBiometrics",value:(s=Ul(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setValue(Lt.BiometricsState,!0,Ht.Nonwrapped);case 2:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"disableBiometrics",value:(o=Ul(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setValue(Lt.BiometricsState,!1,Ht.Nonwrapped);case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"setChallengeCallbacks",value:function(e,t,n,r,a){var o=this.getChallengeOperation(e);o.onValidValue=t,o.onInvalidValue=n,o.onComplete=r,o.onCancel=a}},{key:"createOrGetChallengeOperation",value:function(e,t){var n=this.getChallengeOperation(e);return n||(n=new Kl(e,t),this.challengeOperations[e.id]=n,this.sendChallenge(e)),n.resolve=t,n}},{key:"getChallengeOperation",value:function(e){return this.challengeOperations[e.id]}},{key:"deleteChallengeOperation",value:function(e){delete this.challengeOperations[e.challenge.id]}},{key:"cancelChallenge",value:function(e){var t=this.challengeOperations[e.id];t.cancel(),this.deleteChallengeOperation(t)}},{key:"submitValuesForChallenge",value:(a=Ul(i.a.mark((function e(t,n){var r,a,o,s,c,u,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}throw Error("Attempting to submit 0 values for challenge");case 2:if(!(r=this.getChallengeOperation(t)).customValidator){e.next=7;break}r.customValidator(n),e.next=28;break;case 7:a=Ll(n),e.prev=8,a.s();case 10:if((o=a.n()).done){e.next=20;break}return s=o.value,e.next=14,this.validateChallengeValue(s);case 14:c=e.sent,u=c.valid,l=c.artifacts,this.setValidationStatusForChallenge(t,s,u,l);case 18:e.next=10;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(8),a.e(e.t0);case 25:return e.prev=25,a.f(),e.finish(25);case 28:case"end":return e.stop()}}),e,this,[[8,22,25,28]])}))),function(e,t){return a.apply(this,arguments)})},{key:"setValidationStatusForChallenge",value:function(e,t,n,r){var a=this.getChallengeOperation(e);a.setValueStatus(t,n,r),a.isFinished()&&this.deleteChallengeOperation(a)}}])&&Wl(t.prototype,n),r&&Wl(t,r),f}(Jt.a);function $l(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||ef(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ql(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Yl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ql(Object(n),!0).forEach((function(t){Xl(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ql(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Xl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Zl(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=ef(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function ef(e,t){if(e){if("string"==typeof e)return tf(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?tf(e,t):void 0}}function tf(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function nf(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function rf(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){nf(o,r,a,i,s,"next",e)}function s(e){nf(o,r,a,i,s,"throw",e)}i(void 0)}))}}function af(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var of=function(){function e(t,n,r,a,o,i,s){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.eventHandlers=[],this.services=[],this.streamRemovers=[],this.serviceObservers=[],this.managedSubscribers=[],this.createdNewDatabase=!1,this.started=!1,this.launched=!1,this.dealloced=!1,!r)throw"Device Interface must be supplied.";if(!t)throw"Environment must be supplied when creating an application.";if(!n)throw"Platform must be supplied when creating an application.";if(!a)throw"Crypto has to be supplied when creating an application.";this.environment=t,this.platform=n,this.namespace=o||"",this.deviceInterface=r,this.crypto=a,this.swapClasses=i,this.skipClasses=s,this.constructServices()}var t,n,r,o,l,f,v,m,b,w,k,S,x,D,C,_,I,R,E,A,M,T,K,F,L,V,N,U,W,B,H,z,q,J,G,$,Q,Y,X,Z,ee,te,ne,re,ae,oe,ie,se,ce,ue,le,fe,pe,ye,he,de,ve;return t=e,(n=[{key:"prepareForLaunch",value:(ve=rf(i.a.mark((function e(t){var n,r=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setLaunchCallback(t),e.next=3,this.deviceInterface.openDatabase().catch((function(e){r.notifyEvent(c.a.LocalDatabaseReadError,e)}));case 3:return n=e.sent,this.createdNewDatabase=(null==n?void 0:n.isNewDatabase)||!1,e.next=7,this.migrationService.initialize();case 7:return e.next=9,this.handleStage(a.PreparingForLaunch_0);case 9:return e.next=11,this.storageService.initializeFromDisk();case 11:return e.next=13,this.protocolService.initialize();case 13:return e.next=15,this.handleStage(a.ReadyForLaunch_05);case 15:return this.started=!0,e.next=18,this.notifyEvent(c.a.Started);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return ve.apply(this,arguments)})},{key:"setLaunchCallback",value:function(e){this.challengeService.sendChallenge=e.receiveChallenge}},{key:"launch",value:(de=rf(i.a.mark((function e(){var t,n,r,o,s,u=this,l=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=l.length>0&&void 0!==l[0]&&l[0],this.launched=!1,e.next=4,this.challengeService.getLaunchChallenge();case 4:if(!(n=e.sent)){e.next=13;break}return e.next=8,this.challengeService.promptForChallengeResponse(n);case 8:if(r=e.sent){e.next=11;break}throw Error("Launch challenge was cancelled.");case 11:return e.next=13,this.handleLaunchChallengeResponse(r);case 13:if(!this.storageService.isStorageWrapped()){e.next=16;break}return e.next=16,this.storageService.decryptStorage();case 16:return e.next=18,this.handleStage(a.StorageDecrypted_09);case 18:return e.next=20,this.apiService.loadHost();case 20:return e.next=22,this.sessionManager.initializeFromDisk();case 22:return this.historyManager.initializeFromDisk(),this.launched=!0,e.next=26,this.notifyEvent(c.a.Launched);case 26:return e.next=28,this.handleStage(a.Launched_10);case 28:return e.next=30,this.syncService.getDatabasePayloads();case 30:return o=e.sent,e.next=33,this.handleStage(a.LoadingDatabase_11);case 33:if(!this.createdNewDatabase){e.next=36;break}return e.next=36,this.syncService.onNewDatabaseCreated();case 36:if(s=this.syncService.loadDatabasePayloads(o).then(rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u.dealloced){e.next=2;break}throw"Application has been destroyed.";case 2:return e.next=4,u.handleStage(a.LoadedDatabase_12);case 4:return u.beginAutoSyncTimer(),e.abrupt("return",u.syncService.sync({mode:El.DownloadFirst}));case 6:case"end":return e.stop()}}),e)})))),!t){e.next=40;break}return e.next=40,s;case 40:case"end":return e.stop()}}),e,this)}))),function(){return de.apply(this,arguments)})},{key:"handleLaunchChallengeResponse",value:(he=rf(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.challenge.types.includes(p.LocalPasscode)){e.next=9;break}if(n=t.artifacts.wrappingKey){e.next=7;break}return r=t.getValueForType(p.LocalPasscode),e.next=6,this.protocolService.computeWrappingKey(r.value);case 6:n=e.sent;case 7:return e.next=9,this.protocolService.unwrapRootKey(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return he.apply(this,arguments)})},{key:"beginAutoSyncTimer",value:function(){var e=this;this.autoSyncInterval=this.deviceInterface.interval((function(){e.syncService.log("Syncing from autosync"),e.sync()}),3e4)}},{key:"handleStage",value:(ye=rf(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Zl(this.services),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return a=r.value,e.next=7,a.handleApplicationStage(t);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e){return ye.apply(this,arguments)})},{key:"addEventObserver",value:function(e,t){var n=this,r={callback:e,singleEvent:t};return this.eventHandlers.push(r),function(){Object(u.B)(n.eventHandlers,r)}}},{key:"addSingleEventObserver",value:function(e,t){var n=function(){var n=rf(i.a.mark((function n(r){return i.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r===e&&t(e);case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}();return this.addEventObserver(n,e)}},{key:"notifyEvent",value:(pe=rf(i.a.mark((function e(t,n){var r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=Zl(this.eventHandlers.slice()),e.prev=1,r.s();case 3:if((a=r.n()).done){e.next=15;break}if(!(o=a.value).singleEvent||o.singleEvent!==t){e.next=10;break}return e.next=8,o.callback(t,n||{});case 8:e.next=13;break;case 10:if(o.singleEvent){e.next=13;break}return e.next=13,o.callback(t,n||{});case 13:e.next=3;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(1),r.e(e.t0);case 20:return e.prev=20,r.f(),e.finish(20);case 23:this.migrationService.handleApplicationEvent(t);case 24:case"end":return e.stop()}}),e,this,[[1,17,20,23]])}))),function(e,t){return pe.apply(this,arguments)})},{key:"isDatabaseLoaded",value:function(){return this.syncService.isDatabaseLoaded()}},{key:"savePayload",value:(fe=rf(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(P.b)(t,{dirty:!0,dirtiedDate:new Date}),e.next=3,this.modelManager.emitPayload(n,j.a.LocalChanged);case 3:return e.next=5,this.syncService.sync();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return fe.apply(this,arguments)})},{key:"findItem",value:function(e){return this.itemManager.findItem(e)}},{key:"allItems",value:function(){return this.itemManager.items}},{key:"findItems",value:function(e){return this.itemManager.itemsMatchingPredicate(e)}},{key:"getAll",value:function(e){return this.itemManager.findItems(e)}},{key:"mergeItem",value:(le=rf(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.emitItemFromPayload(t.payloadRepresentation(),n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return le.apply(this,arguments)})},{key:"createManagedItem",value:(ue=rf(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,e.next=4,this.itemManager.createItem(t,n,r,a);case 4:return o=e.sent,e.abrupt("return",o);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return ue.apply(this,arguments)})},{key:"createTemplateItem",value:(ce=rf(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.createTemplateItem(t,n);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return ce.apply(this,arguments)})},{key:"createItemFromPayload",value:function(e){return Nt(e)}},{key:"createPayloadFromObject",value:function(e){return Object(P.e)(e)}},{key:"getLastSyncDate",value:function(){return this.syncService.getLastSyncDate()}},{key:"getSyncStatus",value:function(){return this.syncService.getStatus()}},{key:"setItemNeedsSync",value:(se=rf(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",this.itemManager.setItemDirty(t.uuid,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return se.apply(this,arguments)})},{key:"setItemsNeedsSync",value:(ie=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.setItemsDirty(Object(s.b)(t)));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return ie.apply(this,arguments)})},{key:"deleteItem",value:(oe=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t.uuid);case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return oe.apply(this,arguments)})},{key:"deleteItemLocally",value:(ae=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.itemManager.removeItemLocally(t);case 1:case"end":return e.stop()}}),e,this)}))),function(e){return ae.apply(this,arguments)})},{key:"emptyTrash",value:(re=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.emptyTrash();case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(){return re.apply(this,arguments)})},{key:"getTrashedItems",value:function(){return this.itemManager.trashedItems}},{key:"setDisplayOptions",value:function(e,t,n,r){this.itemManager.setDisplayOptions(e,t,n,r)}},{key:"getDisplayableItems",value:function(e){return this.itemManager.getDisplayableItems(e)}},{key:"insertItem",value:(ne=rf(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.insertItem(t);case 2:return n=e.sent,e.next=5,this.itemManager.changeItems([n.uuid]);case 5:return e.abrupt("return",this.findItem(t.uuid));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return ne.apply(this,arguments)})},{key:"saveItem",value:(te=rf(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.itemManager.findItem(t)){e.next=3;break}throw Error("Attempting to save non-inserted item");case 3:if(n.dirty){e.next=6;break}return e.next=6,this.itemManager.changeItem(t);case 6:return e.next=8,this.syncService.sync();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return te.apply(this,arguments)})},{key:"changeAndSaveItem",value:(ee=rf(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,o=s.length>4?s[4]:void 0,Object(u.s)(t)){e.next=5;break}throw Error("Must use uuid to change item");case 5:return e.next=7,this.itemManager.changeItems([t],n,r?d.c.UserInteraction:void 0,a);case 7:return e.next=9,this.syncService.sync(o);case 9:return e.abrupt("return",this.findItem(t));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return ee.apply(this,arguments)})},{key:"changeAndSaveItems",value:(Z=rf(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,o=s.length>4?s[4]:void 0,e.next=5,this.itemManager.changeItems(t,n,r?d.c.UserInteraction:void 0,a);case 5:return e.next=7,this.syncService.sync(o);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return Z.apply(this,arguments)})},{key:"changeItem",value:(X=rf(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>2&&void 0!==a[2]&&a[2],Object(u.s)(t)){e.next=3;break}throw Error("Must use uuid to change item");case 3:return e.next=5,this.itemManager.changeItems([t],n,r?d.c.UserInteraction:void 0);case 5:return e.abrupt("return",this.findItem(t));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return X.apply(this,arguments)})},{key:"changeItems",value:(Y=rf(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]&&a[2],e.abrupt("return",this.itemManager.changeItems(t,n,r?d.c.UserInteraction:void 0));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return Y.apply(this,arguments)})},{key:"getItems",value:function(e){return this.itemManager.getItems(e)}},{key:"notesMatchingSmartTag",value:function(e){return this.itemManager.notesMatchingSmartTag(e)}},{key:"referencesForItem",value:function(e,t){var n=this.itemManager.referencesForItem(e.uuid);return t&&(n=n.filter((function(e){return(null==e?void 0:e.content_type)===t}))),n}},{key:"referencingForItem",value:function(e,t){var n=this.itemManager.itemsReferencingItem(e.uuid);return t&&(n=n.filter((function(e){return(null==e?void 0:e.content_type)===t}))),n}},{key:"findTagByTitle",value:function(e){return this.itemManager.findTagByTitle(e)}},{key:"findOrCreateTag",value:(Q=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.findOrCreateTagByTitle(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return Q.apply(this,arguments)})},{key:"getSmartTags",value:function(){return this.itemManager.getSmartTags()}},{key:"getNoteCount",value:function(){return this.itemManager.noteCount}},{key:"streamItems",value:function(e,t){var n=this,r=this.itemManager.addObserver(e,(function(e,n,r,a){var o=e.concat(n).concat(r);t(o,a)})),a=this.itemManager.getItems(e);return a.length>0&&t(a),this.streamRemovers.push(r),function(){r(),Object(u.B)(n.streamRemovers,r)}}},{key:"setHost",value:($=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.setHost(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return $.apply(this,arguments)})},{key:"getHost",value:(G=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.getHost());case 1:case"end":return e.stop()}}),e,this)}))),function(){return G.apply(this,arguments)})},{key:"getUser",value:function(){if(!this.launched)throw"Attempting to access user before application unlocked";return this.sessionManager.getUser()}},{key:"getProtocolEncryptionDisplayName",value:function(){return this.protocolService.getDefaultOperatorEncryptionDisplayName()}},{key:"getUserVersion",value:(J=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.getUserVersion());case 1:case"end":return e.stop()}}),e,this)}))),function(){return J.apply(this,arguments)})},{key:"protocolUpgradeAvailable",value:(q=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.upgradeAvailable());case 1:case"end":return e.stop()}}),e,this)}))),function(){return q.apply(this,arguments)})},{key:"isEncryptionAvailable",value:(z=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!Object(u.p)(this.getUser())||this.hasPasscode());case 1:case"end":return e.stop()}}),e,this)}))),function(){return z.apply(this,arguments)})},{key:"upgradeProtocolVersion",value:(H=rf(i.a.mark((function e(){var t,n,r,a,o,s,c,u,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.hasPasscode(),n=!this.noAccount(),r=[],t&&r.push(p.LocalPasscode),n&&r.push(p.AccountPassword),a=new g(r,y.ProtocolUpgrade),e.next=8,this.challengeService.promptForChallengeResponse(a);case 8:if(o=e.sent){e.next=11;break}return e.abrupt("return");case 11:if(t&&(c=o.getValueForType(p.LocalPasscode),s=c.value),!n){e.next=20;break}return u=o.getValueForType(p.AccountPassword),l=u.value,e.next=17,this.changePassword(l,l,s,{validatePasswordStrength:!1});case 17:if(!(null==(f=e.sent)?void 0:f.error)){e.next=20;break}return e.abrupt("return",[f.error]);case 20:if(!s){e.next=23;break}return e.next=23,this.changePasscode(s);case 23:case"end":return e.stop()}}),e,this)}))),function(){return H.apply(this,arguments)})},{key:"noAccount",value:function(){return!this.hasAccount()}},{key:"hasAccount",value:function(){return this.protocolService.hasAccount()}},{key:"importData",value:(B=rf(i.a.mark((function e(t,n){var r,a,o,s,c,u,l=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=l.length>2&&void 0!==l[2]&&l[2],e.next=3,this.protocolService.payloadsByDecryptingBackupFile(t,n);case 3:return a=e.sent,o=a.filter((function(e){return!e.errorDecrypting})).map((function(e){return e.content_type===O.a.Component&&e.safeContent.active?Object(P.b)(e,{content:Yl(Yl({},e.safeContent),{},{active:!1})}):e})),e.next=7,this.modelManager.importPayloads(o);case 7:if(s=e.sent,c=this.sync(),!r){e.next=12;break}return e.next=12,c;case 12:return u=this.getAll(s),e.abrupt("return",{affectedItems:u,errorCount:a.length-o.length});case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return B.apply(this,arguments)})},{key:"createBackupFile",value:(W=rf(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]&&a[2],e.abrupt("return",this.protocolService.createBackupFile(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return W.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.storageService.isEphemeralSession()}},{key:"lockSyncing",value:function(){this.syncService.lockSyncing()}},{key:"unlockSyncing",value:function(){this.syncService.unlockSyncing()}},{key:"sync",value:(U=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.sync(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return U.apply(this,arguments)})},{key:"isOutOfSync",value:(N=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.isOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"resolveOutOfSync",value:(V=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.resolveOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return V.apply(this,arguments)})},{key:"setValue",value:(L=rf(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.setValue(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return L.apply(this,arguments)})},{key:"getValue",value:(F=rf(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return F.apply(this,arguments)})},{key:"removeValue",value:(K=rf(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.removeValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return K.apply(this,arguments)})},{key:"clearDatabase",value:(T=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.clearAllPayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"rewriteItemsKeys",value:(M=rf(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.itemsKeys(),n=t.map((function(e){return e.payloadRepresentation()})),e.next=4,this.storageService.deletePayloads(n);case 4:return e.next=6,this.syncService.persistPayloads(n);case 6:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"prepareForDeinit",value:(A=rf(i.a.mark((function e(){var t,n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.length>0&&void 0!==r[0]?r[0]:0,n=Promise.all(this.services.map((function(e){return e.blockDeinit()}))),0!==t){e.next=7;break}return e.next=5,n;case 5:e.next=9;break;case 7:return e.next=9,Promise.race([n,Object(u.E)(t)]);case 9:case"end":return e.stop()}}),e,this)}))),function(){return A.apply(this,arguments)})},{key:"setChallengeCallbacks",value:function(e){var t=e.challenge,n=e.onValidValue,r=e.onInvalidValue,a=e.onComplete,o=e.onCancel;return this.challengeService.setChallengeCallbacks(t,n,r,a,o)}},{key:"submitValuesForChallenge",value:function(e,t){return this.challengeService.submitValuesForChallenge(e,t)}},{key:"cancelChallenge",value:function(e){this.challengeService.cancelChallenge(e)}},{key:"deinit",value:function(){clearInterval(this.autoSyncInterval);var e,t=Zl(this.serviceObservers);try{for(t.s();!(e=t.n()).done;)(0,e.value)()}catch(e){t.e(e)}finally{t.f()}var n,r=Zl(this.managedSubscribers);try{for(r.s();!(n=r.n()).done;)(0,n.value)()}catch(e){r.e(e)}finally{r.f()}var a,o=Zl(this.services);try{for(o.s();!(a=o.n()).done;)a.value.deinit()}catch(e){o.e(e)}finally{o.f()}this.deviceInterface.deinit(),this.deviceInterface=void 0,this.crypto=void 0,this.createdNewDatabase=!1,this.services.length=0,this.serviceObservers.length=0,this.managedSubscribers.length=0,this.streamRemovers.length=0,this.clearServices(),this.dealloced=!0,this.started=!1}},{key:"getWrappingKeyIfNecessary",value:(E=rf(i.a.mark((function e(t){var n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPasscode()){e.next=2;break}return e.abrupt("return",{});case 2:if(t){e.next=11;break}return n=new g([p.LocalPasscode],y.ResaveRootKey),e.next=6,this.challengeService.promptForChallengeResponse(n);case 6:if(r=e.sent){e.next=9;break}return e.abrupt("return",{canceled:!0});case 9:a=r.getValueForType(p.LocalPasscode),t=a.value;case 11:return e.next=13,this.protocolService.computeWrappingKey(t);case 13:return o=e.sent,e.abrupt("return",{wrappingKey:o});case 15:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"register",value:(R=rf(i.a.mark((function e(t,n){var r,a,o,s,u,l=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=l.length>2&&void 0!==l[2]&&l[2],a=!(l.length>3&&void 0!==l[3])||l[3],e.next=4,this.getWrappingKeyIfNecessary();case 4:if(o=e.sent,s=o.wrappingKey,!o.canceled){e.next=9;break}return e.abrupt("return");case 9:return this.lockSyncing(),e.next=12,this.sessionManager.register(t,n);case 12:if((u=e.sent).response.error){e.next=35;break}return e.next=16,this.protocolService.setNewRootKey(u.rootKey,u.keyParams,s);case 16:return this.syncService.resetSyncState(),e.next=19,this.storageService.setPersistencePolicy(r?Wt.Ephemeral:Wt.Default);case 19:if(!a){e.next=24;break}return e.next=22,this.syncService.markAllItemsAsNeedingSync(!0);case 22:e.next=27;break;case 24:return this.itemManager.removeAllItemsFromMemory(),e.next=27,this.clearDatabase();case 27:return e.next=29,this.notifyEvent(c.a.SignedIn);case 29:return this.unlockSyncing(),e.next=32,this.syncService.sync({mode:El.DownloadFirst,queueStrategy:Rl.ForceSpawnNew});case 32:this.protocolService.decryptErroredItems(),e.next=36;break;case 35:this.unlockSyncing();case 36:return e.abrupt("return",u.response);case 37:case"end":return e.stop()}}),e,this)}))),function(e,t){return R.apply(this,arguments)})},{key:"signIn",value:(I=rf(i.a.mark((function e(t,n){var r,a,o,s,u,l,f,p,y,h,d=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=d.length>2&&void 0!==d[2]&&d[2],a=d.length>3&&void 0!==d[3]&&d[3],o=d.length>4?d[4]:void 0,s=d.length>5?d[5]:void 0,u=!(d.length>6&&void 0!==d[6])||d[6],l=d.length>7&&void 0!==d[7]&&d[7],e.next=8,this.getWrappingKeyIfNecessary();case 8:if(f=e.sent,p=f.wrappingKey,!f.canceled){e.next=13;break}return e.abrupt("return");case 13:return this.lockSyncing(),e.next=16,this.sessionManager.signIn(t,n,r,o,s);case 16:if((y=e.sent).response.error){e.next=45;break}return e.next=20,this.protocolService.setNewRootKey(y.rootKey,y.keyParams,p);case 20:return this.syncService.resetSyncState(),e.next=23,this.storageService.setPersistencePolicy(a?Wt.Ephemeral:Wt.Default);case 23:if(!u){e.next=28;break}return e.next=26,this.syncService.markAllItemsAsNeedingSync(!0);case 26:e.next=31;break;case 28:return this.itemManager.removeAllItemsFromMemory(),e.next=31,this.clearDatabase();case 31:return e.next=33,this.notifyEvent(c.a.SignedIn);case 33:if(this.unlockSyncing(),h=this.syncService.sync({mode:El.DownloadFirst,checkIntegrity:!0,queueStrategy:Rl.ForceSpawnNew,awaitAll:l}),!l){e.next=42;break}return e.next=38,h;case 38:return e.next=40,this.protocolService.decryptErroredItems();case 40:e.next=43;break;case 42:this.protocolService.decryptErroredItems();case 43:e.next=46;break;case 45:this.unlockSyncing();case 46:return e.abrupt("return",y.response);case 47:case"end":return e.stop()}}),e,this)}))),function(e,t){return I.apply(this,arguments)})},{key:"changePassword",value:(_=rf(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f,p,y,h,d,v,m,b=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=b.length>3&&void 0!==b[3]?b[3]:{},void 0!==(o=a.validatePasswordStrength)&&!o){e.next=4;break}if(!(n.length<8)){e.next=4;break}return e.abrupt("return",{error:Error(jn(8))});case 4:return e.next=6,this.getWrappingKeyIfNecessary(r);case 6:if(s=e.sent,c=s.wrappingKey,!s.canceled){e.next=11;break}return e.abrupt("return",{});case 11:return e.next=13,this.protocolService.changePassword(this.getUser().email,t,n,c);case 13:if(u=e.sent,l=$l(u,2),f=l[0],p=l[1],!f){e.next=19;break}return e.abrupt("return",{error:f});case 19:return y=p.currentServerPassword,h=p.newRootKey,d=p.newKeyParams,v=p.rollback,e.next=22,this.syncService.sync({awaitAll:!0});case 22:if(this.protocolService.getDefaultItemsKey().updated_at.getTime()>0){e.next=29;break}return e.next=26,v();case 26:return e.next=28,this.syncService.sync({awaitAll:!0});case 28:return e.abrupt("return",{error:Error("Could not connect to server.")});case 29:return this.lockSyncing(),e.next=32,this.sessionManager.changePassword(y,h.serverPassword,d);case 32:if(!(m=e.sent).error){e.next=38;break}return e.next=36,v();case 36:return e.next=38,this.syncService.sync({awaitAll:!0});case 38:return this.unlockSyncing(),e.abrupt("return",m);case 40:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return _.apply(this,arguments)})},{key:"signOut",value:(C=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionManager.signOut();case 2:return e.next=4,this.protocolService.clearLocalKeyState();case 4:return e.next=6,this.storageService.clearAllData();case 6:return e.next=8,this.notifyEvent(c.a.SignedOut);case 8:return e.next=10,this.prepareForDeinit();case 10:this.deinit();case 11:case"end":return e.stop()}}),e,this)}))),function(){return C.apply(this,arguments)})},{key:"validateAccountPassword",value:(D=rf(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.validateAccountPassword(t);case 2:return n=e.sent,r=n.valid,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)})},{key:"isStarted",value:function(){return this.started}},{key:"isLaunched",value:function(){return this.launched}},{key:"hasBiometrics",value:(x=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeService.hasBiometricsEnabled());case 1:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"enableBiometrics",value:(S=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeService.enableBiometrics());case 1:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"disableBiometrics",value:(k=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeService.disableBiometrics());case 1:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"hasPasscode",value:function(){return this.protocolService.hasPasscode()}},{key:"isLocked",value:(w=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return",!0);case 2:return e.abrupt("return",this.challengeService.isPasscodeLocked());case 3:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"lock",value:(b=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.prepareForDeinit(500);case 3:return e.abrupt("return",this.deinit());case 4:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"setPasscode",value:(m=rf(i.a.mark((function e(t){var n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateUuid();case 2:return n=e.sent,e.next=5,this.protocolService.createRootKey(n,t);case 5:return r=e.sent,a=r.key,o=r.keyParams,e.next=10,this.protocolService.setNewRootKeyWrapper(a,o);case 10:return e.next=12,this.rewriteItemsKeys();case 12:return e.next=14,this.syncService.sync();case 14:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"removePasscode",value:(v=rf(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.removeRootKeyWrapper();case 2:return e.next=4,this.rewriteItemsKeys();case 4:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"changePasscode",value:(f=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.removePasscode();case 2:return e.abrupt("return",this.setPasscode(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"getStorageEncryptionPolicy",value:function(){return this.storageService.getStorageEncryptionPolicy()}},{key:"setStorageEncryptionPolicy",value:(l=rf(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setEncryptionPolicy(t);case 2:return e.abrupt("return",this.protocolService.repersistAllItems());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"generateUuid",value:function(){return h.GenerateUuid()}},{key:"changeDeviceInterface",value:(o=rf(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.deviceInterface=t,n=Zl(this.services);try{for(n.s();!(r=n.n()).done;)(a=r.value).deviceInterface&&(a.deviceInterface=t)}catch(e){n.e(e)}finally{n.f()}case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"constructServices",value:function(){this.createModelManager(),this.createItemManager(),this.createStorageManager(),this.createProtocolService();var e={payloadByEncryptingPayload:this.protocolService.payloadByEncryptingPayload.bind(this.protocolService),payloadByDecryptingPayload:this.protocolService.payloadByDecryptingPayload.bind(this.protocolService)};this.storageService.encryptionDelegate=e,this.createChallengeService(),this.createMigrationService(),this.createAlertManager(),this.createHttpManager(),this.createApiService(),this.createSessionManager(),this.createSyncManager(),this.createSingletonManager(),this.createComponentManager(),this.createPrivilegesService(),this.createHistoryManager(),this.createActionsManager()}},{key:"clearServices",value:function(){this.migrationService=void 0,this.alertService=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.sessionManager=void 0,this.syncService=void 0,this.challengeService=void 0,this.singletonManager=void 0,this.componentManager=void 0,this.privilegesService=void 0,this.actionsManager=void 0,this.historyManager=void 0,this.itemManager=void 0,this.services=[]}},{key:"createMigrationService",value:function(){this.migrationService=new mi({protocolService:this.protocolService,deviceInterface:this.deviceInterface,storageService:this.storageService,challengeService:this.challengeService,itemManager:this.itemManager,environment:this.environment,namespace:this.namespace}),this.services.push(this.migrationService)}},{key:"createAlertManager",value:function(){this.shouldSkipClass(mn)||(this.alertService=new(this.getClass(mn))(this.deviceInterface),this.services.push(this.alertService))}},{key:"createApiService",value:function(){this.apiService=new lr(this.httpService,this.storageService),this.services.push(this.apiService)}},{key:"createItemManager",value:function(){this.itemManager=new Xc(this.modelManager),this.services.push(this.itemManager)}},{key:"createComponentManager",value:function(){this.shouldSkipClass(Mr)||(this.componentManager=new Mr(this.itemManager,this.syncService,this.alertService,this.environment,this.platform,this.deviceInterface.timeout),this.services.push(this.componentManager))}},{key:"createHttpManager",value:function(){this.httpService=new $n,this.services.push(this.httpService)}},{key:"createModelManager",value:function(){this.modelManager=new Ga,this.services.push(this.modelManager)}},{key:"createSingletonManager",value:function(){this.singletonManager=new so(this.itemManager,this.syncService),this.services.push(this.singletonManager)}},{key:"createStorageManager",value:function(){this.storageService=new sn(this.deviceInterface,this.namespace),this.services.push(this.storageService)}},{key:"createProtocolService",value:function(){var e=this;this.protocolService=new Ts(this.itemManager,this.modelManager,this.deviceInterface,this.storageService,this.crypto),this.protocolService.onKeyStatusChange(rf(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.notifyEvent(c.a.KeyStatusChanged);case 2:case"end":return t.stop()}}),t)})))),this.services.push(this.protocolService)}},{key:"createSessionManager",value:function(){this.sessionManager=new Ln(this.storageService,this.apiService,this.alertService,this.protocolService),this.services.push(this.sessionManager)}},{key:"createSyncManager",value:function(){var e=this;this.syncService=new Ml(this.itemManager,this.sessionManager,this.protocolService,this.storageService,this.modelManager,this.apiService,this.deviceInterface.interval);var t=function(){var t=rf(i.a.mark((function t(n){var r;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r=Object(c.c)(n))){t.next=4;break}return t.next=4,e.notifyEvent(r);case 4:return t.next=6,e.protocolService.onSyncEvent(n);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),n=this.syncService.addEventObserver(t);this.serviceObservers.push(n),this.services.push(this.syncService)}},{key:"createChallengeService",value:function(){this.challengeService=new Gl(this.storageService,this.protocolService),this.services.push(this.challengeService)}},{key:"createPrivilegesService",value:function(){this.privilegesService=new _c(this.itemManager,this.syncService,this.singletonManager,this.protocolService,this.storageService,this.sessionManager),this.services.push(this.privilegesService)}},{key:"createHistoryManager",value:function(){this.historyManager=new yc(this.itemManager,this.storageService,[O.a.Note],this.deviceInterface.timeout),this.services.push(this.historyManager)}},{key:"createActionsManager",value:function(){this.actionsManager=new wo(this.itemManager,this.alertService,this.deviceInterface,this.httpService,this.modelManager,this.protocolService,this.syncService),this.services.push(this.actionsManager)}},{key:"shouldSkipClass",value:function(e){return this.skipClasses&&this.skipClasses.includes(e)}},{key:"getClass",value:function(e){var t=this.swapClasses&&this.swapClasses.find((function(t){return t.swap===e}));return t?t.with:e}}])&&af(t.prototype,n),r&&af(t,r),e}();function sf(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function cf(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var uf=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.namespace=t,this.timeout=n||setTimeout.bind(Object(u.m)()),this.interval=r||setInterval.bind(Object(u.m)())}var t,n,r,a,o;return t=e,(n=[{key:"deinit",value:function(){this.timeout=null,this.interval=null}},{key:"getJsonParsedStorageValue",value:(a=i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRawStorageValue(t);case 2:return n=e.sent,e.abrupt("return",n?JSON.parse(n):n);case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){sf(o,n,r,i,s,"next",e)}function s(e){sf(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e){return o.apply(this,arguments)})}])&&cf(t.prototype,n),r&&cf(t,r),e}();function lf(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ff(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var pf=function(){function e(t,n,r){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.item=n.findItem(t),r&&r(this.item),this.removeObserver=n.streamItems(this.item.content_type,function(){var e,n=(e=i.a.mark((function e(n){var o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(o=n.find((function(e){return e.uuid===t})))&&(a.item=o,r&&r(a.item));case 2:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){lf(o,r,a,i,s,"next",e)}function s(e){lf(o,r,a,i,s,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}())}var t,n,r;return t=e,(n=[{key:"deinit",value:function(){this.removeObserver(),this.removeObserver=void 0}}])&&ff(t.prototype,n),r&&ff(t,r),e}(),yf=n(78),hf=n(28)}])}));